<!DOCTYPE html>
<html lang="ru" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate">
    <meta name="translation" content="no">
    <title>IMPREZA Scanner</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="IMPREZA Scanner">
    <meta name="apple-mobile-web-app-title" content="IMPREZA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#08080B">
    <meta name="msapplication-TileColor" content="#08080B">
    <meta name="msapplication-navbutton-color" content="#F97316">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23F97316'/%3E%3Cstop offset='100%25' stop-color='%23EA580C'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='96' fill='%2308080B'/%3E%3Ctext x='256' y='340' text-anchor='middle' font-family='system-ui,-apple-system,sans-serif' font-size='280' font-weight='900' fill='url(%23g)'%3EI%3C/text%3E%3Crect x='96' y='400' width='320' height='8' rx='4' fill='%23F97316' opacity='.6'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23F97316'/%3E%3Cstop offset='100%25' stop-color='%23EA580C'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='96' fill='%2308080B'/%3E%3Ctext x='256' y='340' text-anchor='middle' font-family='system-ui,-apple-system,sans-serif' font-size='280' font-weight='900' fill='url(%23g)'%3EI%3C/text%3E%3Crect x='96' y='400' width='320' height='8' rx='4' fill='%23F97316' opacity='.6'/%3E%3C/svg%3E">
    
    <!-- PWA Manifest (inline) -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22IMPREZA%20Scanner%22%2C%22short_name%22%3A%22IMPREZA%22%2C%22description%22%3A%22QR%20Scanner%20for%20event%20tickets%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%2308080B%22%2C%22theme_color%22%3A%22%2308080B%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%2520viewBox%3D'0%25200%2520512%2520512'%253E%253Cdefs%253E%253ClinearGradient%2520id%3D'g'%2520x1%3D'0%2525'%2520y1%3D'0%2525'%2520x2%3D'100%2525'%2520y2%3D'100%2525'%253E%253Cstop%2520offset%3D'0%2525'%2520stop-color%3D'%2523F97316'%2F%253E%253Cstop%2520offset%3D'100%2525'%2520stop-color%3D'%2523EA580C'%2F%253E%253C%2FlinearGradient%253E%253C%2Fdefs%253E%253Crect%2520width%3D'512'%2520height%3D'512'%2520rx%3D'96'%2520fill%3D'%252308080B'%2F%253E%253Ctext%2520x%3D'256'%2520y%3D'340'%2520text-anchor%3D'middle'%2520font-family%3D'system-ui%2C-apple-system%2Csans-serif'%2520font-size%3D'280'%2520font-weight%3D'900'%2520fill%3D'url%28%2523g%29'%253EI%253C%2Ftext%253E%253Crect%2520x%3D'96'%2520y%3D'400'%2520width%3D'320'%2520height%3D'8'%2520rx%3D'4'%2520fill%3D'%2523F97316'%2520opacity%3D'.6'%2F%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
/* ═══════════════════════════════════════════════════
   IMPREZA WEB SCANNER — CSS
   Dark premium aesthetic matching desktop scanner
   ═══════════════════════════════════════════════════ */

:root {
    --bg-primary: #0a0a0b;
    --bg-card: #111113;
    --bg-elevated: #18181b;
    --bg-hover: #222226;
    --bg-input: #1a1a1d;
    --border: #27272a;
    --border-subtle: #1f1f23;
    --border-focus: #3f3f46;
    --text-primary: #fafafa;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --text-dim: #52525b;
    --accent-green: #22c55e;
    --accent-green-glow: rgba(34, 197, 94, 0.08);
    --accent-yellow: #eab308;
    --accent-yellow-glow: rgba(234, 179, 8, 0.08);
    --accent-red: #ef4444;
    --accent-red-glow: rgba(239, 68, 68, 0.08);
    --accent-blue: #3b82f6;
    --accent-orange: #f97316;
    --font-display: 'DM Sans', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --transition: 0.15s ease;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
    --shadow-md: 0 2px 8px rgba(0,0,0,0.25);
    --shadow-lg: 0 4px 16px rgba(0,0,0,0.3);
    --shadow-glow-green: none;
    --shadow-glow-red: none;
    
    /* Card shadows - subtle */
    --shadow-card: 0 1px 2px rgba(0,0,0,0.15);
    --shadow-card-hover: 0 2px 8px rgba(0,0,0,0.2);
    
    /* Status colors - solid, no gradients */
    --status-entered-bg: transparent;
    --status-entered-border: var(--accent-green);
    --status-duplicate-bg: transparent;
    --status-duplicate-border: var(--accent-yellow);
    --status-pending-bg: transparent;
    --status-pending-border: var(--text-muted);
    --status-invalid-bg: transparent;
    --status-invalid-border: var(--accent-red);
    
    /* Ghost buttons */
    --btn-plus-bg: transparent;
    --btn-plus-border: #27272a;
    --btn-minus-bg: transparent;
    --btn-minus-border: #27272a;
}

[data-theme="light"] {
    /* Cool slate palette — fresh & modern */
    --bg-primary: #F8FAFC;
    --bg-card: #FFFFFF;
    --bg-elevated: #F1F5F9;
    --bg-hover: #F1F5F9;
    --bg-input: #FFFFFF;
    --border: #E2E8F0;
    --border-subtle: #F1F5F9;
    --border-focus: #94A3B8;
    --text-primary: #0F172A;
    --text-secondary: #475569;
    --text-muted: #64748B;
    --text-dim: #94A3B8;
    
    /* Muted accents for light theme */
    --accent-green: #16a34a;
    --accent-green-glow: rgba(22, 163, 74, 0.06);
    --accent-yellow: #ca8a04;
    --accent-yellow-glow: rgba(202, 138, 4, 0.06);
    --accent-red: #dc2626;
    --accent-red-glow: rgba(220, 38, 38, 0.06);
    --accent-blue: #2563eb;
    --accent-orange: #ea580c;
    
    /* Shadows for light theme - very subtle */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.03);
    --shadow-md: 0 2px 8px rgba(0,0,0,0.05);
    --shadow-lg: 0 4px 16px rgba(0,0,0,0.06);
    --shadow-card: 0 1px 2px rgba(0,0,0,0.03);
    --shadow-card-hover: 0 2px 8px rgba(0,0,0,0.05);
    --shadow-glow-green: none;
    --shadow-glow-red: none;
    
    /* Status - transparent */
    --status-entered-bg: transparent;
    --status-entered-border: var(--accent-green);
    --status-duplicate-bg: transparent;
    --status-duplicate-border: var(--accent-yellow);
    --status-pending-bg: transparent;
    --status-pending-border: var(--text-muted);
    --status-invalid-bg: transparent;
    --status-invalid-border: var(--accent-red);
    
    /* Ghost buttons */
    --btn-plus-bg: transparent;
    --btn-plus-border: #E2E8F0;
    --btn-minus-bg: transparent;
    --btn-minus-border: #E2E8F0;
}

/* ══════════════════════════════════════════════
   LIGHT THEME OVERRIDES
   ══════════════════════════════════════════════ */
[data-theme="light"] .bottom-bar {
    background: var(--bg-primary);
    border-top-color: var(--border-subtle);
}

[data-theme="light"] .top-bar {
    background: var(--bg-primary);
}

[data-theme="light"] .burger-panel {
    background: var(--bg-card);
}

[data-theme="light"] .history-item {
    border-color: var(--border-subtle);
}

[data-theme="light"] .history-item:hover {
    border-color: var(--border);
    background: var(--bg-hover);
}

[data-theme="light"] .modal-sheet {
    box-shadow: 0 -2px 16px rgba(0,0,0,0.06);
}

[data-theme="light"] .filter-tab.active {
    background: var(--accent-orange);
    color: white;
}

[data-theme="light"] .mass-action-bar {
    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.08);
}

[data-theme="light"] .metrics-bar {
    border-color: var(--border-subtle);
}

[data-theme="light"] .scan-toast {
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

/* Status cards in light theme */
[data-theme="light"] .status-card.valid {
    background: var(--status-entered-bg);
    border-color: var(--accent-green);
}
[data-theme="light"] .status-card.used {
    background: var(--status-duplicate-bg);
    border-color: var(--accent-yellow);
}
[data-theme="light"] .status-card.invalid,
[data-theme="light"] .status-card.denied {
    background: var(--status-invalid-bg);
    border-color: var(--accent-red);
}

/* Camera container in light theme */
[data-theme="light"] .camera-container {
    background: #E2E8F0;
}

/* Burger item styling for light theme */
[data-theme="light"] .burger-item {
    color: var(--text-primary);
}
[data-theme="light"] .burger-item:hover {
    background: var(--bg-elevated);
}
[data-theme="light"] .burger-item.active {
    background: var(--accent-sky-glow);
    color: var(--accent-blue);
}

/* Burger overlay in light theme */
[data-theme="light"] .burger-overlay {
    background: rgba(15, 23, 42, 0.4);
}

/* Login card in light theme */
[data-theme="light"] #loginScreen {
    background: linear-gradient(180deg, #F0F9FF 0%, #F8FAFC 100%);
}
[data-theme="light"] .login-brand {
    color: #0F172A;
}
[data-theme="light"] .club-btn {
    background: #FFFFFF;
    border-color: #E2E8F0;
    color: #334155;
}
[data-theme="light"] .club-btn:hover {
    border-color: var(--accent-sky);
    background: #F0F9FF;
}

/* Input fields in light theme */
[data-theme="light"] input,
[data-theme="light"] select {
    background: #FFFFFF;
    border-color: #E2E8F0;
    color: #0F172A;
}
[data-theme="light"] input:focus,
[data-theme="light"] select:focus {
    border-color: var(--accent-sky);
    box-shadow: 0 0 0 3px var(--accent-sky-glow);
}

/* Orange button in light theme */
[data-theme="light"] .btn-orange {
    background: #FFF7ED;
    border-color: var(--accent-orange);
    color: var(--accent-orange);
}

/* Metrics bar in light theme */
[data-theme="light"] .metric-item {
    background: #FFFFFF;
    border-color: #E2E8F0;
}

/* Filter tabs */
[data-theme="light"] .filter-tab {
    background: #FFFFFF;
    color: #64748B;
}
[data-theme="light"] .filter-tab.active {
    background: var(--accent-orange);
    color: #FFFFFF;
}

/* Action buttons - ghost style */
[data-theme="light"] .hi-btn {
    background: transparent;
    border-color: var(--border);
    color: var(--text-muted);
}
[data-theme="light"] .hi-btn-plus:hover {
    background: var(--bg-hover);
    border-color: var(--accent-green);
    color: var(--accent-green);
}
[data-theme="light"] .hi-btn-minus:hover {
    background: var(--bg-hover);
    border-color: var(--accent-red);
    color: var(--accent-red);
}

/* Search input */
[data-theme="light"] .search-bar input {
    background: #FFFFFF;
    border-color: #E2E8F0;
}

/* Event filter dropdown */
[data-theme="light"] .event-select {
    background: #FFFFFF !important;
    border-color: #CBD5E1 !important;
    color: #334155 !important;
}

/* Camera buttons - circular ghost style */
[data-theme="light"] .cam-btn {
    background: rgba(0, 0, 0, 0.05);
}
[data-theme="light"] .cam-btn:hover {
    background: rgba(0, 0, 0, 0.08);
}
[data-theme="light"] .cam-btn.cam-ready {
    background: rgba(249, 115, 22, 0.1);
}
[data-theme="light"] .cam-btn.cam-ready:hover {
    background: rgba(249, 115, 22, 0.18);
}
[data-theme="light"] .cam-btn.cam-active {
    background: rgba(220, 38, 38, 0.12);
}
[data-theme="light"] .cam-btn.cam-active:hover {
    background: rgba(220, 38, 38, 0.2);
}
[data-theme="light"] .cam-btn.cam-switch {
    background: rgba(0, 0, 0, 0.05);
}
[data-theme="light"] .cam-btn.cam-switch:hover {
    background: rgba(0, 0, 0, 0.1);
}

/* Password modal */
[data-theme="light"] .password-card {
    background: #FFFFFF;
    box-shadow: 0 8px 32px rgba(15,23,42,0.15);
}

/* City switcher */
[data-theme="light"] .city-item {
    background: #FFFFFF;
    border-color: #E2E8F0;
}
[data-theme="light"] .city-item:hover {
    background: #F0F9FF;
    border-color: var(--accent-sky);
}

/* Scan flash */
[data-theme="light"] .scan-flash {
    background: rgba(56, 189, 248, 0.15);
}

/* History items extra */
[data-theme="light"] .history-item {
    background: #FFFFFF;
    border-color: #E2E8F0;
}
[data-theme="light"] .hi-name {
    color: #0F172A;
}
[data-theme="light"] .hi-phone {
    color: #64748B;
}

/* Modal */
[data-theme="light"] .modal-overlay {
    background: rgba(15, 23, 42, 0.5);
}
[data-theme="light"] .modal-sheet {
    background: #FFFFFF;
}
[data-theme="light"] .modal-title {
    color: #0F172A;
}

/* Tab content */
[data-theme="light"] .tab-content {
    background: var(--bg-primary);
}

/* Status text colors */
[data-theme="light"] .status-text.green { color: var(--accent-green); }
[data-theme="light"] .status-text.yellow { color: var(--accent-yellow); }
[data-theme="light"] .status-text.red { color: var(--accent-red); }

/* Scan result text */
[data-theme="light"] .sc-name {
    color: #0F172A;
}

/* Admin filters in light theme */
[data-theme="light"] .admin-filters {
    background: #F8FAFC;
    border-color: #E2E8F0;
}
[data-theme="light"] .admin-filter-label {
    color: #64748B;
    background: #F8FAFC;
}
[data-theme="light"] .admin-multi-select {
    background: #FFFFFF;
    border-color: #E2E8F0;
}
[data-theme="light"] .admin-option {
    color: #334155;
}
[data-theme="light"] .admin-option:hover {
    background: #F1F5F9;
}
[data-theme="light"] .admin-option.selected {
    background: rgba(249, 115, 22, 0.08);
    color: #0284C7;
}
[data-theme="light"] .admin-apply-btn {
    background: var(--accent-sky);
    color: #FFFFFF;
}

/* Global button press feedback */
button:active:not(:disabled) {
    transform: scale(0.97);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: var(--font-display);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
    opacity: 0;
    transition: opacity 0.2s ease;
}
body.ready { opacity: 1; }

/* ── SCREENS ── */
.screen { display: none; min-height: 100dvh; }
.screen.active { display: flex; flex-direction: column; }

/* ═══════════════════════════════════════════
   LOGIN SCREEN
   ═══════════════════════════════════════════ */
#loginScreen {
    justify-content: center;
    align-items: center;
    padding: 24px;
    background: radial-gradient(ellipse at 50% 0%, var(--bg-card) 0%, var(--bg-primary) 70%);
    position: relative;
}

.login-card {
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.login-brand {
    font-family: var(--font-display);
    font-size: clamp(48px, 12vw, 72px);
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--text-primary);
    margin-bottom: 6px;
    line-height: 1;
}

.login-subtitle {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 0.3em;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 48px;
}

.login-field {
    margin-bottom: 16px;
    text-align: left;
}

.login-field label {
    display: block;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-bottom: 8px;
}

.login-field input {
    width: 100%;
    height: 48px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0 14px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 15px;
    outline: none;
    transition: border-color 0.15s ease;
}

.login-field input:focus { border-color: var(--text-primary); }
.login-field input::placeholder { color: var(--text-muted); }

.login-btn {
    width: 100%;
    height: 48px;
    background: var(--text-primary);
    color: var(--bg-primary);
    border: none;
    border-radius: 6px;
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.03em;
    cursor: pointer;
    margin-top: 20px;
    transition: opacity 0.12s ease;
}

.login-btn:hover { opacity: 0.9; }
.login-btn:active { transform: scale(0.98); }
.login-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.login-error {
    color: var(--accent-red);
    font-size: 13px;
    font-weight: 500;
    margin-top: 16px;
    min-height: 20px;
}

.login-footer {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 48px;
    letter-spacing: 0.05em;
}

/* ═══════════════════════════════════════════
   MAIN SCANNER SCREEN
   ═══════════════════════════════════════════ */
#mainScreen { height: 100dvh; }

/* ── TOP BAR ── */
.top-bar {
    display: flex;
    flex-direction: column;
    padding: 8px 12px;
    gap: 8px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg-primary);
    position: sticky;
    top: 0;
    z-index: 100;
}

/* Строка 1: Лого + Город + Online + Меню */
.top-bar-row-1 {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Строка 2: Табы + Фильтр событий */
.top-bar-row-2 {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.top-bar-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.top-left { display: flex; align-items: center; gap: 6px; min-width: 0; }

.top-logo {
    font-family: var(--font-display);
    font-size: 17px;
    font-weight: 800;
    letter-spacing: 0.12em;
    color: var(--text-primary);
    flex-shrink: 0;
}

/* Город в хедере — кликабельная строка */
.header-city {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: var(--bg-elevated);
    border-radius: 6px;
    transition: all 0.15s;
    flex: 1;
    min-width: 0;
}
.header-city:hover { background: var(--bg-input); }
.header-city:active { color: var(--text-primary); }
.header-city .city-pin { font-size: 10px; flex-shrink: 0; }
.header-city .city-name { letter-spacing: 0.3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-city .city-arrow { font-size: 10px; margin-left: auto; flex-shrink: 0; opacity: 0.6; }

/* Скрытый старый город */
.top-city {
    display: none;
}

.top-right { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }

.connection-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--accent-green);
    transition: background 0.3s;
    flex-shrink: 0;
}
.connection-dot.offline { background: var(--accent-red); }

.top-time {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
    display: none; /* hidden on mobile to save space */
}

.top-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 32px; height: 32px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
}
.top-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }

/* ── EVENT FILTER (top bar) ── */
.event-filter-select {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 12px;
    padding: 6px 10px;
    outline: none;
    max-width: 140px;
    cursor: pointer;
}
.event-filter-select option { background: var(--bg-elevated); color: var(--text-primary); }

/* ── BURGER BUTTON ── */
.burger-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 20px;
    padding: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    transition: background 0.15s;
}
.burger-btn:active { background: var(--bg-elevated); }

/* Online indicator в хедере */
.online-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-family: var(--font-mono);
    color: var(--accent-green);
    font-weight: 500;
}
.online-indicator .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent-green);
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
}
.online-indicator.offline { color: var(--accent-red); }
.online-indicator.offline .dot { background: var(--accent-red); box-shadow: none; }

/* ── BURGER OVERLAY ── */
.burger-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, visibility 0.25s;
}
.burger-overlay.open { opacity: 1; visibility: visible; }

.burger-panel {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--bg-card);
    border-left: 1px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    padding: 20px 16px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0));
    overflow-y: auto;
}
.burger-overlay.open .burger-panel { transform: translateX(0); }

.burger-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.burger-title {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--text-muted);
}

.burger-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
}
.burger-close:hover { color: var(--text-secondary); }

.burger-section {
    margin-bottom: 16px;
}

.burger-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 8px;
    display: block;
}

.burger-section select {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 13px;
}

.burger-divider {
    height: 1px;
    background: var(--border);
    margin: 12px 0;
}

.burger-item {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px;
    border: none;
    background: none;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    text-align: left;
    transition: background 0.12s ease;
}
.burger-item:active { background: var(--bg-elevated); }
.burger-item.active { background: var(--bg-elevated); color: var(--accent-orange); }
.burger-item.danger { color: var(--accent-red); }

.burger-separator {
    height: 1px;
    background: var(--border);
    margin: 8px 0;
}

.burger-item-logout { color: var(--accent-red); }
.burger-item-logout:active { background: rgba(255, 59, 48, 0.1); }

.burger-item-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 10px;
    border: none;
    background: none;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 500;
    border-radius: 6px;
    cursor: default;
}

.burger-item-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.burger-items {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.burger-item-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.burger-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.burger-toggle {
    width: 36px;
    height: 20px;
    background: var(--bg-input);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: background 0.15s ease;
}
.burger-toggle.active { background: var(--accent-green); }
.burger-toggle::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.15s ease;
}
.burger-toggle.active::after { transform: translateX(16px); }

/* ── ADMIN FILTERS (глобальный админ) ── */
.admin-filters {
    display: none;
    padding: 12px 0;
    border-top: 1px solid var(--border);
    margin-top: 8px;
}
.admin-filters.visible { display: block; }

.admin-filter-group { 
    margin-bottom: 12px;
    position: relative;
}

.admin-filter-label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 6px;
    display: block;
    position: sticky;
    top: 0;
    background: var(--bg-card);
    padding: 4px 0;
    z-index: 1;
}

.admin-multi-select {
    width: 100%;
    max-height: 180px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg-input);
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
}

/* Custom scrollbar for filters */
.admin-multi-select::-webkit-scrollbar {
    width: 4px;
}
.admin-multi-select::-webkit-scrollbar-track {
    background: transparent;
}
.admin-multi-select::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 2px;
}
.admin-multi-select::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
}

.admin-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0;
    cursor: pointer;
    transition: background 0.1s;
    font-size: 13px;
    min-height: 44px; /* Touch target */
    padding: 0 12px;
}
.admin-option:hover { background: var(--bg-elevated); }
.admin-option input { 
    margin: 0; 
    width: 18px; 
    height: 18px;
    accent-color: var(--accent-orange);
    flex-shrink: 0;
    pointer-events: none;
}
.admin-option.selected { background: rgba(249, 115, 22, 0.08); }

.admin-apply-btn {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border: none;
    border-radius: 6px;
    background: var(--accent-blue);
    color: white;
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
}
.admin-apply-btn:hover { opacity: 0.9; }

/* ── TAB SWITCHER IN TOP BAR ── */
.top-bar-tabs {
    display: flex;
    gap: 0;
    flex-shrink: 0;
}

.top-tab-btn {
    padding: 8px 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-muted);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    position: relative;
}

.top-tab-btn::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    width: 0;
    height: 2px;
    background: var(--accent-orange);
    transform: translateX(-50%);
    transition: width 0.2s ease;
}

.top-tab-btn.active {
    color: var(--accent-orange);
}

.top-tab-btn.active::after {
    width: 100%;
}

.top-tab-btn:hover:not(.active) {
    color: var(--text-secondary);
}

.top-tab-btn:hover:not(.active)::after {
    width: 60%;
    background: var(--text-muted);
}

.top-tab-btn:active {
    transform: scale(0.97);
}

/* ── TAB BAR (скрыт — табы в top bar) ── */
.tab-bar {
    display: none;
}

.tab-btn {
    flex: 1;
    height: 38px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.05em;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-btn.active {
    color: var(--text-primary);
    border-bottom-color: var(--text-primary);
}

/* ── TAB CONTENT ── */
.tab-content { 
    display: none; 
    flex: 1; 
    overflow-y: auto; 
    min-height: 0;
    opacity: 0;
}
.tab-content.active { 
    display: flex; 
    flex-direction: column;
    animation: tabFadeIn 0.25s ease-out forwards;
}

@keyframes tabFadeIn {
    from { 
        opacity: 0; 
        transform: translateY(8px);
    }
    to { 
        opacity: 1; 
        transform: translateY(0);
    }
}

/* ═══════════════════════════════════════════
   SCANNER TAB (mobile-first)
   ═══════════════════════════════════════════ */
.scanner-tab { padding: 8px; gap: 8px; }

/* Status Card — compact */
.status-card {
    border-radius: 12px;
    padding: 14px 16px;
    text-align: center;
    border: 1px solid var(--border);
    background: var(--bg-card);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
}

.status-card.valid { 
    border-color: var(--accent-green); 
    background: linear-gradient(135deg, #050F0A 0%, #071510 100%);
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2), 0 2px 8px rgba(0,0,0,0.2);
}
.status-card.used { 
    border-color: var(--accent-yellow); 
    background: linear-gradient(135deg, #0F0D05 0%, #141008 100%);
    box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2), 0 2px 8px rgba(0,0,0,0.2);
}
.status-card.invalid { 
    border-color: var(--accent-red); 
    background: linear-gradient(135deg, #0F0505 0%, #140808 100%);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2), 0 2px 8px rgba(0,0,0,0.2);
}
.status-card.denied { 
    border-color: var(--accent-red); 
    background: linear-gradient(135deg, #0F0505 0%, #140808 100%);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2), 0 2px 8px rgba(0,0,0,0.2);
}

.status-icon {
    width: 36px;
    height: 36px;
    font-size: 28px;
    line-height: 1;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

.status-icon svg {
    width: 100%;
    height: 100%;
}

.status-icon--waiting {
    color: var(--accent-blue);
    animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.05); }
}

.status-card.valid .status-icon {
    color: var(--accent-green);
    animation: none;
}
.status-card.used .status-icon {
    color: var(--accent-yellow);
    animation: none;
}
.status-card.invalid .status-icon,
.status-card.denied .status-icon {
    color: var(--accent-red);
    animation: none;
}

.status-info { flex: 1; min-width: 0; text-align: left; }

.status-text {
    font-size: clamp(14px, 4vw, 20px);
    font-weight: 800;
    letter-spacing: 0.03em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.status-subtitle {
    font-size: 11px;
    font-weight: 400;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ── SEARCH ADMIT BUTTON (БАГ 3) ── */
.search-admit-btn {
    width: 100%;
    padding: 16px;
    margin: 8px 0;
    background: var(--accent-green);
    color: white;
    border: none;
    border-radius: 14px;
    font-family: var(--font-display);
    font-size: 17px;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: transform 0.1s, box-shadow 0.2s;
}
.search-admit-btn:active { transform: scale(0.97); }
.search-admit-btn:hover { box-shadow: 0 0 24px rgba(16, 185, 129, 0.3); }
.search-admit-btn.admitted {
    background: var(--bg-elevated);
    color: var(--text-muted);
    cursor: default;
}
.search-admit-btn.admitted:hover { box-shadow: none; }
.search-admit-btn.admitted:active { transform: none; }

/* Camera Container — fixed height, stable layout */
.camera-section {
    flex-shrink: 0;
}

.camera-container {
    position: relative;
    width: 100%;
    height: 52vw;
    max-height: 380px;
    min-height: 200px;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid var(--border);
    background: #000;
}

/* Video element fills container */
#scannerVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* Scan region overlay — purely visual */
.scan-region-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 2;
}
.scan-region-box {
    width: 65%;
    aspect-ratio: 1;
    max-width: 260px;
    border: 2px solid rgba(255,255,255,0.25);
    border-radius: 16px;
    position: relative;
    box-shadow: 0 0 0 2000px rgba(0,0,0,0.3);
}
.scan-region-box::before, .scan-region-box::after {
    content: '';
    position: absolute;
    width: 28px; height: 28px;
    border-color: var(--accent-orange);
    border-style: solid;
}
.scan-region-box::before { top: -2px; left: -2px; border-width: 3px 0 0 3px; border-radius: 8px 0 0 0; }
.scan-region-box::after { top: -2px; right: -2px; border-width: 3px 3px 0 0; border-radius: 0 8px 0 0; }
.scan-corner-bl, .scan-corner-br {
    position: absolute;
    width: 28px; height: 28px;
    border-color: var(--accent-orange);
    border-style: solid;
}
.scan-corner-bl { bottom: -2px; left: -2px; border-width: 0 0 3px 3px; border-radius: 0 0 0 8px; }
.scan-corner-br { bottom: -2px; right: -2px; border-width: 0 3px 3px 0; border-radius: 0 0 8px 0; }

/* Scanning animation line */
.scan-line {
    position: absolute;
    left: 10%; right: 10%;
    height: 2px;
    background: var(--accent-orange);
    opacity: 0.8;
    animation: scanLineMove 2s ease-in-out infinite;
}
@keyframes scanLineMove {
    0%, 100% { top: 15%; }
    50% { top: 85%; }
}

/* ── ANIMATIONS ── */
@keyframes flashGreen {
    0% { background: transparent; }
    15% { background: rgba(16, 185, 129, 0.2); }
    100% { background: transparent; }
}

@keyframes flashRed {
    0% { background: transparent; }
    15% { background: rgba(239, 68, 68, 0.2); }
    100% { background: transparent; }
}

@keyframes toastIn {
    from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

@keyframes toastOut {
    from { transform: translateX(-50%) translateY(0); opacity: 1; }
    to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
}

@keyframes sheetUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

@keyframes sheetDown {
    from { transform: translateY(0); }
    to { transform: translateY(100%); }
}

@keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* ── SCAN FLASH OVERLAY ── */
.scan-flash {
    position: fixed;
    inset: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.1s;
}
.scan-flash.flash-green { background: rgba(16, 185, 129, 0.4); opacity: 1; }
.scan-flash.flash-yellow { background: rgba(245, 158, 11, 0.4); opacity: 1; }
.scan-flash.flash-red { background: rgba(239, 68, 68, 0.4); opacity: 1; }

.camera-toggle {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 12px;
    flex-shrink: 0;
}

/* Circular icon-only camera buttons - iOS/Telegram style */
.cam-btn {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background: rgba(255, 255, 255, 0.08);
}
.cam-btn:hover {
    background: rgba(255, 255, 255, 0.12);
}
.cam-btn:active {
    transform: scale(0.93);
}
.cam-btn svg {
    width: 24px;
    height: 24px;
    stroke-width: 2;
    transition: all 0.15s ease;
}

/* Camera Start/Stop button - Play/Pause icon states */
.cam-btn.cam-ready {
    background: rgba(249, 115, 22, 0.12);
}
.cam-btn.cam-ready svg {
    stroke: var(--accent-orange);
    fill: var(--accent-orange);
    fill-opacity: 0.15;
}
.cam-btn.cam-ready:hover {
    background: rgba(249, 115, 22, 0.2);
}

.cam-btn.cam-active {
    background: rgba(220, 38, 38, 0.15);
}
.cam-btn.cam-active svg {
    stroke: #dc2626;
    fill: #dc2626;
    fill-opacity: 0.2;
}
.cam-btn.cam-active:hover {
    background: rgba(220, 38, 38, 0.25);
}

/* Camera switch button */
.cam-btn.cam-switch {
    background: rgba(255, 255, 255, 0.08);
}
.cam-btn.cam-switch svg {
    stroke: var(--text-secondary);
    fill: none;
    transition: transform 0.3s ease;
}
.cam-btn.cam-switch:hover {
    background: rgba(255, 255, 255, 0.15);
}
.cam-btn.cam-switch:hover svg {
    stroke: var(--text-primary);
}
.cam-btn.cam-switch.rotating svg {
    transform: rotate(180deg);
}

/* Guest Info Card — collapsed by default on mobile */
.guest-info {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0;
    flex-shrink: 0;
    overflow: hidden;
}

.guest-info-header {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
    padding: 10px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.guest-info-header::after { content: '▼'; font-size: 8px; }
.guest-info.open .guest-info-header::after { content: '▲'; }

.guest-info-body {
    display: none;
    padding: 0 12px 10px;
}
.guest-info.open .guest-info-body { display: block; }

.guest-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
}

.guest-field {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 8px;
    min-height: 0;
}

.guest-field.wide { grid-column: 1 / -1; }

.guest-field-label {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.12em;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}

.guest-field-value {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-primary);
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ═══════════════════════════════════════════
   HISTORY TAB
   ═══════════════════════════════════════════ */
.history-tab { padding: 8px; gap: 6px; }

.history-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.search-wrapper {
    flex: 1;
    min-width: 0;
    position: relative;
}

.search-wrapper::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    background: var(--text-muted);
    -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E") center/contain no-repeat;
    mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E") center/contain no-repeat;
    pointer-events: none;
}

.history-search {
    width: 100%;
    height: 36px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0 12px 0 32px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 13px;
    outline: none;
    transition: all 0.15s ease;
}
.history-search:focus { 
    border-color: var(--accent-orange);
    box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.15);
}
.history-search::placeholder { color: var(--text-muted); }

.search-clear {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px; height: 18px;
    border-radius: 4px;
    border: none;
    background: var(--bg-elevated);
    color: var(--text-muted);
    font-size: 10px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.12s ease;
}
.search-clear:hover { background: var(--text-muted); color: var(--bg-primary); }
.search-clear.visible { display: flex; }

.refresh-btn {
    width: 36px; height: 36px;
    border-radius: 6px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
}
.refresh-btn:hover { 
    border-color: var(--accent-orange);
    color: var(--accent-orange);
}
.refresh-btn:active { transform: scale(0.95); }
.refresh-btn.spinning svg { animation: spin 0.6s linear infinite; }

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.history-filter-tabs {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 2px;
}

.filter-tab {
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s ease;
}
.filter-tab:hover { 
    color: var(--text-primary);
    background: var(--bg-hover);
}
.filter-tab:active {
    transform: scale(0.97);
}
.filter-tab.active { 
    background: var(--accent-orange); 
    color: white; 
}
.filter-tab.active:hover {
    background: var(--accent-orange);
    filter: brightness(1.1);
}

.history-stats {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
    padding: 4px 0;
    flex-shrink: 0;
}

.history-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 4px;
}

.history-item {
    display: grid;
    grid-template-columns: 28px 1fr auto auto;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    margin-bottom: 3px;
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.15s ease;
    animation: cardSlideIn 0.25s ease-out both;
    position: relative;
}

/* Stagger animation для 20 карточек */
.history-item:nth-child(1) { animation-delay: 0ms; }
.history-item:nth-child(2) { animation-delay: 25ms; }
.history-item:nth-child(3) { animation-delay: 50ms; }
.history-item:nth-child(4) { animation-delay: 75ms; }
.history-item:nth-child(5) { animation-delay: 100ms; }
.history-item:nth-child(6) { animation-delay: 125ms; }
.history-item:nth-child(7) { animation-delay: 150ms; }
.history-item:nth-child(8) { animation-delay: 175ms; }
.history-item:nth-child(9) { animation-delay: 200ms; }
.history-item:nth-child(10) { animation-delay: 225ms; }
.history-item:nth-child(11) { animation-delay: 250ms; }
.history-item:nth-child(12) { animation-delay: 275ms; }
.history-item:nth-child(13) { animation-delay: 300ms; }
.history-item:nth-child(14) { animation-delay: 325ms; }
.history-item:nth-child(15) { animation-delay: 350ms; }
.history-item:nth-child(16) { animation-delay: 375ms; }
.history-item:nth-child(17) { animation-delay: 400ms; }
.history-item:nth-child(18) { animation-delay: 425ms; }
.history-item:nth-child(19) { animation-delay: 450ms; }
.history-item:nth-child(20) { animation-delay: 475ms; }

.history-item:hover { 
    border-color: var(--border);
    background: var(--bg-hover);
}
.history-item:active { 
    transform: scale(0.995);
}
.history-item.selected { 
    background: rgba(249, 115, 22, 0.08);
    border-color: var(--accent-orange);
    box-shadow: 0 0 0 1px var(--accent-orange);
}

@keyframes cardSlideIn {
    from { 
        opacity: 0; 
        transform: translateY(12px) scale(0.98);
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1);
    }
}

.hi-status {
    display: none; /* Hidden - status shown via checkbox color */
}

.hi-info { min-width: 0; }

.hi-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Badges for promo and hidden status */
.hi-badge {
    font-size: 10px;
    flex-shrink: 0;
    opacity: 0.8;
}

.hi-badge-promo { color: var(--accent-green); }
.hi-badge-hidden { color: var(--accent-yellow); }

/* Hidden ticket card styling */
.history-item.hidden-ticket {
    opacity: 0.7;
    border-left: 3px solid var(--accent-yellow);
    background: rgba(245, 158, 11, 0.05);
}

.hi-meta {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
    line-height: 1.2;
}

.hi-event {
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-size: 10px;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: inline;
}

.hi-right {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.hi-scans {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    background: var(--bg-elevated);
    display: inline-block;
    color: var(--text-secondary);
}
/* Цветовая логика для сканов */
.hi-scans.scans-full { color: var(--accent-green); background: rgba(16, 185, 129, 0.1); }
.hi-scans.scans-partial { color: var(--accent-yellow); background: rgba(245, 158, 11, 0.1); }
.hi-scans.scans-none { color: var(--text-muted); }

.hi-price {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-muted);
    background: var(--bg-elevated);
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
}
.hi-price:not(:empty) {
    margin-left: 2px;
}

/* ── BOTTOM STATS BAR ── */
.bottom-bar {
    display: flex;
    align-items: center;
    justify-content: space-around;
    height: 56px;
    border-top: 1px solid var(--border-subtle);
    flex-shrink: 0;
    background: var(--bg-primary);
    padding: 0 8px;
    padding-bottom: env(safe-area-inset-bottom, 0);
}

.stat-item { 
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.stat-value {
    font-family: var(--font-mono);
    font-size: clamp(18px, 4vw, 22px);
    font-weight: 600;
    line-height: 1.1;
}
.stat-value.green { color: var(--accent-green); }
.stat-value.yellow { color: var(--accent-yellow); }
.stat-value.gray { color: var(--text-secondary); }
.stat-value.red { color: var(--accent-red); }

.stat-label {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 3px;
}

.stat-icon {
    flex-shrink: 0;
}

/* ── METRICS BAR (БАГ 4) ── */
.metrics-bar {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 8px 12px;
    background: transparent;
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
    flex-shrink: 0;
}

.metrics-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    font-family: var(--font-mono);
    font-size: 11px;
}

.metrics-bar .metric-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.metrics-bar .metric-value {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-primary);
}

.metrics-bar .metric-label {
    color: var(--text-muted);
    font-size: 10px;
}

.metrics-bar .metric-green .metric-value {
    color: var(--accent-green);
}

.metrics-bar .metric-dot {
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background: var(--border);
}

.metrics-progress {
    width: 100%;
    height: 2px;
    background: var(--bg-elevated);
    border-radius: 1px;
    overflow: hidden;
}

.metrics-progress-fill {
    height: 100%;
    background: var(--accent-green);
    border-radius: 1px;
    transition: width 0.4s ease;
}

/* ── TICKET DETAIL MODAL ── */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 1000;
    justify-content: center;
    align-items: flex-end;
    padding: 16px;
    opacity: 0;
    transition: opacity 0.25s ease;
}
.modal-overlay.active { 
    display: flex;
    opacity: 1;
}

.modal-sheet {
    width: 100%;
    max-width: 480px;
    max-height: 85dvh;
    background: var(--bg-card);
    border-radius: 12px 12px 0 0;
    overflow-y: auto;
    padding: 8px 16px 24px;
    animation: modalSlideUp 0.25s ease;
}

.modal-sheet.closing {
    animation: modalSlideDown 0.25s ease-in forwards;
}

@keyframes modalSlideUp {
    from { 
        transform: translateY(100%);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes modalSlideDown {
    from { 
        transform: translateY(0);
        opacity: 1;
    }
    to { 
        transform: translateY(100%);
        opacity: 0;
    }
}

.modal-handle {
    width: 32px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 8px auto 16px;
    cursor: grab;
}
.modal-handle:hover { background: var(--text-muted); }

.modal-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
    letter-spacing: -0.2px;
}

.modal-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 20px;
}

.modal-action-btn {
    width: 100%;
    height: 44px;
    border-radius: 6px;
    border: 1px solid;
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.12s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.modal-action-btn:hover { 
    filter: brightness(1.05);
}
.modal-action-btn:active {
    transform: scale(0.98);
}

.btn-green { 
    background: var(--btn-plus-bg); 
    border-color: var(--btn-plus-border); 
    color: var(--accent-green); 
}
.btn-green:hover { background: var(--accent-green); color: white; }

.btn-yellow { 
    background: var(--accent-yellow-glow); 
    border-color: var(--accent-yellow); 
    color: var(--accent-yellow); 
}
.btn-yellow:hover { background: var(--accent-yellow); color: white; }

.btn-red { 
    background: var(--btn-minus-bg); 
    border-color: var(--btn-minus-border); 
    color: var(--accent-red); 
}
.btn-red:hover { background: var(--accent-red); color: white; }

.btn-gray { 
    background: var(--bg-elevated); 
    border-color: var(--border); 
    color: var(--text-secondary); 
}
.btn-gray:hover { background: var(--bg-input); border-color: var(--text-muted); }

/* ── PRIMARY ACTION BUTTON ── */
.btn-primary-large {
    width: 100%;
    height: 60px;
    border-radius: 14px;
    border: 2px solid var(--accent-green);
    background: linear-gradient(135deg, #0A3A1A 0%, #0A2A1A 100%);
    color: var(--accent-green);
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-glow-green);
    text-transform: uppercase;
}
.btn-primary-large:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
}
.btn-primary-large:active:not(:disabled) {
    transform: translateY(0);
}
.btn-primary-large:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    box-shadow: none;
}
.btn-primary-large.all-entered {
    background: linear-gradient(135deg, #1a2a1a 0%, #151a15 100%);
    border-color: var(--text-muted);
    color: var(--text-muted);
}

/* ── SECONDARY BUTTONS ROW ── */
.modal-secondary-row {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}
.modal-secondary-row .modal-action-btn {
    flex: 1;
    height: 40px;
    font-size: 12px;
}

/* ── SPOILER / COLLAPSIBLE ── */
.modal-spoiler {
    margin-top: 16px;
    border-top: 1px solid var(--border);
    padding-top: 12px;
}
.spoiler-toggle {
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.1em;
    cursor: pointer;
    padding: 8px 0;
    width: 100%;
    text-align: center;
    transition: color 0.2s;
}
.spoiler-toggle:hover { color: var(--text-secondary); }
.spoiler-content {
    display: none;
    padding-top: 8px;
}
.spoiler-content.open { display: block; }

/* ── CLOSE LINK ── */
.modal-close-link {
    display: block;
    text-align: center;
    margin-top: 16px;
    padding: 12px;
    color: var(--text-muted);
    font-family: var(--font-mono);
    font-size: 12px;
    letter-spacing: 0.1em;
    cursor: pointer;
    background: none;
    border: none;
    width: 100%;
    transition: color 0.2s;
}
.modal-close-link:hover { color: var(--text-secondary); }

/* ── QUICK ENTRY SECTION ── */
.quick-entry-section {
    margin-top: 16px;
    padding: 16px;
    background: var(--bg-elevated);
    border-radius: 12px;
    border: 1px solid var(--border);
}

.quick-entry-title {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 12px;
    text-align: center;
}

.quick-nums {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 12px;
}

.quick-num {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--bg-card);
    border: 1.5px solid var(--border);
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quick-num:hover {
    border-color: var(--accent-green);
    color: var(--accent-green);
}

.quick-num.selected {
    background: var(--accent-green);
    border-color: var(--accent-green);
    color: white;
    box-shadow: 0 0 16px rgba(16, 185, 129, 0.3);
}

.quick-num:active {
    transform: scale(0.92);
}

.quick-num:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.quick-counter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 16px;
}

.quick-counter-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1.5px solid var(--border);
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
}

.quick-counter-btn:hover:not(:disabled) {
    border-color: var(--accent-green);
    color: var(--accent-green);
}

.quick-counter-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.quick-counter-value {
    font-family: var(--font-display);
    font-size: 32px;
    font-weight: 800;
    color: var(--accent-green);
    min-width: 60px;
    text-align: center;
}

.quick-counter-value.negative {
    color: var(--accent-orange);
}

.quick-apply-btn {
    width: 100%;
    height: 52px;
    border-radius: 12px;
    border: 2px solid var(--accent-green);
    background: linear-gradient(135deg, #0A3A1A 0%, #0A2A1A 100%);
    color: var(--accent-green);
    font-family: var(--font-display);
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-glow-green);
}

.quick-apply-btn:hover:not(:disabled) {
    box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
}

.quick-apply-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    box-shadow: none;
}

.quick-apply-btn.return-mode {
    border-color: var(--accent-orange);
    background: linear-gradient(135deg, #2A1A0A 0%, #1A1005 100%);
    color: var(--accent-orange);
    box-shadow: 0 0 20px rgba(249, 115, 22, 0.2);
}

/* ── HISTORY ITEM ADMIT BUTTON ── */
.hi-admit-btn {
    width: 28px;
    height: 28px;
    padding: 0;
    border-radius: 50%;
    border: 1.5px solid var(--accent-green);
    background: transparent;
    color: var(--accent-green);
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
}

.history-item:hover .hi-admit-btn {
    opacity: 1;
}

.hi-admit-btn:hover:not(:disabled) {
    background: var(--accent-green);
    color: white;
    transform: scale(1.05);
}

.hi-admit-btn:active:not(:disabled) {
    transform: scale(0.92);
}

.hi-admit-btn:disabled,
.hi-admit-btn.done {
    opacity: 0.25;
    cursor: not-allowed;
    border-color: var(--border);
    color: var(--text-muted);
}

/* ── PASSWORD PROMPT ── */
.password-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1100;
    justify-content: center;
    align-items: center;
    padding: 24px;
}
.password-modal.active { display: flex; }

.password-card {
    width: 100%;
    max-width: 340px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    text-align: center;
}

.password-card h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
}

.password-card input {
    width: 100%;
    height: 48px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0 16px;
    color: var(--text-primary);
    font-size: 16px;
    text-align: center;
    outline: none;
    margin-bottom: 16px;
}
.password-card input:focus { border-color: var(--border-focus); }

.password-btns { display: flex; gap: 8px; }

.password-btns button {
    flex: 1;
    height: 44px;
    border-radius: 10px;
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
}

.pw-cancel { background: var(--bg-elevated); color: var(--text-secondary); }
.pw-confirm { background: var(--text-primary); color: var(--bg-primary); border-color: var(--text-primary); }

/* ── HISTORY ITEM +/- BUTTONS ── */
.hi-buttons {
    display: flex;
    align-items: center;
    gap: 3px;
    flex-shrink: 0;
}

.hi-btn {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    padding: 0;
    line-height: 1;
    background: transparent;
    color: var(--text-muted);
    flex-shrink: 0;
    opacity: 0.5;
}
.history-item:hover .hi-btn:not(:disabled) {
    opacity: 0.8;
}
.hi-btn:hover:not(:disabled) { 
    opacity: 1;
    transform: scale(1.05);
}
.hi-btn:active:not(:disabled) { 
    transform: scale(0.92);
}
.hi-btn:disabled { 
    opacity: 0.2; 
    cursor: not-allowed;
    border-color: var(--border-subtle);
}
.hi-btn:disabled:hover { transform: none; }

.hi-btn-minus {
    border-color: rgba(239, 68, 68, 0.3);
    color: var(--accent-red);
}
.hi-btn-minus:hover:not(:disabled) {
    background: var(--accent-red);
    border-color: var(--accent-red);
    color: white;
}

.hi-btn-plus {
    border-color: rgba(16, 185, 129, 0.3);
    color: var(--accent-green);
}
.hi-btn-plus:hover:not(:disabled) {
    background: var(--accent-green);
    border-color: var(--accent-green);
    color: white;
}

/* ── PENDING ACTIONS (compact inline) ── */
.pending-actions {
    display: flex;
    align-items: center;
    gap: 3px;
    padding-left: 4px;
    border-left: 1px solid var(--border);
    margin-left: 4px;
}

.pending-badge {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    min-width: 20px;
    text-align: center;
    color: var(--accent-green);
    padding: 1px 3px;
    border-radius: 3px;
    background: transparent;
}
.pending-badge.negative { 
    color: var(--accent-red);
    background: transparent;
}

.apply-btn {
    background: transparent;
    color: var(--accent-green);
    border: 1px solid var(--accent-green);
    border-radius: 4px;
    padding: 3px 6px;
    font-family: var(--font-display);
    font-size: 10px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.12s ease;
}
.apply-btn.negative { 
    color: var(--accent-yellow);
    border-color: var(--accent-yellow);
}
.apply-btn:hover {
    background: var(--accent-green);
    color: white;
}
.apply-btn.negative:hover {
    background: var(--accent-yellow);
    color: white;
}
.apply-btn:active { transform: scale(0.95); }

.cancel-pending-btn {
    width: 18px; height: 18px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-size: 9px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: all 0.12s ease;
    flex-shrink: 0;
}
.cancel-pending-btn:hover { 
    border-color: var(--accent-red); 
    color: var(--accent-red);
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

/* Checkbox wrapper for larger touch target */
.hi-checkbox-wrapper {
    width: 28px;
    height: 100%;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    position: relative;
}
/* Invisible expanded touch area */
.hi-checkbox-wrapper::before {
    content: '';
    position: absolute;
    top: -6px;
    left: -8px;
    right: -4px;
    bottom: -6px;
}

.hi-checkbox {
    appearance: none;
    -webkit-appearance: none;
    width: 22px; 
    height: 22px;
    border: 2px solid var(--border);
    border-radius: 50%;
    background: transparent;
    cursor: pointer;
    flex-shrink: 0;
    margin: 0;
    position: relative;
    transition: all 0.2s ease;
    pointer-events: none;
}
.hi-checkbox:checked {
    background: var(--accent-orange);
    border-color: var(--accent-orange);
    animation: checkBounce 0.25s ease;
}
.hi-checkbox:checked::after {
    content: '';
    position: absolute;
    top: 4px;
    left: 7px;
    width: 5px;
    height: 9px;
    border: solid white;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
}
.hi-checkbox-wrapper:hover .hi-checkbox {
    border-color: var(--accent-orange);
    background: rgba(249, 115, 22, 0.1);
}
.hi-checkbox-wrapper:active .hi-checkbox {
    transform: scale(0.9);
}

/* Status indicator dot on checkbox */
.hi-checkbox-wrapper[data-status="entered"] .hi-checkbox {
    border-color: var(--accent-green);
}
.hi-checkbox-wrapper[data-status="entered"] .hi-checkbox:not(:checked) {
    box-shadow: inset 0 0 0 3px var(--accent-green);
}
.hi-checkbox-wrapper[data-status="duplicate"] .hi-checkbox {
    border-color: var(--accent-yellow);
}
.hi-checkbox-wrapper[data-status="pending"] .hi-checkbox {
    border-color: var(--border);
}

@keyframes checkBounce {
    0% { transform: scale(0.8); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* ── MASS ACTION BAR ── */
.mass-action-bar {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--bg-card);
    border: 1px solid var(--accent-orange);
    border-radius: 6px;
    flex-wrap: wrap;
    flex-shrink: 0;
    animation: slideDown 0.2s ease;
}
.mass-action-bar.active { display: flex; }

@keyframes slideDown {
    from { 
        opacity: 0;
        transform: translateY(-8px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.mass-select-all {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-weight: 500;
    white-space: nowrap;
}

.mass-select-all input {
    appearance: none;
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border: 1.5px solid var(--border);
    border-radius: 3px;
    background: var(--bg-input);
    cursor: pointer;
    margin: 0;
    position: relative;
    transition: all 0.12s ease;
}
.mass-select-all input:checked {
    background: var(--accent-orange);
    border-color: var(--accent-orange);
}
.mass-select-all input:checked::after {
    content: '✓';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 9px;
    font-weight: 600;
}

.mass-count {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    color: var(--accent-orange);
    background: rgba(249, 115, 22, 0.1);
    padding: 3px 8px;
    border-radius: 4px;
    min-width: 50px;
    text-align: center;
}

.mass-buttons {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
    margin-left: auto;
}

.mass-btn {
    height: 28px;
    padding: 0 10px;
    border-radius: 6px;
    border: 1.5px solid;
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}
.mass-btn:hover { 
    transform: translateY(-1px);
}
.mass-btn:active { transform: scale(0.95); }
.mass-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.mass-btn:disabled:hover { transform: none; }

.mass-btn-reset { 
    background: var(--bg-elevated); 
    border-color: var(--border); 
    color: var(--text-secondary); 
}
.mass-btn-reset:hover { border-color: var(--text-muted); background: var(--bg-hover); }

.mass-btn-minus { 
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 50%;
    background: transparent;
    border-color: rgba(239, 68, 68, 0.4);
    color: var(--accent-red);
    font-size: 16px;
}
.mass-btn-minus:hover { background: var(--accent-red); border-color: var(--accent-red); color: white; }

.mass-btn-plus { 
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 50%;
    background: transparent;
    border-color: rgba(16, 185, 129, 0.4);
    color: var(--accent-green);
    font-size: 16px;
}
.mass-btn-plus:hover { background: var(--accent-green); border-color: var(--accent-green); color: white; }

.mass-btn-hide { 
    background: transparent; 
    border-color: var(--accent-red); 
    color: var(--accent-red); 
}
.mass-btn-hide:hover { background: var(--accent-red); color: white; }

/* ── MASS PENDING (БАГ 2) ── */
.mass-pending-display {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 700;
    min-width: 40px;
    text-align: center;
    color: var(--text-muted);
    padding: 0 6px;
    transition: all 0.2s;
}
.mass-pending-display.positive { 
    color: var(--accent-green);
    text-shadow: 0 0 10px var(--accent-green-glow);
}
.mass-pending-display.negative { 
    color: var(--accent-red);
    text-shadow: 0 0 10px var(--accent-red-glow);
}

.mass-apply-btn {
    height: 36px;
    padding: 0 16px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
    color: white;
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    animation: fadeIn 0.2s ease;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    transition: all 0.15s;
}
.mass-apply-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}
.mass-apply-btn:active { transform: scale(0.95); }
.mass-apply-btn.negative { background: var(--accent-yellow); }
.mass-apply-btn:hover { opacity: 0.9; }

/* ── EMPTY STATE ── */
.empty-state {
    text-align: center;
    padding: 60px 24px;
    color: var(--text-muted);
    animation: fadeSlideIn 0.4s ease-out;
}

.empty-state-icon { 
    font-size: 56px; 
    margin-bottom: 16px;
    opacity: 0.5;
}
.empty-state-text { 
    font-size: 15px;
    font-weight: 500;
}

/* ── LOADING ── */
.spinner {
    width: 24px; height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--text-primary);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin: 20px auto;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── LOGIN SHAKE ── */
@keyframes loginShake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
    20%, 40%, 60%, 80% { transform: translateX(6px); }
}
.login-card.shake { animation: loginShake 0.5s ease-in-out; }

/* ── TOAST NOTIFICATION ── */
.scan-toast {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%) translateY(-16px);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 18px;
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 500;
    z-index: 900;
    opacity: 0;
    pointer-events: none;
    max-width: 90vw;
    text-align: center;
}
.scan-toast.show {
    opacity: 1;
    animation: toastSlideIn 0.2s ease forwards;
}
.scan-toast.hide {
    animation: toastSlideOut 0.15s ease forwards;
}

@keyframes toastSlideIn {
    from { 
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to { 
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}
@keyframes toastSlideOut {
    from { 
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to { 
        opacity: 0;
        transform: translateX(-50%) translateY(-16px);
    }
}

.scan-toast.toast-valid { 
    border-color: var(--accent-green); 
    color: var(--accent-green);
    background: var(--bg-card);
}
.scan-toast.toast-used { 
    border-color: var(--accent-yellow); 
    color: var(--accent-yellow);
    background: var(--bg-card);
}
.scan-toast.toast-invalid { 
    border-color: var(--accent-red); 
    color: var(--accent-red);
    background: var(--bg-card);
}
.scan-toast.toast-denied { 
    border-color: var(--accent-red); 
    color: var(--accent-red);
    background: var(--bg-card);
}

/* ── PHONE SEARCH ON SCANNER TAB ── */
.manual-search {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}
.manual-search input {
    flex: 1;
    height: 34px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0 10px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 13px;
    outline: none;
}
.manual-search input:focus { border-color: var(--border-focus); }
.manual-search input::placeholder { color: var(--text-muted); }
.manual-search button {
    height: 34px;
    padding: 0 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
}

/* ── TOP BAR EXTRAS ── */
.conn-text {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.05em;
    margin-right: 2px;
}
.conn-text.online { color: var(--accent-green); }
.conn-text.offline { color: var(--accent-red); }

.top-btn-fs {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 32px; height: 32px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ── YELLOW BUTTON FOR DUPLICATE ── */
.btn-orange { background: #2A1A0A; border-color: var(--accent-orange); color: var(--accent-orange); }

/* ── THEME TOGGLE ── */
.theme-toggle {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    width: 32px; height: 32px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
    flex-shrink: 0;
    padding: 0;
}
.theme-toggle:hover { border-color: var(--text-secondary); color: var(--text-primary); }
.login-theme-toggle { position: absolute; top: 16px; right: 16px; }

/* ── CITY SWITCHER ── */
.city-switcher-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 60dvh;
    overflow-y: auto;
}
.city-group-label {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
    padding: 12px 0 4px;
    border-bottom: 1px solid var(--border);
}
.city-option {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    text-align: left;
    transition: all var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}
.city-option:hover { border-color: var(--accent-orange); }
.city-option.active { border-color: var(--accent-orange); background: rgba(249, 115, 22, 0.08); }
.city-option-name { flex: 1; }
.city-option-check { color: var(--accent-orange); font-size: 12px; }

/* ── STATUS DOTS ── */
.dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
    vertical-align: middle;
    flex-shrink: 0;
    transition: all 0.2s;
}
.filter-tab.active .dot {
    transform: scale(1.3);
    box-shadow: 0 0 8px currentColor;
}
.dot-gray { background: var(--text-muted); }
.dot-green { background: var(--accent-green); }
.dot-yellow { background: var(--accent-yellow); }
.dot-red { background: var(--accent-red); }

/* ── SVG ICON HELPERS ── */
.btn-icon {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    flex-shrink: 0;
}
.btn-icon svg { display: block; }
.status-icon svg { width: 28px; height: 28px; }
.spinning svg { animation: spin 0.8s linear infinite; }

/* ── SCAN BUTTON ── */
.scan-btn-wrapper {
    padding: 8px 0 0;
    flex-shrink: 0;
    display: none; /* shown when camera is active */
}
.scan-btn-wrapper.visible { display: block; }

.scan-btn {
    width: 100%;
    height: 72px;
    border: none;
    border-radius: 16px;
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.25s ease;
    -webkit-tap-highlight-color: transparent;
    position: relative;
    overflow: hidden;
}

.scan-btn svg {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
}

/* State: Ready */
.scan-btn.scan-ready {
    background: var(--accent-orange);
    color: #FFFFFF;
    box-shadow: 0 4px 20px rgba(249, 115, 22, 0.35);
}
.scan-btn.scan-ready:hover {
    box-shadow: 0 6px 28px rgba(249, 115, 22, 0.5);
    transform: translateY(-1px);
}
.scan-btn.scan-ready:active {
    transform: scale(0.97);
    box-shadow: 0 2px 12px rgba(249, 115, 22, 0.3);
}

/* State: Scanning (waiting for QR) - STOP button */
.scan-btn.scan-active {
    background: #DC2626;
    color: #FFF;
    cursor: pointer;
    animation: scan-pulse 1.5s ease-in-out infinite;
    box-shadow: 0 4px 20px rgba(220, 38, 38, 0.35);
}
.scan-btn.scan-active:hover {
    background: #B91C1C;
    box-shadow: 0 6px 28px rgba(220, 38, 38, 0.5);
    transform: translateY(-1px);
}
.scan-btn.scan-active:active {
    transform: scale(0.97);
    box-shadow: 0 2px 12px rgba(220, 38, 38, 0.3);
}

@keyframes scan-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.5); }
    50% { box-shadow: 0 0 0 14px rgba(249, 115, 22, 0); }
}

/* State: Processing (API call) */
.scan-btn.scan-processing {
    background: var(--bg-elevated);
    color: var(--text-muted);
    cursor: not-allowed;
    box-shadow: none;
    animation: none;
}

/* Hide scan line when not scanning */
.scan-line { display: none; }
.scan-line.active { display: block; }

/* ── UTILITIES ── */
.hidden { display: none !important; }

/* ── RESPONSIVE ── */
@media (min-width: 768px) {
    .scanner-tab {
        max-width: 600px;
        margin: 0 auto;
        width: 100%;
    }
    .history-tab {
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
    }
    .modal-sheet {
        max-height: 70dvh;
        border-radius: 18px;
        align-self: center;
    }
    .top-time { display: inline; }
}

/* ═══════════════════════════════════════════════════
   TESTS SECTION
   ═══════════════════════════════════════════════════ */

/* Tests Overlay - Full Screen */
.tests-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--bg-primary);
    z-index: 1050;
    flex-direction: column;
    overflow: hidden;
}
.tests-overlay.active {
    display: flex;
}

/* Tests Header */
.tests-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}

.tests-back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
}
.tests-back-btn:hover {
    border-color: var(--accent-orange);
    color: var(--accent-orange);
}
.tests-back-btn svg {
    width: 16px;
    height: 16px;
}

.tests-header-tabs {
    display: flex;
    gap: 0;
}

.tests-tab-btn {
    padding: 8px 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-muted);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
}
.tests-tab-btn.active {
    color: var(--accent-orange);
    border-bottom-color: var(--accent-orange);
}
.tests-tab-btn:hover:not(.active) {
    color: var(--text-secondary);
}

/* Tests Tab Content */
.tests-tab-content {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: 16px;
}
.tests-tab-content.active {
    display: block;
}

/* Tests Catalog Grid */
.tests-catalog-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}
@media (min-width: 500px) {
    .tests-catalog-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Test Card */
.test-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
}
.test-card:hover {
    border-color: var(--accent-orange);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}
.test-card.in-progress {
    border-color: var(--accent-yellow);
}
.test-card.completed {
    border-color: var(--accent-green);
}

.test-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 8px;
}

.test-card-icon {
    font-size: 28px;
    line-height: 1;
}

.test-card-badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
}
.test-card-badge.not-started {
    background: var(--bg-elevated);
    color: var(--text-muted);
}
.test-card-badge.in-progress {
    background: rgba(245, 158, 11, 0.15);
    color: var(--accent-yellow);
}
.test-card-badge.completed {
    background: rgba(16, 185, 129, 0.15);
    color: var(--accent-green);
}

.test-card-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.test-card-desc {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    line-height: 1.4;
}

.test-card-meta {
    display: flex;
    gap: 12px;
    font-size: 11px;
    color: var(--text-muted);
}

.test-card-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
}

.test-card-difficulty {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
}
.test-card-difficulty.easy {
    background: rgba(16, 185, 129, 0.1);
    color: var(--accent-green);
}
.test-card-difficulty.medium {
    background: rgba(245, 158, 11, 0.1);
    color: var(--accent-yellow);
}
.test-card-difficulty.hard {
    background: rgba(239, 68, 68, 0.1);
    color: var(--accent-red);
}

.test-card-score {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--accent-green);
    font-weight: 600;
}

/* Test Question Screen */
.test-question-screen {
    position: absolute;
    inset: 0;
    background: var(--bg-primary);
    display: flex;
    flex-direction: column;
    padding: 16px;
    overflow-y: auto;
}

/* Back to Scanner Button */
.test-back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    margin-bottom: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    width: fit-content;
}
.test-back-btn svg {
    width: 18px;
    height: 18px;
}
.test-back-btn:hover {
    background: var(--bg-elevated);
    border-color: var(--text-muted);
    color: var(--text-primary);
}
.test-back-btn:active {
    transform: scale(0.97);
}
.reaction-back-btn {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 10;
    margin-bottom: 0;
}

.test-progress {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.test-progress-bar {
    flex: 1;
    height: 6px;
    background: var(--bg-elevated);
    border-radius: 3px;
    overflow: hidden;
}

.test-progress-fill {
    height: 100%;
    background: var(--accent-orange);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.test-progress-text {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
}

.test-question-card {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.test-question-text {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.5;
    margin-bottom: 20px;
}

.test-question-visual {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    min-height: 100px;
}

.test-question-visual svg {
    max-width: 100%;
    height: auto;
}

.test-answers {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.test-answer-btn {
    padding: 14px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 14px;
    text-align: left;
    cursor: pointer;
    transition: all 0.15s;
}
.test-answer-btn:hover {
    border-color: var(--accent-orange);
    background: var(--bg-elevated);
}
.test-answer-btn:active {
    transform: scale(0.98);
}

/* Test Result Screen */
.test-result-screen {
    position: absolute;
    inset: 0;
    background: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.test-result-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px 24px;
    text-align: center;
    max-width: 320px;
    width: 100%;
}

.test-result-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.test-result-score {
    font-size: 48px;
    font-weight: 800;
    color: var(--accent-orange);
    margin-bottom: 4px;
}

.test-result-label {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 12px;
}

.test-result-desc {
    font-size: 15px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    line-height: 1.5;
}

.test-result-time {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 24px;
}

.test-result-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent-orange);
    border: none;
    border-radius: 10px;
    color: white;
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
}
.test-result-btn:hover {
    opacity: 0.9;
}

/* Reaction Test Screen */
.reaction-test-screen {
    position: absolute;
    inset: 0;
    background: var(--bg-primary);
    display: flex;
    flex-direction: column;
}

.reaction-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.1s;
    user-select: none;
}
.reaction-area.waiting {
    background: var(--accent-red);
}
.reaction-area.ready {
    background: var(--accent-green);
}
.reaction-area.result {
    background: var(--bg-card);
}

.reaction-text {
    font-size: 24px;
    font-weight: 700;
    color: white;
    text-align: center;
    padding: 20px;
}
.reaction-area.result .reaction-text {
    color: var(--text-primary);
}

.reaction-result {
    font-size: 48px;
    font-weight: 800;
    color: white;
}
.reaction-area.result .reaction-result {
    color: var(--accent-orange);
}

.reaction-rounds {
    padding: 16px;
    text-align: center;
    font-size: 14px;
    color: var(--text-muted);
    background: var(--bg-card);
    border-top: 1px solid var(--border);
}

/* Tests Stats Summary */
.tests-stats-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.tests-stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
}

.tests-stat-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-orange);
    margin-bottom: 4px;
}

.tests-stat-label {
    font-size: 11px;
    color: var(--text-muted);
}

/* Tests History List */
.tests-history-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.tests-history-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
}

.tests-history-icon {
    font-size: 24px;
}

.tests-history-info {
    flex: 1;
    min-width: 0;
}

.tests-history-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.tests-history-date {
    font-size: 11px;
    color: var(--text-muted);
}

.tests-history-score {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-green);
}

.tests-history-time {
    font-size: 11px;
    color: var(--text-muted);
    text-align: right;
}

/* No results placeholder */
.tests-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.tests-empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
}

.tests-empty-text {
    font-size: 14px;
}

/* IQ Pattern visuals */
.iq-pattern-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    width: 200px;
}

.iq-pattern-cell {
    aspect-ratio: 1;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.iq-pattern-cell.highlight {
    background: var(--accent-orange);
    border-color: var(--accent-orange);
}

.iq-pattern-cell.question {
    background: var(--bg-input);
    border: 2px dashed var(--accent-orange);
}

/* Sequence memory visual */
.sequence-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    width: 180px;
}

.sequence-cell {
    aspect-ratio: 1;
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.15s;
}

.sequence-cell.active {
    background: var(--accent-orange);
    border-color: var(--accent-orange);
    color: white;
}

.sequence-cell:hover {
    border-color: var(--accent-orange);
}

/* Dark/Light theme adjustments for tests */
[data-theme="light"] .reaction-area.result {
    background: var(--bg-elevated);
}

[data-theme="light"] .test-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
}
    </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════
     LOGIN SCREEN
     ═══════════════════════════════════════════════════ -->
<div id="loginScreen" class="screen active">
    <button class="theme-toggle login-theme-toggle" onclick="toggleTheme()" aria-label="Переключить тему" id="themeToggleLogin"></button>
    <div class="login-card">
        <div class="login-brand">IMPREZA</div>
        <div class="login-subtitle">система верификации</div>

        <div class="login-field">
            <label>Логин</label>
            <input type="text" id="loginUsername" placeholder="Введите логин" autocomplete="username" autocapitalize="none">
        </div>

        <div class="login-field">
            <label>Пароль</label>
            <input type="password" id="loginPassword" placeholder="Введите пароль" autocomplete="current-password">
        </div>

        <button class="login-btn" id="loginBtn" onclick="doLogin()">ВОЙТИ</button>
        <div class="login-error" id="loginError"></div>
        <div class="login-footer">Powered by Impreza Events</div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════
     MAIN SCANNER SCREEN
     ═══════════════════════════════════════════════════ -->
<div id="mainScreen" class="screen">

    <!-- Top Bar (двухстрочный дизайн) -->
    <div class="top-bar">
        <!-- Строка 1: Логотип + Город + Online + Меню -->
        <div class="top-bar-row-1">
            <span class="top-logo">IMPREZA</span>
            <div class="header-city" id="headerCity" onclick="openCitySwitcher()">
                <span class="city-pin">📍</span>
                <span class="city-name" id="topCity">Варшава</span>
                <span class="city-arrow">›</span>
            </div>
            <div class="top-right">
                <div class="online-indicator" id="onlineIndicator">
                    <span class="dot"></span>
                    <span id="connText">ONLINE</span>
                </div>
                <button class="burger-btn" onclick="openBurger()" aria-label="Меню">☰</button>
            </div>
        </div>
        <!-- Строка 2: Табы + Фильтр событий -->
        <div class="top-bar-row-2">
            <div class="top-bar-tabs">
                <button class="top-tab-btn active" data-tab="scanner" onclick="switchTab('scanner')">СКАНЕР</button>
                <button class="top-tab-btn" data-tab="history" onclick="switchTab('history')">ИСТОРИЯ</button>
            </div>
            <select class="event-filter-select" id="eventFilter" onchange="applyEventFilter()">
                <option value="ALL">Все события</option>
            </select>
        </div>
    </div>

    <!-- Tab Bar (скрыт, переключение через бургер) -->
    <div class="tab-bar">
        <button class="tab-btn active" data-tab="scanner" onclick="switchTab('scanner')">СКАНЕР</button>
        <button class="tab-btn" data-tab="history" onclick="switchTab('history')">ИСТОРИЯ</button>
    </div>

    <!-- SCANNER TAB -->
    <div class="tab-content active scanner-tab" id="tabScanner">

        <!-- Status Card (compact horizontal) -->
        <div class="status-card" id="statusCard">
            <div class="status-icon status-icon--waiting" id="statusIcon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
                    <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
                    <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
                    <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
                    <rect x="7" y="7" width="3" height="3"/>
                    <rect x="14" y="7" width="3" height="3"/>
                    <rect x="7" y="14" width="3" height="3"/>
                    <rect x="14" y="14" width="3" height="3"/>
                </svg>
            </div>
            <div class="status-info">
                <div class="status-text" id="statusText">Ожидание скана</div>
                <div class="status-subtitle" id="statusSubtitle">Наведите камеру на QR-код</div>
            </div>
        </div>

        <!-- Search Admit Button (БАГ 3) -->
        <div id="searchAdmitContainer" style="display:none">
            <button class="search-admit-btn" id="searchAdmitBtn" onclick="admitFromSearch()">✅ ВПУСТИТЬ</button>
        </div>

        <!-- Camera -->
        <div class="camera-section">
            <div class="camera-container" id="cameraContainer">
                <video id="scannerVideo" muted playsinline></video>
                <div class="scan-region-overlay" id="scanOverlay" style="display:none">
                    <div class="scan-region-box">
                        <div class="scan-corner-bl"></div>
                        <div class="scan-corner-br"></div>
                        <div class="scan-line"></div>
                    </div>
                </div>
            </div>
            <div class="camera-toggle">
                <button class="cam-btn cam-ready" id="btnCamStart" onclick="toggleCamera()" title="Запустить камеру">
                    <svg id="camIconPlay" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="6,4 20,12 6,20"/></svg>
                    <svg id="camIconStop" viewBox="0 0 24 24" fill="currentColor" stroke="none" style="display:none"><rect x="5" y="5" width="14" height="14" rx="2"/></svg>
                </button>
                <button class="cam-btn cam-switch" id="btnCamSwitch" onclick="switchCameraFacing()" title="Переключить камеру">
                    <svg class="cam-switch-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 4v5h-5"/>
                        <path d="M3 20v-5h5"/>
                        <path d="M5.5 9A7.5 7.5 0 0 1 18.3 6.3L21 9"/>
                        <path d="M18.5 15a7.5 7.5 0 0 1-12.8 2.7L3 15"/>
                    </svg>
                </button>
            </div>
            <!-- SCAN Button (single-scan mode) -->
            <div class="scan-btn-wrapper" id="scanBtnWrapper">
                <button class="scan-btn scan-ready" id="scanBtn" onclick="activateScan()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/></svg>
                    <span id="scanBtnText">SCAN</span>
                </button>
            </div>
        </div>

        <!-- Guest Info (collapsible) -->
        <div class="guest-info" id="guestInfoPanel">
            <div class="guest-info-header" onclick="document.getElementById('guestInfoPanel').classList.toggle('open')">Информация о госте</div>
            <div class="guest-info-body">
                <div class="guest-grid">
                    <div class="guest-field"><div class="guest-field-label">Имя</div><div class="guest-field-value" id="gName">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Заказ</div><div class="guest-field-value" id="gOrder">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Телефон</div><div class="guest-field-value" id="gPhone">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Email</div><div class="guest-field-value" id="gEmail">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Билет</div><div class="guest-field-value" id="gTicket">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Цена</div><div class="guest-field-value" id="gPrice">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Промо</div><div class="guest-field-value" id="gPromo">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Событие</div><div class="guest-field-value" id="gEvent">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Входы</div><div class="guest-field-value" id="gEntries">—</div></div>
                </div>
            </div>
        </div>

        <!-- Manual Phone Search -->
        <div class="manual-search">
            <input type="tel" id="phoneSearchInput" placeholder="Поиск по номеру телефона..." onkeydown="if(event.key==='Enter')searchByPhone()">
            <button onclick="searchByPhone()">Найти</button>
        </div>
    </div>

    <!-- HISTORY TAB -->
    <div class="tab-content history-tab" id="tabHistory">
        <div class="history-controls">
            <div class="search-wrapper">
                <input type="search" class="history-search" id="historySearch" placeholder="Поиск по имени, телефону, email..." oninput="filterHistory(); updateSearchClear()">
                <button class="search-clear" id="searchClear" onclick="clearSearch()">✕</button>
            </div>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshWithIndicator()" title="Обновить">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9v-3m-9-6a9 9 0 0 1 9-9m-9 9v3m9-12v3"/>
                </svg>
            </button>
        </div>

        <div class="history-filter-tabs">
            <button class="filter-tab active" data-filter="all" onclick="setHistoryFilter('all', this)">Все</button>
            <button class="filter-tab" data-filter="pending" onclick="setHistoryFilter('pending', this)"><span class="dot dot-gray"></span> Новые</button>
            <button class="filter-tab" data-filter="entered" onclick="setHistoryFilter('entered', this)"><span class="dot dot-green"></span> Вошли</button>
            <button class="filter-tab" data-filter="duplicate" onclick="setHistoryFilter('duplicate', this)"><span class="dot dot-yellow"></span> Повтор</button>
            <button class="filter-tab" data-filter="invalid" onclick="setHistoryFilter('invalid', this)"><span class="dot dot-red"></span> Отказ</button>
        </div>

        <div class="metrics-bar" id="metricsBar">
            <div class="metrics-row">
                <span class="metric-item"><span class="metric-value" id="metricTotal">0</span> <span class="metric-label">гостей</span></span>
                <span class="metric-dot"></span>
                <span class="metric-item metric-green"><span class="metric-value" id="metricEntered">0</span> <span class="metric-label">вошли</span></span>
                <span class="metric-dot"></span>
                <span class="metric-item"><span class="metric-value" id="metricPending">0</span> <span class="metric-label">ожидают</span></span>
            </div>
            <div class="metrics-progress">
                <div class="metrics-progress-fill" id="metricsProgressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Mass Action Bar -->
        <div class="mass-action-bar" id="massActionBar">
            <label class="mass-select-all">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                <span>Выбрать все</span>
            </label>
            <div class="mass-count" id="massCount">Выбрано: 0</div>
            <div class="mass-buttons">
                <button class="mass-btn mass-btn-reset" onclick="executeMassAction('reset')" title="Сбросить сканы до 0">↩ Сброс</button>
                <button class="mass-btn mass-btn-minus" onclick="massIncrement(-1)" title="−">−</button>
                <span class="mass-pending-display" id="massPendingDisplay">0</span>
                <button class="mass-btn mass-btn-plus" onclick="massIncrement(+1)" title="+">+</button>
                <button class="mass-apply-btn" id="massApplyBtn" onclick="massApplyPending()" style="display:none">Применить</button>
                <button class="mass-btn mass-btn-hide" onclick="executeMassAction('hide')" title="Скрыть билеты">Скрыть</button>
            </div>
        </div>

        <div class="history-list" id="historyList"></div>
    </div>

    <!-- Bottom Stats Bar -->
    <div class="bottom-bar">
        <div class="stat-item">
            <div class="stat-value green" id="statAdmitted">0</div>
            <div class="stat-label">
                <svg class="stat-icon" width="14" height="14" viewBox="0 0 16 16" fill="none">
                    <circle cx="8" cy="4" r="3" fill="#10B981"/>
                    <path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6" stroke="#10B981" stroke-width="1.5" fill="none"/>
                </svg>
                Вошли
            </div>
        </div>
        <div class="stat-item">
            <div class="stat-value yellow" id="statDuplicate">0</div>
            <div class="stat-label">
                <svg class="stat-icon" width="14" height="14" viewBox="0 0 16 16" fill="none">
                    <path d="M3 8a5 5 0 019-3M13 8a5 5 0 01-9 3" stroke="#F59E0B" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M12 5l1-2.5L10.5 3" stroke="#F59E0B" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Повтор
            </div>
        </div>
        <div class="stat-item">
            <div class="stat-value gray" id="statPending">0</div>
            <div class="stat-label">
                <svg class="stat-icon" width="14" height="14" viewBox="0 0 16 16" fill="none">
                    <circle cx="8" cy="8" r="6" stroke="#6B7280" stroke-width="1.5" fill="none"/>
                    <path d="M8 4v4l3 2" stroke="#6B7280" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Ожидают
            </div>
        </div>
        <div class="stat-item">
            <div class="stat-value red" id="statDenied">0</div>
            <div class="stat-label">
                <svg class="stat-icon" width="14" height="14" viewBox="0 0 16 16" fill="none">
                    <path d="M4 4l8 8M12 4l-8 8" stroke="#EF4444" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Отказ
            </div>
        </div>
    </div>
</div>

<!-- Ticket Detail Modal -->
<div class="modal-overlay" id="ticketModal" onclick="closeModal(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="modal-title" id="modalTitle">Детали билета</div>
        <div class="guest-grid" id="modalGrid"></div>
        <div class="modal-actions" id="modalActions"></div>
    </div>
</div>

<!-- Password Prompt Modal -->
<div class="password-modal" id="passwordModal">
    <div class="password-card">
        <h3 id="pwTitle">Пароль менеджера</h3>
        <input type="password" id="pwInput" placeholder="Введите пароль" onkeydown="if(event.key==='Enter')confirmPassword()">
        <div class="password-btns">
            <button class="pw-cancel" onclick="cancelPassword()">Отмена</button>
            <button class="pw-confirm" onclick="confirmPassword()">Подтвердить</button>
        </div>
    </div>
</div>

<!-- Scan flash overlay -->
<div class="scan-flash" id="scanFlash"></div>

<!-- Toast notification -->
<div class="scan-toast" id="scanToast"></div>

<!-- City Switcher Modal -->
<div class="modal-overlay" id="citySwitcherModal" onclick="closeCitySwitcher(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="modal-title" id="citySwitcherTitle">Выбор города</div>
        <div class="city-switcher-list" id="citySwitcherList"></div>
    </div>
</div>

<!-- QR Scanner (nimiq/qr-scanner — much better than html5-qrcode) -->
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

<script>
/* ═══════════════════════════════════════════════════════
   IMPREZA WEB SCANNER — JavaScript
   ═══════════════════════════════════════════════════════ */

// ── CONFIG ──
const API_URL = 'https://aura-tickets-api-production.up.railway.app';
// Super Admin passwords (full access to everything, can login to any city)
const SUPER_ADMIN_PASSWORDS = ['dmitryganj1995', 'ImprezaMaster2025'];

// ── STORAGE HELPER (fallback for disabled localStorage) ──
const _memoryStorage = {};
const storage = {
    _backend: null,
    _init() {
        if (this._backend) return this._backend;
        // Try localStorage first
        try {
            localStorage.setItem('__test__', '1');
            localStorage.removeItem('__test__');
            this._backend = 'localStorage';
            return this._backend;
        } catch (e) {}
        // Fallback to sessionStorage (survives F5 but not tab close)
        try {
            sessionStorage.setItem('__test__', '1');
            sessionStorage.removeItem('__test__');
            this._backend = 'sessionStorage';
            console.warn('⚠️ localStorage недоступен, используем sessionStorage');
            return this._backend;
        } catch (e) {}
        // Last resort - in-memory (only current page load)
        this._backend = 'memory';
        console.warn('⚠️ Storage недоступен, данные не сохранятся после закрытия');
        return this._backend;
    },
    getItem(key) {
        const backend = this._init();
        if (backend === 'localStorage') return localStorage.getItem(key);
        if (backend === 'sessionStorage') return sessionStorage.getItem(key);
        return _memoryStorage[key] || null;
    },
    setItem(key, value) {
        const backend = this._init();
        if (backend === 'localStorage') return localStorage.setItem(key, value);
        if (backend === 'sessionStorage') return sessionStorage.setItem(key, value);
        _memoryStorage[key] = value;
    },
    removeItem(key) {
        const backend = this._init();
        if (backend === 'localStorage') return localStorage.removeItem(key);
        if (backend === 'sessionStorage') return sessionStorage.removeItem(key);
        delete _memoryStorage[key];
    }
};

// Global Admin accounts (see ALL countries/cities, no password prompts)
const GLOBAL_ADMIN_ACCOUNTS = [
    { login: 'dmitryganj', password: 'dmitryganj1995' },
    { login: 'imprezaadmin', password: 'ImprezaMaster2025' }
];

function isGlobalAdmin(login, password) {
    return GLOBAL_ADMIN_ACCOUNTS.some(a => a.login === login && a.password === password);
}

function isCurrentUserGlobalAdmin() {
    return currentClub && currentClub.is_global_admin === true;
}

// City-country mapping (populated in buildCityMappings)
let citiesByCountry = {};

// Build city mappings from allClubs
function buildCityMappings() {
    citiesByCountry = {};
    if (!allClubs || !allClubs.length) return;
    
    allClubs.forEach(club => {
        const cc = club.country_code || 'OTHER';
        if (!citiesByCountry[cc]) citiesByCountry[cc] = [];
        citiesByCountry[cc].push({
            id: club.id,
            name: club.city_name,
            english: club.city_english
        });
    });
}

// Update admin filters visibility
function updateAdminFiltersVisibility() {
    const adminFiltersEl = document.getElementById('adminFilters');
    if (!adminFiltersEl) return;
    
    if (isCurrentUserGlobalAdmin()) {
        adminFiltersEl.style.display = 'block';
        renderAdminCountrySelect();
        renderAdminCitySelect();
    } else {
        adminFiltersEl.style.display = 'none';
    }
    
    // Show hidden tickets toggle only for super admin
    const hiddenTicketsItem = document.getElementById('hiddenTicketsItem');
    if (hiddenTicketsItem) {
        hiddenTicketsItem.style.display = isCurrentUserSuperAdmin() ? 'flex' : 'none';
    }
}

// Render country checkboxes
function renderAdminCountrySelect() {
    const container = document.getElementById('countrySelect');
    if (!container) return;
    
    const countries = Object.keys(citiesByCountry).sort();
    const selectedCountries = currentClub?.selected_countries || [];
    
    let html = '';
    countries.forEach(cc => {
        const flag = COUNTRY_FLAGS[cc] || cc;
        const isChecked = selectedCountries.includes(cc);
        html += `<label class="admin-option${isChecked ? ' selected' : ''}" onclick="toggleCountry('${cc}', event)">
            <input type="checkbox" ${isChecked ? 'checked' : ''} data-country="${cc}">
            <span>${flag}</span>
        </label>`;
    });
    
    if (!html) html = '<div style="padding:8px;opacity:0.6">Нет стран</div>';
    container.innerHTML = html;
}

// Render city checkboxes (filtered by selected countries)
function renderAdminCitySelect() {
    const container = document.getElementById('citySelect');
    if (!container) return;
    
    const selectedCountries = currentClub?.selected_countries || [];
    const selectedCities = currentClub?.selected_cities || [];
    
    let cities = [];
    if (selectedCountries.length === 0) {
        // All countries = all cities
        Object.values(citiesByCountry).forEach(arr => cities.push(...arr));
    } else {
        // Only cities from selected countries
        selectedCountries.forEach(cc => {
            if (citiesByCountry[cc]) cities.push(...citiesByCountry[cc]);
        });
    }
    
    // Sort by name
    cities.sort((a, b) => a.name.localeCompare(b.name));
    
    let html = '';
    cities.forEach(city => {
        const isChecked = selectedCities.includes(city.id);
        html += `<label class="admin-option${isChecked ? ' selected' : ''}" onclick="toggleCity(${city.id}, event)">
            <input type="checkbox" ${isChecked ? 'checked' : ''} data-city="${city.id}">
            <span>${city.name}</span>
        </label>`;
    });
    
    if (!html) html = '<div style="padding:8px;opacity:0.6">Выберите страну</div>';
    container.innerHTML = html;
}

// Toggle country selection
function toggleCountry(cc, event) {
    if (event) event.preventDefault();
    if (!currentClub) return;
    
    if (!currentClub.selected_countries) currentClub.selected_countries = [];
    
    const idx = currentClub.selected_countries.indexOf(cc);
    if (idx >= 0) {
        currentClub.selected_countries.splice(idx, 1);
    } else {
        currentClub.selected_countries.push(cc);
    }
    
    // Clear city selection when countries change
    currentClub.selected_cities = [];
    
    renderAdminCountrySelect();
    renderAdminCitySelect();
}

// Toggle city selection
function toggleCity(cityId, event) {
    if (event) event.preventDefault();
    if (!currentClub) return;
    
    if (!currentClub.selected_cities) currentClub.selected_cities = [];
    
    const idx = currentClub.selected_cities.indexOf(cityId);
    if (idx >= 0) {
        currentClub.selected_cities.splice(idx, 1);
    } else {
        currentClub.selected_cities.push(cityId);
    }
    
    renderAdminCitySelect();
}

// Apply admin filters
function applyAdminFilters() {
    closeBurger();
    saveSession();
    loadTickets();
}

// Country flags for display
const COUNTRY_FLAGS = {
    'PL':'🇵🇱 Польша', 'DE':'🇩🇪 Германия', 'NL':'🇳🇱 Нидерланды',
    'BG':'🇧🇬 Болгария', 'ES':'🇪🇸 Испания', 'CZ':'🇨🇿 Чехия',
    'LU':'🇱🇺 Люксембург', 'AT':'🇦🇹 Австрия', 'SK':'🇸🇰 Словакия',
    'LT':'🇱🇹 Литва', 'LV':'🇱🇻 Латвия', 'EE':'🇪🇪 Эстония',
    'FR':'🇫🇷 Франция', 'GB':'🇬🇧 UK', 'PT':'🇵🇹 Португалия', 'US':'🇺🇸 США'
};

// All passwords that unlock any protected action (+/-, mass, status change)
const ALL_VALID_PASSWORDS = [
    ...SUPER_ADMIN_PASSWORDS,
    'KatyaBG2025!',    // Manager Катя (BG, NL, DE)
    'FedorPL2025!',    // Manager Фёдор (PL)
    'Coffee!8Night'    // Legacy manager
];

function isValidActionPassword(pw) { return ALL_VALID_PASSWORDS.includes(pw); }
function isSuperAdmin(pw) { return SUPER_ADMIN_PASSWORDS.includes(pw); }

// Hidden tickets toggle (only for super admin)
let showHiddenTickets = false;

function isCurrentUserSuperAdmin() {
    return currentClub && currentClub.is_super_admin === true;
}

function toggleHiddenTickets() {
    showHiddenTickets = !showHiddenTickets;
    const toggle = document.getElementById('hiddenTicketsToggle');
    if (toggle) toggle.classList.toggle('active', showHiddenTickets);
    loadTickets();
    closeBurger();
}

// ── UTILITY FUNCTIONS ──
function normalizePhone(phone) {
    if (!phone) return '';
    return phone.replace(/\D/g, '');
}

function isPhoneSearch(text) {
    if (!text || text.length < 3) return false;
    const digits = text.replace(/\D/g, '').length;
    return digits >= 3 && digits / text.length > 0.4;
}

function vibrate(pattern = [10]) {
    if (navigator.vibrate) {
        navigator.vibrate(pattern);
    }
}

// ── STATE ──
let currentClub = null;      // { id, city_name, city_english, country_code, login }
let allTickets = [];
let filteredTickets = [];
let historyFilterMode = 'all';
let selectedEventDate = null;
let qrScanner = null;
let cameraActive = false;
let cameraFacing = 'environment'; // 'environment' = back, 'user' = front
let lastScanTime = 0;
let scanCooldown = 1500;      // 1.5 sec between scans
let passwordCallback = null;
let audioCtx = null;  // Web Audio API context for scan sounds
let selectedTickets = new Set();  // Set of order_ids for mass actions
let allClubs = [];            // All clubs from API (for city switcher)
let currentSessionPassword = ''; // Saved password for city switcher
let scanEnabled = false;      // Single-scan mode: true = waiting for one QR

// ── SVG ICONS (Lucide-style) ──
const ICONS = {
    checkCircle: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>',
    alertCircle: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    xCircle: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>',
    shieldX: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m14.5 9.5-5 5"/><path d="m9.5 9.5 5 5"/></svg>',
    mapPin: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    sun: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>',
    moon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>',
    refreshCw: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>',
    ticket: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>',
    inbox: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>',
    logOut: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
};

// ── THEME ──
function getTheme() { return storage.getItem('impreza_theme') || 'dark'; }

function setTheme(theme) {
    if (theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
    } else {
        document.documentElement.removeAttribute('data-theme');
    }
    storage.setItem('impreza_theme', theme);
    updateThemeIcons(theme);
}

function toggleTheme() {
    setTheme(getTheme() === 'dark' ? 'light' : 'dark');
}

function updateThemeIcons(theme) {
    const icon = theme === 'dark' ? ICONS.sun : ICONS.moon;
    document.querySelectorAll('.theme-toggle').forEach(btn => { btn.innerHTML = icon; });
}

// Init theme immediately (before DOMContentLoaded)
(function() {
    const t = storage.getItem('impreza_theme') || 'dark';
    if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
})();

// ── CITY MAPPING (same as desktop) ──
const CITY_RU_TO_EN = {
    'варшава':'warsaw','краков':'krakow','вроцлав':'wroclaw','гданьск':'gdansk',
    'люблин':'lublin','катовице':'katowice','амстердам':'amsterdam','роттердам':'rotterdam',
    'берлин':'berlin','мюнхен':'munich','франкфурт':'frankfurt','прага':'prague',
    'софия':'sofia','барселона':'barcelona',
    'ченстохова':'czestochowa','быдгощ':'bydgoszcz','легница':'legnica',
    'эссен':'essen','висбаден':'wiesbaden','карлсруэ':'karlsruhe',
    'лейпциг':'leipzig','штутгарт':'stuttgart','фрайбург':'freiburg',
    'ганновер':'hannover','дюссельдорф':'dusseldorf','дрезден':'dresden',
    'кёльн':'cologne','кельн':'cologne','хамельн':'hameln','майнц':'mainz','ахен':'aachen',
    'лейден':'leiden','бреда':'breda','гаага':'denhaag',
    'маастрихт':'maastricht','тилбург':'tilburg','эйндховен':'eindhoven',
    'гронинген':'groningen','хертогенбос':'hertogenbosch',
    'варна':'varna','несебр':'nesebar','пловдив':'plovdiv','бургас':'burgas',
    'брно':'brno','острава':'ostrava','валенсия':'valencia',
    'люксембург':'luxembourg',
    'вена':'vienna','инсбрук':'innsbruck',
    'братислава':'bratislava',
    'вильнюс':'vilnius','каунас':'kaunas',
    'рига':'riga','таллин':'tallinn','таллинн':'tallinn',
    'париж':'paris','лион':'lyon','марсель':'marseille','страсбург':'strasbourg',
    'нью-йорк':'newyork','майами':'miami','лос-анджелес':'losangeles','чикаго':'chicago',
    'лиссабон':'lisbon','порту':'porto',
    'лондон':'london','манчестер':'manchester','бирмингем':'birmingham'
};

function normalizeCityForComparison(city) {
    if (!city) return '';
    const lower = city.toLowerCase().replace(/[\s\-]+$/, '');
    return CITY_RU_TO_EN[lower] || lower;
}

// ── RU→EN KEYBOARD FIX ──
const RU_EN_MAP = {'й':'q','ц':'w','у':'e','к':'r','е':'t','н':'y','г':'u','ш':'i','щ':'o','з':'p','х':'[','ъ':']','ф':'a','ы':'s','в':'d','а':'f','п':'g','р':'h','о':'j','л':'k','д':'l','ж':';','э':"'",'я':'z','ч':'x','с':'c','м':'v','и':'b','т':'n','ь':'m','б':',','ю':'.'};
function fixKeyboardLayout(text) {
    return text.split('').map(c => RU_EN_MAP[c] || RU_EN_MAP[c.toLowerCase()]?.toUpperCase() || c).join('');
}

// ══════════════════════════════════════════════
// SHA-256 HASH (for password checking)
// ══════════════════════════════════════════════
async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

// ══════════════════════════════════════════════
// LOGIN
// ══════════════════════════════════════════════
async function doLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const errorEl = document.getElementById('loginError');
    const btn = document.getElementById('loginBtn');

    console.log('Login attempt:', { username, password, isGlobal: isGlobalAdmin(username, password) });

    if (!username || !password) { errorEl.textContent = 'Введите логин и пароль'; return; }

    btn.disabled = true;
    btn.textContent = 'Подключение...';
    errorEl.textContent = '';

    try {
        const passwordHash = await sha256(password);
        const res = await fetch(`${API_URL}/clubs`, { signal: AbortSignal.timeout(15000) });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);

        const data = await res.json();
        const clubs = data.clubs || [];

        // Check master password (Super Admins can login to any city)
        const isMaster = isSuperAdmin(password);
        
        // Check for Global Admin account (sees ALL cities)
        const isGlobalAdminUser = isGlobalAdmin(username, password);
        
        if (isGlobalAdminUser) {
            // Global admin - can see everything
            allClubs = clubs; // Save for filters
            currentClub = {
                id: 0,
                city_name: 'Все города',
                city_english: 'all',
                country_code: 'ALL',
                login: username,
                is_admin: true,
                is_global_admin: true,
                is_super_admin: isMaster, // Track if this is super admin
                selected_countries: [],
                selected_cities: []
            };
            currentSessionPassword = password;
            
            storage.setItem('impreza_session', JSON.stringify({
                club: currentClub,
                password: password,
                timestamp: Date.now()
            }));
            
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.add('active');
            document.getElementById('topCity').textContent = 'Все города';
            
            buildCityMappings();
            updateAdminFiltersVisibility();
            restoreActiveTab();
            await loadTickets();
            setTimeout(() => startCamera(), 500);
            setInterval(loadTickets, 30000);
            setInterval(checkConnection, 10000);
            startClock();
            
            btn.disabled = false;
            btn.textContent = 'ВОЙТИ';
            return;
        }

        let foundClub = null;
        for (const club of clubs) {
            if (club.login === username) {
                if (passwordHash === club.password_hash || isMaster) {
                    foundClub = club;
                    break;
                }
            }
        }

        if (!foundClub) {
            errorEl.textContent = 'Неверный логин или пароль';
            // Shake animation
            const card = document.querySelector('.login-card');
            card.classList.add('shake');
            setTimeout(() => card.classList.remove('shake'), 600);
            btn.disabled = false;
            btn.textContent = 'ВОЙТИ';
            return;
        }

        // Save club data
        allClubs = clubs; // Save for city switcher
        currentClub = {
            id: foundClub.id,
            city_name: foundClub.city_name,
            city_english: foundClub.city_english || foundClub.city_name,
            country_code: foundClub.country_code,
            login: username,
            is_admin: isMaster || foundClub.role === 'admin',
            is_global_admin: false,
            is_super_admin: false
        };
        currentSessionPassword = password;

        // Save session to storage (persist across page reload)
        storage.setItem('impreza_session', JSON.stringify({
            club: currentClub,
            password: password,
            timestamp: Date.now()
        }));

        console.log('Logged in:', currentClub);

        // Switch to main screen
        document.getElementById('loginScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        document.getElementById('topCity').textContent = currentClub.city_name;
        
        // Restore active tab from previous session
        restoreActiveTab();

        // Load data
        await loadTickets();

        // Auto-start camera
        setTimeout(() => startCamera(), 500);

        // Start auto-refresh
        setInterval(loadTickets, 30000);
        setInterval(checkConnection, 10000);
        startClock();

    } catch (err) {
        console.error('Login error:', err);
        if (err.name === 'TimeoutError') errorEl.textContent = 'Таймаут сервера, попробуйте ещё';
        else errorEl.textContent = `Ошибка соединения: ${err.message}`;
    }

    btn.disabled = false;
    btn.textContent = 'ВОЙТИ';
}

// Enter key on password field
document.getElementById('loginPassword')?.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

function doLogout() {
    stopCamera();
    currentClub = null;
    allTickets = [];
    filteredTickets = [];
    selectedTickets.clear();
    currentSessionPassword = '';
    allClubs = [];
    
    // Clear admin filter selections
    citiesByCountry = {};
    cityById = {};
    
    // Hide admin filters panel
    const adminFiltersEl = document.getElementById('adminFilters');
    if (adminFiltersEl) adminFiltersEl.style.display = 'none';
    
    // Clear saved session and tab preference
    storage.removeItem('impreza_session');
    storage.removeItem('impreza_active_tab');
    
    // Reset to scanner tab
    switchTab('scanner');
    
    document.getElementById('mainScreen').classList.remove('active');
    document.getElementById('loginScreen').classList.add('active');
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').textContent = '';
}

// ══════════════════════════════════════════════
// QR PARSING (client-side, same as desktop)
// ══════════════════════════════════════════════
function parseQR(qrData) {
    const parts = qrData.split('|');
    if (parts[0] !== 'AURA') return null;

    const version = parts[1] || '1';

    // V2: 15 fields
    if (version === '2' && parts.length >= 15) {
        return {
            order_id: parts[2], ticket_type: parts[3], event_date: parts[4],
            name: parts[5], email: parts[6], phone: parts[7], price: parts[8],
            quantity: parseInt(parts[9]) || 1,
            unique_token: parts[11], city: parts[12], country: parts[13],
            signature: parts[14]
        };
    }
    // V1: 14 fields
    if (parts.length >= 14) {
        return {
            order_id: parts[2], ticket_type: parts[3], event_date: parts[4],
            name: parts[5], email: parts[6], phone: parts[7], price: parts[8],
            quantity: 1,
            unique_token: parts[10], city: parts[11], country: parts[12],
            signature: parts[13]
        };
    }
    // Old: 12 fields
    if (parts.length >= 12) {
        return {
            order_id: parts[2], ticket_type: parts[3], event_date: parts[4],
            name: parts[5], email: parts[6], phone: parts[7], price: parts[8],
            quantity: 1,
            unique_token: parts[10], city: '', country: '',
            signature: parts[11]
        };
    }
    return null;
}

// ══════════════════════════════════════════════
// QR SCANNING VIA CAMERA
// ══════════════════════════════════════════════
async function toggleCamera() {
    if (cameraActive) {
        stopCamera();
    } else {
        await startCamera();
    }
}

async function startCamera() {
    try {
        const videoEl = document.getElementById('scannerVideo');

        // If scanner already exists, just start it (no permission re-request)
        if (qrScanner) {
            await qrScanner.start();
        } else {
            // Set worker path for qr-scanner
            QrScanner.WORKER_PATH = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner-worker.min.js';

            // Create new QrScanner instance (only once)
            qrScanner = new QrScanner(
                videoEl,
                result => {
                    const text = typeof result === 'string' ? result : result.data;
                    onQRCodeScanned(text);
                },
                {
                    preferredCamera: cameraFacing === 'environment' ? 'environment' : 'user',
                    highlightScanRegion: false,
                    highlightCodeOutline: false,
                    maxScansPerSecond: 8,
                    returnDetailedScanResult: true,
                }
            );

            await qrScanner.start();
        }

        // Enable autofocus if available
        setTimeout(() => {
            try {
                const track = videoEl.srcObject?.getVideoTracks()[0];
                const caps = track?.getCapabilities?.() || {};
                if (caps.focusMode?.includes('continuous')) {
                    track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                }
            } catch (e) { /* ignore */ }
        }, 600);

        cameraActive = true;
        scanEnabled = false;
        document.getElementById('scanOverlay').style.display = '';
        // Update camera button to STOP state (icon-only)
        const camBtn = document.getElementById('btnCamStart');
        camBtn.classList.remove('cam-ready');
        camBtn.classList.add('cam-active');
        camBtn.title = 'Остановить камеру';
        document.getElementById('camIconPlay').style.display = 'none';
        document.getElementById('camIconStop').style.display = '';
        // Show SCAN button
        document.getElementById('scanBtnWrapper')?.classList.add('visible');
        setScanButtonState('ready');
        console.log('Камера запущена');
    } catch (err) {
        console.error('Ошибка камеры:', err);
        alert('Ошибка камеры: ' + err.message + '\n\nРазрешите доступ к камере.');
    }
}

function stopCamera() {
    if (qrScanner) {
        qrScanner.stop();
        cameraActive = false;
        scanEnabled = false;
        document.getElementById('scanOverlay').style.display = 'none';
        // Update camera button to START state (icon-only)
        const camBtn = document.getElementById('btnCamStart');
        camBtn.classList.remove('cam-active');
        camBtn.classList.add('cam-ready');
        camBtn.title = 'Запустить камеру';
        document.getElementById('camIconPlay').style.display = '';
        document.getElementById('camIconStop').style.display = 'none';
        // Hide SCAN button
        document.getElementById('scanBtnWrapper')?.classList.remove('visible');
        document.querySelector('.scan-line')?.classList.remove('active');
    }
}

async function switchCameraFacing() {
    // Animate the switch button
    const switchBtn = document.getElementById('btnCamSwitch');
    if (switchBtn) {
        switchBtn.classList.add('rotating');
        setTimeout(() => switchBtn.classList.remove('rotating'), 300);
    }
    
    cameraFacing = cameraFacing === 'environment' ? 'user' : 'environment';
    if (qrScanner && cameraActive) {
        try {
            // Try to find a camera with the desired facing mode
            const cameras = await QrScanner.listCameras(true);
            if (cameras.length > 1) {
                // Toggle between first and second camera
                const currentCamera = cameraFacing === 'environment' ? 'environment' : 'user';
                await qrScanner.setCamera(currentCamera);
            }
        } catch (e) {
            // Fallback: restart with new facing
            stopCamera();
            await startCamera();
        }
    }
}

// ══════════════════════════════════════════════
// SOUND & VISUAL FEEDBACK
// ══════════════════════════════════════════════
function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playBeep(freq, duration, type = 'sine', volume = 0.6) {
    try {
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    } catch(e) { console.log('Audio error:', e); }
}

function playScanSound(status) {
    switch(status) {
        case 'valid':
            playBeep(880, 0.15, 'sine', 0.7);
            setTimeout(() => playBeep(1320, 0.25, 'sine', 0.7), 150);
            break;
        case 'used':
            playBeep(440, 0.2, 'square', 0.5);
            setTimeout(() => playBeep(330, 0.3, 'square', 0.5), 200);
            break;
        case 'invalid': case 'denied':
            playBeep(220, 0.15, 'sawtooth', 0.6);
            setTimeout(() => playBeep(180, 0.15, 'sawtooth', 0.6), 150);
            setTimeout(() => playBeep(150, 0.4, 'sawtooth', 0.6), 300);
            break;
    }
}

function flashScreen(status) {
    const flash = document.getElementById('scanFlash');
    flash.className = 'scan-flash';
    const colorMap = { valid: 'flash-green', used: 'flash-yellow', invalid: 'flash-red', denied: 'flash-red' };
    flash.classList.add(colorMap[status] || 'flash-red');
    setTimeout(() => { flash.className = 'scan-flash'; }, 400);
}

// ── SINGLE-SCAN MODE ──
function activateScan() {
    if (!cameraActive) return; // camera must be on
    
    // Toggle scan mode - if already scanning, stop it
    if (scanEnabled) {
        cancelScan();
        return;
    }
    
    scanEnabled = true;
    setScanButtonState('scanning');
    // Activate scan line animation
    document.querySelector('.scan-line')?.classList.add('active');
}

function cancelScan() {
    scanEnabled = false;
    setScanButtonState('ready');
    document.querySelector('.scan-line')?.classList.remove('active');
}

function setScanButtonState(state) {
    const btn = document.getElementById('scanBtn');
    const text = document.getElementById('scanBtnText');
    if (!btn || !text) return;

    btn.className = 'scan-btn';
    btn.disabled = false;

    switch (state) {
        case 'ready':
            btn.classList.add('scan-ready');
            text.textContent = 'SCAN';
            break;
        case 'scanning':
            btn.classList.add('scan-active');
            text.textContent = 'STOP';
            break;
        case 'processing':
            btn.classList.add('scan-processing');
            text.textContent = 'PROCESSING...';
            btn.disabled = true;
            break;
    }
}

// ── QR SCAN HANDLER ──
function onQRCodeScanned(decodedText) {
    // Single-scan gate: ignore if scan not activated
    if (!scanEnabled) return;

    // Immediately disable to prevent double-scan
    scanEnabled = false;
    setScanButtonState('processing');
    // Deactivate scan line animation
    document.querySelector('.scan-line')?.classList.remove('active');

    // Cooldown to prevent rapid duplicate scans
    const now = Date.now();
    if (now - lastScanTime < scanCooldown) {
        setScanButtonState('ready');
        return;
    }
    lastScanTime = now;

    console.log('Scanned:', decodedText.substring(0, 50) + '...');

    // Vibrate on scan (mobile)
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

    let qrData = decodedText.trim();

    // Fix Russian keyboard layout
    if (!qrData.startsWith('AURA')) {
        const fixed = fixKeyboardLayout(qrData);
        if (fixed.startsWith('AURA')) {
            console.log('Auto-fixed keyboard layout');
            qrData = fixed;
        }
    }

    // Fire-and-forget
    verifyTicket(qrData).catch(err => console.error('Verify error:', err));
}

// ══════════════════════════════════════════════
// TICKET VERIFICATION
// ══════════════════════════════════════════════
async function verifyTicket(qrData) {
    // 1. Parse QR locally
    const parsed = parseQR(qrData);

    if (!parsed) {
        showStatus('invalid', 'ДОСТУП ЗАПРЕЩЁН', 'Неверный QR-код');
        playScanSound('invalid');
        flashScreen('invalid');
        setScanButtonState('ready');
        return;
    }

    // 2. Pre-check: CITY (before calling API to avoid incrementing scan_count)
    // SKIP city check for global admins - they can scan tickets from ANY city
    if (currentClub?.city_english && !currentClub?.is_global_admin) {
        const qrCity = normalizeCityForComparison(parsed.city);
        const filterCity = normalizeCityForComparison(currentClub.city_english);
        if (qrCity && filterCity && qrCity !== filterCity) {
            showStatus('denied', 'ДОСТУП ЗАПРЕЩЁН', `Билет для ${parsed.city}, не ${currentClub.city_name}`);
            playScanSound('denied');
            flashScreen('denied');
            updateGuestInfo(parsed);
            logDenied(parsed.order_id, `Wrong city: ${parsed.city} vs ${currentClub.city_name}`);
            setScanButtonState('ready');
            return;
        }
    }

    // 3. Pre-check: DATE (if event filter is active)
    if (selectedEventDate) {
        const qrDate = (parsed.event_date || '').trim();
        if (qrDate && qrDate !== selectedEventDate) {
            showStatus('denied', 'ДОСТУП ЗАПРЕЩЁН', `Билет на ${qrDate}, выбрано: ${selectedEventDate}`);
            playScanSound('denied');
            flashScreen('denied');
            updateGuestInfo(parsed);
            logDenied(parsed.order_id, `Wrong date: ${qrDate} vs ${selectedEventDate}`);
            setScanButtonState('ready');
            return;
        }
    }

    // 4. Verify via API
    try {
        const res = await fetch(`${API_URL}/api/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qr_data: qrData, scanner_id: 'web_scanner' }),
            signal: AbortSignal.timeout(15000)
        });

        const result = await res.json();
        console.log('API result:', result);

        const apiData = result.data || {};
        const merged = {
            name: apiData.name || parsed.name || '',
            order_id: parsed.order_id,
            phone: apiData.phone || parsed.phone || '',
            email: apiData.email || parsed.email || '',
            ticket_type: apiData.ticket_type || parsed.ticket_type || 'Standard',
            price: apiData.price || parsed.price || '',
            event_date: apiData.event_date || parsed.event_date || '',
            quantity: apiData.quantity || parsed.quantity || 1,
            scan_count: apiData.scan_count || 0,
            city: parsed.city || '',
        };

        let scanStatus;
        if (result.status === 'valid') {
            const remaining = merged.quantity - merged.scan_count;
            const subtitle = merged.quantity > 1
                ? `Вход ${merged.scan_count}/${merged.quantity} — ${merged.name} (осталось: ${remaining})`
                : `Добро пожаловать, ${merged.name}`;
            showStatus('valid', 'ДОСТУП РАЗРЕШЁН', subtitle);
            scanStatus = 'valid';
        } else if (result.status === 'used') {
            showStatus('used', 'УЖЕ ИСПОЛЬЗОВАН', `Первый вход: ${apiData.used_at || ''}`);
            scanStatus = 'used';
        } else {
            showStatus('invalid', 'ДОСТУП ЗАПРЕЩЁН', result.message || 'Неверный билет');
            scanStatus = 'invalid';
        }

        // Sound + flash feedback
        playScanSound(scanStatus);
        flashScreen(scanStatus);

        // Toast notification if on History tab
        const isOnHistory = document.getElementById('tabHistory')?.classList.contains('active');
        if (isOnHistory) {
            const toastMsg = scanStatus === 'valid' ? `${merged.name} — ДОСТУП РАЗРЕШЁН`
                           : scanStatus === 'used' ? `${merged.name} — УЖЕ ИСПОЛЬЗОВАН`
                           : `${merged.name || parsed.order_id} — ОТКАЗ`;
            showScanToast(scanStatus, toastMsg);
        }

        updateGuestInfo(merged);

    } catch (err) {
        console.error('Verify error:', err);
        showStatus('invalid', 'ОШИБКА', 'Ошибка соединения — проверьте интернет');
        playScanSound('invalid');
        flashScreen('invalid');
        updateGuestInfo(parsed);
    }

    // Return SCAN button to ready state
    setScanButtonState('ready');

    // Reload tickets after scan
    setTimeout(loadTickets, 1000);
}

async function logDenied(orderId, reason) {
    try {
        await fetch(`${API_URL}/api/log-denied`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                order_id: orderId,
                reason: reason,
                scanner_id: 'web_scanner',
                club_id: currentClub?.id
            })
        });
    } catch (e) { console.error('Log denied error:', e); }
}

// ══════════════════════════════════════════════
// STATUS DISPLAY
// ══════════════════════════════════════════════
function showStatus(status, text, subtitle) {
    const card = document.getElementById('statusCard');
    const iconEl = document.getElementById('statusIcon');
    const textEl = document.getElementById('statusText');
    const subEl = document.getElementById('statusSubtitle');

    card.className = 'status-card ' + (status === 'denied' ? 'invalid' : status);
    
    // Remove waiting animation class and set proper SVG icon
    iconEl.classList.remove('status-icon--waiting');
    
    const iconsSvg = { valid: ICONS.checkCircle, used: ICONS.alertCircle, invalid: ICONS.xCircle, denied: ICONS.shieldX };
    iconEl.innerHTML = iconsSvg[status] || '?';

    const colors = { valid: '#10B981', used: '#F59E0B', invalid: '#EF4444', denied: '#EF4444' };
    iconEl.style.color = colors[status] || '#FFF';
    textEl.style.color = colors[status] || '#FFF';

    textEl.textContent = text;
    subEl.textContent = subtitle;
    subEl.style.color = colors[status] ? colors[status] + 'CC' : 'var(--text-secondary)';
}

function updateGuestInfo(data) {
    const set = (id, val) => { document.getElementById(id).textContent = val || '—'; };
    set('gName', data.name);
    set('gOrder', data.order_id ? '#' + data.order_id : '—');
    set('gPhone', data.phone);
    set('gEmail', data.email);
    set('gTicket', data.ticket_type || 'Standard');
    const price = data.price && data.price !== '0' ? `${data.price} EUR` : 'Бесплатно';
    set('gPrice', price);
    // Promo code
    set('gPromo', data.promo_code || data.promocode || data.coupon || '—');
    const eventName = data.event_date && data.city ? `${data.event_date} - ${data.city}` : data.event_date || '—';
    set('gEvent', eventName);
    
    // Auto-expand guest info panel when data arrives (Task 7)
    const panel = document.getElementById('guestInfoPanel');
    if (panel && data.name) {
        setTimeout(() => panel.classList.add('open'), 100); // Small delay to avoid layout shift during scan
    }

    const q = parseInt(data.quantity) || 1;
    const sc = parseInt(data.scan_count) || 0;
    let entries;
    if (q > 1) {
        entries = sc > q ? `${sc}/${q} (превышен лимит)` : sc === q ? `${sc}/${q} (все вошли)` : sc > 0 ? `${sc}/${q} (осталось: ${q - sc})` : `0/${q} (ожидание)`;
    } else {
        entries = sc > 1 ? `${sc}/1 (превышен)` : sc === 1 ? `1/1 (использован)` : `0/1 (ожидание)`;
    }
    set('gEntries', entries);
}

// ══════════════════════════════════════════════
// LOAD TICKETS
// ══════════════════════════════════════════════
async function loadTickets() {
    if (!currentClub) return;

    try {
        const params = new URLSearchParams({ limit: '10000' });
        
        // For global admin: load all tickets (no club_id), then filter client-side
        // For regular users: filter by club_id
        if (!isCurrentUserGlobalAdmin() && currentClub.id) {
            params.set('club_id', currentClub.id);
        }
        
        // Super admin can see hidden tickets if toggle is enabled
        if (isCurrentUserSuperAdmin() && showHiddenTickets) {
            params.set('include_hidden', 'true');
        }

        const res = await fetch(`${API_URL}/api/tickets/?${params}`, { signal: AbortSignal.timeout(15000) });
        if (!res.ok) return;

        const data = await res.json();
        let tickets = data.tickets || [];
        
        // Global admin: apply country/city filters on client side
        if (isCurrentUserGlobalAdmin()) {
            const selectedCountries = currentClub.selected_countries || [];
            const selectedCities = currentClub.selected_cities || [];
            
            if (selectedCities.length > 0) {
                // Filter by selected cities
                tickets = tickets.filter(t => selectedCities.includes(t.club_id));
            } else if (selectedCountries.length > 0) {
                // Filter by countries (get all city IDs from selected countries)
                const cityIds = [];
                selectedCountries.forEach(cc => {
                    if (citiesByCountry[cc]) {
                        citiesByCountry[cc].forEach(city => cityIds.push(city.id));
                    }
                });
                tickets = tickets.filter(t => cityIds.includes(t.club_id));
            }
            // If no filters selected, show all tickets
        }
        
        allTickets = tickets;

        populateEventFilter();
        applyEventFilter();
        renderHistory();
        updateBottomStats();

        console.log(`Loaded ${allTickets.length} tickets`);
    } catch (err) {
        console.error('Load tickets error:', err);
    }
}

async function refreshWithIndicator() {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('spinning');
    btn.disabled = true;
    await loadTickets();
    btn.classList.remove('spinning');
    btn.disabled = false;
}

// ══════════════════════════════════════════════
// EVENT FILTER
// ══════════════════════════════════════════════
function populateEventFilter() {
    const select = document.getElementById('eventFilter');
    const currentVal = select.value;
    
    // Load saved event from localStorage (priority over current HTML value)
    const savedEvent = loadUIState('selectedEvent', null);

    const events = new Set();
    allTickets.forEach(t => {
        const name = t.event_name || t.event_title || '';
        if (name.trim()) events.add(name.trim());
    });

    // Sort by date
    const sorted = [...events].sort((a, b) => {
        const da = a.match(/^(\d+)\.(\d+)/);
        const db = b.match(/^(\d+)\.(\d+)/);
        if (da && db) return (parseInt(db[2]) * 100 + parseInt(db[1])) - (parseInt(da[2]) * 100 + parseInt(da[1]));
        return a.localeCompare(b);
    });

    select.innerHTML = '<option value="ALL">Все события</option>';
    sorted.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e;
        opt.textContent = e;
        select.appendChild(opt);
    });

    // Restore selection: prefer localStorage, then current HTML value
    const valueToRestore = savedEvent || currentVal;
    if (valueToRestore && valueToRestore !== 'ALL' && select.querySelector(`option[value="${CSS.escape(valueToRestore)}"]`)) {
        select.value = valueToRestore;
        console.log('📅 Восстановлен фильтр:', valueToRestore);
    }
}

function applyEventFilter() {
    const selected = document.getElementById('eventFilter').value;

    if (selected === 'ALL') {
        filteredTickets = [...allTickets];
        selectedEventDate = null;
    } else {
        filteredTickets = allTickets.filter(t => (t.event_name || t.event_title || '').trim() === selected);
        // Extract date from event name: "31.01 - Warsaw" → "31.01"
        const match = selected.match(/^(\d{1,2}\.\d{2})/);
        selectedEventDate = match ? match[1] : null;
    }

    // Save selected event to localStorage
    saveUIState('selectedEvent', selected);

    console.log(`Event filter: ${selected}, date: ${selectedEventDate}, tickets: ${filteredTickets.length}`);
    renderHistory();
    updateBottomStats();
}

// ══════════════════════════════════════════════
// HISTORY RENDERING
// ══════════════════════════════════════════════
function getDisplayStatus(ticket) {
    const status = ticket.status || 'valid';
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;

    if (status === 'cancelled') return 'invalid';
    if (sc > q) return 'duplicate';
    if (sc > 0) return 'entered';
    return 'pending';
}

function renderHistory() {
    const list = document.getElementById('historyList');
    const searchText = (document.getElementById('historySearch')?.value || '').trim();
    const searchLower = searchText.toLowerCase();

    let tickets = filteredTickets;

    // Search filter (name, phone, email, order, event, price)
    if (searchText) {
        const searchNormalized = normalizePhone(searchText);
        const isPhone = isPhoneSearch(searchText);
        
        tickets = tickets.filter(t => {
            const name = (t.customer_name || '').toLowerCase();
            const email = (t.customer_email || '').toLowerCase();
            const phone = t.customer_phone || '';
            const phoneNormalized = normalizePhone(phone);
            const order = (t.order_id || '').toLowerCase();
            const event = (t.event_name || t.event_title || '').toLowerCase();
            const price = String(t.price || '').toLowerCase();
            const ticketType = (t.ticket_type || '').toLowerCase();
            
            // Phone search with normalization
            const phoneMatch = isPhone && searchNormalized.length >= 3 && phoneNormalized.includes(searchNormalized);
            
            // Text search
            const textMatch = name.includes(searchLower) || 
                              email.includes(searchLower) || 
                              phone.toLowerCase().includes(searchLower) || 
                              order.includes(searchLower) || 
                              event.includes(searchLower) || 
                              price.includes(searchLower) || 
                              ticketType.includes(searchLower);
            
            return phoneMatch || textMatch;
        });
    }

    // Status filter
    if (historyFilterMode !== 'all') {
        tickets = tickets.filter(t => getDisplayStatus(t) === historyFilterMode);
    }

    // Stats — считаем ЛЮДЕЙ, не билеты (БАГ 4)
    let totalPeople = 0;
    let enteredPeople = 0;
    let pendingPeople = 0;
    
    filteredTickets.forEach(t => {
        const q = t.quantity || 1;
        const sc = t.scan_count || 0;
        totalPeople += q;
        enteredPeople += Math.min(sc, q);
        pendingPeople += Math.max(0, q - sc);
    });
    
    // Обновить metrics-bar
    const metricTotal = document.getElementById('metricTotal');
    const metricEntered = document.getElementById('metricEntered');
    const metricPending = document.getElementById('metricPending');
    if (metricTotal) metricTotal.textContent = totalPeople;
    if (metricEntered) metricEntered.textContent = enteredPeople;
    if (metricPending) metricPending.textContent = pendingPeople;
    
    // Обновить progress bar
    updateMetricsProgress();

    // Render
    if (tickets.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${ICONS.inbox}</div><div class="empty-state-text">Билеты не найдены</div></div>`;
        return;
    }

    const statusIcons = {
        entered: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 12 2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>',
        duplicate: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
        pending: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>',
        invalid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>'
    };
    
    const statusConfig = {
        entered:   { icon: statusIcons.entered, cls: 'entered' },
        duplicate: { icon: statusIcons.duplicate, cls: 'duplicate' },
        pending:   { icon: statusIcons.pending, cls: 'pending' },
        invalid:   { icon: statusIcons.invalid, cls: 'invalid' }
    };

    let html = '';
    const showEventOnEachCard = true; // Always show event info on cards
    
    // Helper to get city name from club_id
    function getCityName(clubId) {
        if (!clubId || !allClubs) return '';
        const club = allClubs.find(c => c.id === clubId);
        return club ? (club.city_english || club.city_name || '') : '';
    }
    
    // Helper to extract date from event name (format: "DD.MM" or "DD.MM.YYYY")
    function extractEventDate(eventName) {
        if (!eventName) return '';
        const match = eventName.match(/(\d{2}\.\d{2}(?:\.\d{2,4})?)/); 
        return match ? match[1] : '';
    }
    
    tickets.slice(0, 200).forEach(t => {
        const ds = getDisplayStatus(t);
        const cfg = statusConfig[ds] || statusConfig.pending;
        const name = t.customer_name || 'Неизвестно';
        const phone = t.customer_phone || t.phone || '';
        const email = t.customer_email || t.email || '';
        const sc = t.scan_count || 0;
        const q = t.quantity || 1;
        const scansClass = sc >= q ? 'scans-full' : (sc > 0 ? 'scans-partial' : 'scans-none');
        const price = t.price && t.price != 0 ? `${parseFloat(t.price).toFixed(0)}€` : 'БЕСПЛАТНО';
        const event = t.event_name || t.event_title || '';
        const oid = t.order_id || '';
        const isChecked = selectedTickets.has(oid);
        const minusDisabled = sc <= 0 ? 'disabled' : '';
        const plusDisabled = sc >= q ? 'disabled' : '';

        let timeStr = '—';
        if (t.first_scan_at) {
            try {
                const dt = new Date(t.first_scan_at);
                timeStr = dt.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            } catch(e) {}
        }
        
        // Build meta line: phone · time · event info
        let metaParts = [];
        if (phone) metaParts.push(escapeHtml(phone));
        metaParts.push(timeStr);
        if (showEventOnEachCard) {
            // Build event info: date · city · event_name
            const eventDate = extractEventDate(event);
            const cityName = getCityName(t.club_id);
            
            // Combine: prefer showing date and city if available
            let eventInfo = '';
            if (eventDate) eventInfo += eventDate;
            if (cityName) eventInfo += (eventInfo ? ' · ' : '') + cityName;
            if (event) {
                // Remove date from event name if we're showing it separately
                let cleanEvent = event.replace(/^\d{2}\.\d{2}(?:\.\d{2,4})?\s*[-–]?\s*/i, '').trim();
                if (!cleanEvent) cleanEvent = event; // fallback to original
                // Truncate long event names
                const shortEvent = cleanEvent.length > 22 ? cleanEvent.substring(0, 22) + '…' : cleanEvent;
                eventInfo += (eventInfo ? ' · ' : '') + shortEvent;
            }
            if (eventInfo) {
                metaParts.push(`<span class="hi-event">${escapeHtml(eventInfo)}</span>`);
            }
        }
        const metaLine = metaParts.join(' · ');
        
        // Determine button states
        const admitBtnClass = sc >= q ? 'done' : '';

        // Build badges for promo and hidden status
        let badges = '';
        const promoCode = t.promo_code || t.promocode || t.coupon || '';
        if (promoCode) {
            badges += `<span class="hi-badge hi-badge-promo" title="${escapeHtml(promoCode)}">🎁</span>`;
        }
        const isHidden = t.visible_to_managers === false;
        if (isHidden && showHiddenTickets) {
            badges += `<span class="hi-badge hi-badge-hidden" title="Скрытый билет">👁️‍🗨️</span>`;
        }
        
        // Card class with hidden modifier
        const cardClass = `history-item${isChecked ? ' selected' : ''}${isHidden ? ' hidden-ticket' : ''}`;

        html += `
        <div class="${cardClass}" onclick='openTicketModal(${JSON.stringify(t).replace(/'/g, "&#39;")})'>
            <div class="hi-checkbox-wrapper" data-status="${cfg.cls}" onclick="event.stopPropagation(); toggleTicketSelect('${escapeHtml(oid)}')">
                <input type="checkbox" class="hi-checkbox" ${isChecked ? 'checked' : ''} />
            </div>
            <div class="hi-info">
                <div class="hi-name">${escapeHtml(name)}${badges}</div>
                <div class="hi-meta">${metaLine}</div>
            </div>
            <div class="hi-right">
                <div class="hi-scans ${scansClass}">${sc}/${q}</div>
                <div class="hi-price">${price}</div>
            </div>
            <div class="hi-buttons" id="hiButtons_${escapeHtml(oid)}">
                <button class="hi-btn hi-btn-minus" ${minusDisabled} onclick="event.stopPropagation(); incrementPending('${escapeHtml(oid)}', -1)" title="−1">−</button>
                <button class="hi-btn hi-btn-plus" ${plusDisabled} onclick="event.stopPropagation(); incrementPending('${escapeHtml(oid)}', +1)" title="+1">+</button>
                <div class="pending-actions" id="pendingActions_${escapeHtml(oid)}" style="display:none">
                    <span class="pending-badge" id="pendingBadge_${escapeHtml(oid)}"></span>
                    <button class="apply-btn" id="applyBtn_${escapeHtml(oid)}" onclick="event.stopPropagation(); applyPending('${escapeHtml(oid)}')">OK</button>
                    <button class="cancel-pending-btn" onclick="event.stopPropagation(); cancelPending('${escapeHtml(oid)}')" title="Отмена">✕</button>
                </div>
                <button class="hi-admit-btn ${admitBtnClass}" id="admitBtn_${escapeHtml(oid)}" ${sc >= q ? 'disabled' : ''} onclick="event.stopPropagation(); quickAdmitFromHistory('${escapeHtml(oid)}', ${sc}, ${q})" title="${sc >= q ? 'Все вошли' : 'Впустить'}">✓</button>
            </div>
        </div>`;
    });

    list.innerHTML = html;
    updateMassActionBar();
}

function filterHistory() { renderHistory(); }

// Очистка поиска
function updateSearchClear() {
    const input = document.getElementById('historySearch');
    const clearBtn = document.getElementById('searchClear');
    if (input && clearBtn) {
        clearBtn.classList.toggle('visible', input.value.length > 0);
    }
}

function clearSearch() {
    const input = document.getElementById('historySearch');
    if (input) {
        input.value = '';
        input.focus();
        filterHistory();
        updateSearchClear();
    }
}

// Обновление progress bar
function updateMetricsProgress() {
    const total = parseInt(document.getElementById('metricTotal')?.textContent || '0');
    const entered = parseInt(document.getElementById('metricEntered')?.textContent || '0');
    const progressFill = document.getElementById('metricsProgressFill');
    if (progressFill && total > 0) {
        const percent = Math.round((entered / total) * 100);
        progressFill.style.width = percent + '%';
    } else if (progressFill) {
        progressFill.style.width = '0%';
    }
}

function setHistoryFilter(mode, btn) {
    historyFilterMode = mode;
    document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    
    // Save filter state to localStorage
    saveUIState('historyFilter', mode);
    
    renderHistory();
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ══════════════════════════════════════════════
// TICKET SELECTION & MASS ACTIONS
// ══════════════════════════════════════════════
function toggleTicketSelect(orderId) {
    if (selectedTickets.has(orderId)) {
        selectedTickets.delete(orderId);
    } else {
        selectedTickets.add(orderId);
    }
    renderHistory();
}

function toggleSelectAll() {
    const searchText = (document.getElementById('historySearch')?.value || '').toLowerCase();
    let tickets = filteredTickets;
    if (searchText) {
        tickets = tickets.filter(t => {
            const name = (t.customer_name || '').toLowerCase();
            const email = (t.customer_email || '').toLowerCase();
            const phone = (t.customer_phone || '');
            const order = (t.order_id || '').toLowerCase();
            return name.includes(searchText) || email.includes(searchText) || phone.includes(searchText) || order.includes(searchText);
        });
    }
    if (historyFilterMode !== 'all') {
        tickets = tickets.filter(t => getDisplayStatus(t) === historyFilterMode);
    }

    const visibleIds = tickets.slice(0, 200).map(t => t.order_id).filter(Boolean);
    const allSelected = visibleIds.length > 0 && visibleIds.every(id => selectedTickets.has(id));

    if (allSelected) {
        visibleIds.forEach(id => selectedTickets.delete(id));
    } else {
        visibleIds.forEach(id => selectedTickets.add(id));
    }
    renderHistory();
}

function updateMassActionBar() {
    const bar = document.getElementById('massActionBar');
    const count = selectedTickets.size;
    if (count > 0) {
        bar.classList.add('active');
        document.getElementById('massCount').textContent = `Выбрано: ${count}`;
    } else {
        bar.classList.remove('active');
    }
    // Update select-all checkbox state
    const cb = document.getElementById('selectAllCheckbox');
    if (cb) {
        const checkboxes = document.querySelectorAll('.hi-checkbox');
        const checkedCount = document.querySelectorAll('.hi-checkbox:checked').length;
        cb.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
        cb.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }
}

// ══════════════════════════════════════════════
// PENDING CHANGES (БАГ 1: накопление без пароля)
// ══════════════════════════════════════════════
const pendingChanges = new Map(); // order_id → pending delta

function incrementPending(orderId, delta) {
    const ticket = allTickets.find(t => t.order_id === orderId);
    if (!ticket) return;
    
    const current = pendingChanges.get(orderId) || 0;
    const scanCount = ticket.scan_count || 0;
    const quantity = ticket.quantity || 1;
    
    const newPending = current + delta;
    
    // Ограничения: нельзя ниже 0 и выше quantity
    const maxPlus = quantity - scanCount;
    const maxMinus = -scanCount;
    const clamped = Math.max(maxMinus, Math.min(maxPlus, newPending));
    
    if (clamped === 0) {
        pendingChanges.delete(orderId);
    } else {
        pendingChanges.set(orderId, clamped);
    }
    
    updatePendingUI(orderId);
}

function updatePendingUI(orderId) {
    const pending = pendingChanges.get(orderId) || 0;
    const actionsEl = document.getElementById(`pendingActions_${orderId}`);
    const badgeEl = document.getElementById(`pendingBadge_${orderId}`);
    const applyBtn = document.getElementById(`applyBtn_${orderId}`);
    const admitBtn = document.getElementById(`admitBtn_${orderId}`);
    const buttonsEl = document.getElementById(`hiButtons_${orderId}`);
    
    if (!actionsEl) return;
    
    // Get ticket info for button state updates
    const ticket = allTickets.find(t => t.order_id === orderId);
    const sc = ticket?.scan_count || 0;
    const q = ticket?.quantity || 1;
    const effectiveScan = sc + pending;
    
    // Update minus/plus button states based on effective scan count
    if (buttonsEl) {
        const minusBtn = buttonsEl.querySelector('.hi-btn-minus');
        const plusBtn = buttonsEl.querySelector('.hi-btn-plus');
        if (minusBtn) {
            minusBtn.disabled = effectiveScan <= 0;
        }
        if (plusBtn) {
            plusBtn.disabled = effectiveScan >= q;
        }
    }
    
    if (pending !== 0) {
        actionsEl.style.display = 'flex';
        badgeEl.textContent = pending > 0 ? `+${pending}` : `${pending}`;
        badgeEl.className = 'pending-badge' + (pending < 0 ? ' negative' : '');
        applyBtn.textContent = pending > 0 ? `Применить +${pending}` : `Применить ${pending}`;
        applyBtn.className = 'apply-btn' + (pending < 0 ? ' negative' : '');
        // Hide admit button when pending changes exist
        if (admitBtn) admitBtn.style.display = 'none';
    } else {
        actionsEl.style.display = 'none';
        // Show admit button when no pending changes
        if (admitBtn) admitBtn.style.display = '';
    }
}

function cancelPending(orderId) {
    pendingChanges.delete(orderId);
    updatePendingUI(orderId);
}

async function applyPending(orderId) {
    const pending = pendingChanges.get(orderId);
    if (!pending) return;
    
    const ticket = allTickets.find(t => t.order_id === orderId);
    if (!ticket) return;
    
    // Запрашиваем пароль ОДИН раз
    requestPassword('Пароль менеджера', async (password) => {
        if (!isValidActionPassword(password)) {
            showScanToast('Неверный пароль', 'error');
            return;
        }
        
        const currentScan = ticket.scan_count || 0;
        const quantity = ticket.quantity || 1;
        const newScanCount = Math.max(0, Math.min(quantity, currentScan + pending));
        
        try {
            const newStatus = newScanCount > 0 ? 'used' : 'valid';
            const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus, scan_count: newScanCount })
            });
            
            if (res.ok) {
                showScanToast(`${pending > 0 ? '+' : ''}${pending} для ${ticket.customer_name || 'Гость'}`, 'success');
                pendingChanges.delete(orderId);
                await loadTickets();
                renderHistory();
                updateBottomStats();
            } else {
                showScanToast('Ошибка API', 'error');
            }
        } catch (err) {
            showScanToast('Ошибка соединения', 'error');
        }
    });
}

// Legacy single +/- (kept for compatibility but not used in UI)
function adjustScanSingle(orderId, newScanCount, quantity) {
    if (newScanCount < 0) newScanCount = 0;
    if (newScanCount > quantity) newScanCount = quantity;

    requestPassword('Пароль менеджера', async (password) => {
        if (!isValidActionPassword(password)) {
            alert('Неверный пароль');
            return;
        }

        try {
            const newStatus = newScanCount > 0 ? 'used' : 'valid';
            const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus, scan_count: newScanCount })
            });
            if (res.ok) {
                await loadTickets();
            } else {
                alert('Ошибка обновления');
            }
        } catch (err) {
            alert('Ошибка соединения');
        }
    });
}

// Mass action execution (password-protected)

// ══════════════════════════════════════════════
// MASS PENDING (БАГ 2: +N/-N для массовых действий)
// ══════════════════════════════════════════════
let massPendingCount = 0;

function massIncrement(delta) {
    massPendingCount += delta;
    updateMassPendingUI();
}

function updateMassPendingUI() {
    const display = document.getElementById('massPendingDisplay');
    const applyBtn = document.getElementById('massApplyBtn');
    
    if (!display || !applyBtn) return;
    
    display.textContent = massPendingCount;
    display.className = 'mass-pending-display' + 
        (massPendingCount > 0 ? ' positive' : massPendingCount < 0 ? ' negative' : '');
    
    if (massPendingCount !== 0) {
        applyBtn.style.display = 'inline-flex';
        const sign = massPendingCount > 0 ? '+' : '';
        applyBtn.textContent = `Применить ${sign}${massPendingCount}`;
        applyBtn.className = 'mass-apply-btn' + (massPendingCount < 0 ? ' negative' : '');
    } else {
        applyBtn.style.display = 'none';
    }
}

async function massApplyPending() {
    if (massPendingCount === 0) return;
    if (selectedTickets.size === 0) {
        showScanToast('Выберите билеты', 'warning');
        return;
    }
    
    const sign = massPendingCount > 0 ? '+' : '';
    requestPassword(`${sign}${massPendingCount} для ${selectedTickets.size} билетов`, async (password) => {
        if (!isValidActionPassword(password)) {
            showScanToast('Неверный пароль', 'error');
            return;
        }
        
        let success = 0, failed = 0;
        
        for (const orderId of selectedTickets) {
            const ticket = allTickets.find(t => t.order_id === orderId);
            if (!ticket) { failed++; continue; }
            
            const currentScan = ticket.scan_count || 0;
            const quantity = ticket.quantity || 1;
            const newScanCount = Math.max(0, Math.min(quantity, currentScan + massPendingCount));
            
            try {
                const newStatus = newScanCount > 0 ? 'used' : 'valid';
                const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, scan_count: newScanCount })
                });
                if (res.ok) success++;
                else failed++;
            } catch (err) {
                failed++;
            }
        }
        
        showScanToast(`${sign}${massPendingCount} к ${success} билетам`, failed > 0 ? 'warning' : 'success');
        massPendingCount = 0;
        updateMassPendingUI();
        selectedTickets.clear();
        await loadTickets();
        renderHistory();
        updateBottomStats();
    });
}

function executeMassAction(action) {
    if (selectedTickets.size === 0) return;

    const actionLabels = {
        'reset': `Сброс ${selectedTickets.size} билетов`,
        'remove_scan': `−1 скан для ${selectedTickets.size} билетов`,
        'add_scan': `+1 скан для ${selectedTickets.size} билетов`,
        'hide': `Скрыть ${selectedTickets.size} билетов`
    };

    const label = actionLabels[action] || action;

    requestPassword(label, async (password) => {
        if (!isValidActionPassword(password)) {
            showScanToast('Неверный пароль', 'error');
            return;
        }

        let success = 0, failed = 0;

        for (const orderId of selectedTickets) {
            const ticket = allTickets.find(t => t.order_id === orderId);
            if (!ticket) { failed++; continue; }

            try {
                if (action === 'hide') {
                    // Try multiple endpoints for hiding
                    let res = await fetch(`${API_URL}/api/tickets/${orderId}/hide`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    // Fallback: try PATCH with visible_to_managers
                    if (!res.ok) {
                        res = await fetch(`${API_URL}/api/tickets/${orderId}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ visible_to_managers: false })
                        });
                    }
                    
                    // Second fallback: try PUT with visible_to_managers
                    if (!res.ok) {
                        res = await fetch(`${API_URL}/api/tickets/${orderId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ visible_to_managers: false })
                        });
                    }
                    
                    console.log(`Hide ${orderId}: ${res.status}`);
                    if (res.ok) success++; else failed++;
                } else {
                    let newSc = ticket.scan_count || 0;
                    let q = ticket.quantity || 1;

                    if (action === 'reset') newSc = 0;
                    else if (action === 'remove_scan') newSc = Math.max(0, newSc - 1);
                    else if (action === 'add_scan') newSc = Math.min(q, newSc + 1);

                    const newStatus = newSc > 0 ? 'used' : 'valid';
                    const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus, scan_count: newSc })
                    });
                    if (res.ok) success++; else failed++;
                }
            } catch (err) {
                console.error(`Mass action error for ${orderId}:`, err);
                failed++;
            }
        }

        // Clear selection and refresh UI
        selectedTickets.clear();
        updateMassActionBar();
        await loadTickets();
        renderHistory();
        updateBottomStats();
        
        const msg = `✅ ${success} обновлено` + (failed > 0 ? `, ${failed} ошибок` : '');
        showScanToast(msg, failed > 0 ? 'warning' : 'success');
    });
}

// ══════════════════════════════════════════════
// BOTTOM STATS (Считаем ЛЮДЕЙ, не QR-коды!)
// ══════════════════════════════════════════════
function updateBottomStats() {
    let admitted = 0;    // Сколько ЛЮДЕЙ вошло
    let pending = 0;     // Сколько ЛЮДЕЙ ожидает
    let duplicate = 0;   // Повторные попытки (кол-во билетов)
    let denied = 0;      // Отказы (кол-во билетов)

    filteredTickets.forEach(t => {
        const quantity = t.quantity || 1;
        const scanCount = t.scan_count || 0;
        const status = t.status || 'valid';
        
        if (status === 'cancelled') {
            denied++;
            return;
        }
        
        if (scanCount > quantity) {
            // Превышен лимит = duplicate (считаем как 1 билет)
            duplicate++;
            admitted += quantity; // Все вошли
        } else if (scanCount > 0) {
            // Частично или полностью вошли
            admitted += scanCount;  // Реально вошедшие
            pending += Math.max(0, quantity - scanCount);  // Остальные ожидают
        } else {
            // Никто не вошёл = все ожидают
            pending += quantity;
        }
    });

    document.getElementById('statAdmitted').textContent = admitted;
    document.getElementById('statDuplicate').textContent = duplicate;
    document.getElementById('statPending').textContent = pending;
    document.getElementById('statDenied').textContent = denied;
}

// ══════════════════════════════════════════════
// TICKET MODAL
// ══════════════════════════════════════════════
function openTicketModal(ticket) {
    const modal = document.getElementById('ticketModal');
    document.getElementById('modalTitle').innerHTML = `${ICONS.ticket} #${ticket.order_id || 'N/A'}`;

    const grid = document.getElementById('modalGrid');
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;
    const remaining = Math.max(0, q - sc);
    const allEntered = sc >= q;
    
    const fields = [
        ['Имя', ticket.customer_name || 'Неизвестно'],
        ['Телефон', ticket.customer_phone || '—'],
        ['Email', ticket.customer_email || '—'],
        ['Тип', ticket.ticket_type || 'Стандарт'],
        ['Цена', ticket.price ? `${ticket.price} EUR` : 'Бесплатно'],
        ['Событие', ticket.event_name || ticket.event_title || '—'],
        ['Входы', `${sc}/${q}`],
        ['Статус', ticket.status || 'valid'],
        ['Промо', ticket.promo_code || ticket.promocode || ticket.coupon || '—'],
    ];

    grid.innerHTML = fields.map(([label, val]) =>
        `<div class="guest-field"><div class="guest-field-label">${label}</div><div class="guest-field-value">${escapeHtml(String(val))}</div></div>`
    ).join('');

    // Build action buttons
    const actions = document.getElementById('modalActions');
    
    // Determine main button state
    let mainBtnText, mainBtnClass, mainBtnDisabled;
    if (ticket.status === 'cancelled') {
        mainBtnText = '🚫 БИЛЕТ ОТМЕНЁН';
        mainBtnClass = 'btn-primary-large all-entered';
        mainBtnDisabled = true;
    } else if (allEntered) {
        mainBtnText = '✅ ВСЕ ВОШЛИ';
        mainBtnClass = 'btn-primary-large all-entered';
        mainBtnDisabled = true;
    } else if (sc > 0) {
        mainBtnText = `✅ ВПУСТИТЬ ОСТАЛЬНЫХ (${remaining} ${declOfGuests(remaining)})`;
        mainBtnClass = 'btn-primary-large';
        mainBtnDisabled = false;
    } else {
        mainBtnText = `✅ ВПУСТИТЬ (${q} ${declOfGuests(q)})`;
        mainBtnClass = 'btn-primary-large';
        mainBtnDisabled = false;
    }
    
    const isCancelled = ticket.status === 'cancelled';
    
    actions.innerHTML = `
        <button class="${mainBtnClass}" ${mainBtnDisabled ? 'disabled' : ''} 
                onclick="changeTicketStatus('${ticket.order_id}', 'used', ${q}, ${q})">${mainBtnText}</button>
        
        <div class="modal-secondary-row">
            <button class="modal-action-btn btn-gray" ${isCancelled ? 'disabled' : ''} 
                    onclick="changeTicketStatus('${ticket.order_id}', 'used', ${Math.min(sc + 1, q)}, ${q})">+1 гость</button>
            <button class="modal-action-btn btn-gray" ${sc === 0 || isCancelled ? 'disabled' : ''} 
                    onclick="changeTicketStatus('${ticket.order_id}', 'valid', 0, ${q})">Сброс входов</button>
        </div>
        
        ${!isCancelled && q > 1 ? `
        <div class="quick-entry-section" id="quickEntrySection">
            <div class="quick-entry-title">Быстрый вход</div>
            <div class="quick-nums">
                ${[1,2,3,4,5].filter(n => n <= q).map(n => `
                    <button class="quick-num ${n === remaining ? 'selected' : ''}" 
                            onclick="selectQuickNum(${n}, '${ticket.order_id}', ${sc}, ${q})" 
                            ${n > remaining && sc + n > q ? 'disabled' : ''}>
                        ${n}
                    </button>
                `).join('')}
            </div>
            <div class="quick-counter">
                <button class="quick-counter-btn" onclick="adjustQuickCounter(-1, '${ticket.order_id}', ${sc}, ${q})">−</button>
                <div class="quick-counter-value ${sc > 0 ? '' : ''}" id="quickCounterValue">${remaining}</div>
                <button class="quick-counter-btn" onclick="adjustQuickCounter(1, '${ticket.order_id}', ${sc}, ${q})">+</button>
            </div>
            <button class="quick-apply-btn" id="quickApplyBtn" 
                    onclick="applyQuickEntry('${ticket.order_id}', ${sc}, ${q})">
                ✅ ВПУСТИТЬ ${remaining} ${declOfGuests(remaining)}
            </button>
        </div>
        ` : ''}
        
        <div class="modal-spoiler">
            <button class="spoiler-toggle" onclick="toggleSpoiler(this)">▼ Дополнительно</button>
            <div class="spoiler-content">
                <button class="modal-action-btn btn-red" ${isCancelled ? 'disabled' : ''} 
                        onclick="changeTicketStatus('${ticket.order_id}', 'cancelled', ${sc}, ${q})">❌ Отменить билет</button>
            </div>
        </div>
        
        <button class="modal-close-link" onclick="closeModal()">Закрыть</button>
    `;
    
    // Initialize quick entry counter
    if (!isCancelled && q > 1) {
        window.quickEntryCount = remaining;
    }

    modal.classList.add('active');
}

// Helper: склонение слова "гость"
function declOfGuests(n) {
    const abs = Math.abs(n) % 100;
    const n1 = abs % 10;
    if (abs > 10 && abs < 20) return 'гостей';
    if (n1 > 1 && n1 < 5) return 'гостя';
    if (n1 === 1) return 'гость';
    return 'гостей';
}

// Spoiler toggle
function toggleSpoiler(btn) {
    const content = btn.nextElementSibling;
    const isOpen = content.classList.toggle('open');
    btn.textContent = isOpen ? '▲ Скрыть' : '▼ Дополнительно';
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('ticketModal').classList.remove('active');
}

// ══════════════════════════════════════════════
// CHANGE TICKET STATUS (with password)
// ══════════════════════════════════════════════
function changeTicketStatus(orderId, newStatus, scanCount, quantity) {
    requestPassword('Пароль менеджера', async (password) => {
        if (!isValidActionPassword(password)) {
            showScanToast('Неверный пароль', 'error');
            return;
        }

        try {
            const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus, scan_count: scanCount })
            });

            if (res.ok) {
                closeModal();
                await loadTickets();
                renderHistory();
                updateBottomStats();
                vibrate([20, 50, 20]);
                showScanToast('✅ Статус обновлён', 'success');
            } else {
                showScanToast('Ошибка обновления', 'error');
            }
        } catch (err) {
            showScanToast('Нет соединения', 'error');
        }
    });
}

// ══════════════════════════════════════════════
// QUICK ENTRY (+N)
// ══════════════════════════════════════════════
window.quickEntryCount = 1;

function declOfGuests(n) {
    const abs = Math.abs(n);
    if (abs % 100 >= 11 && abs % 100 <= 19) return 'гостей';
    const last = abs % 10;
    if (last === 1) return 'гостя';
    if (last >= 2 && last <= 4) return 'гостя';
    return 'гостей';
}

function selectQuickNum(n, orderId, currentScan, quantity) {
    window.quickEntryCount = n;
    updateQuickEntryUI(orderId, currentScan, quantity);
}

function adjustQuickCounter(delta, orderId, currentScan, quantity) {
    const remaining = quantity - currentScan;
    const newCount = Math.min(Math.max(1, window.quickEntryCount + delta), remaining);
    window.quickEntryCount = newCount;
    updateQuickEntryUI(orderId, currentScan, quantity);
}

function updateQuickEntryUI(orderId, currentScan, quantity) {
    const counterEl = document.getElementById('quickCounterValue');
    const applyBtn = document.getElementById('quickApplyBtn');
    const nums = document.querySelectorAll('.quick-num');
    
    if (counterEl) counterEl.textContent = window.quickEntryCount;
    if (applyBtn) {
        applyBtn.innerHTML = `✅ ВПУСТИТЬ ${window.quickEntryCount} ${declOfGuests(window.quickEntryCount)}`;
    }
    
    nums.forEach(btn => {
        const n = parseInt(btn.textContent);
        btn.classList.toggle('selected', n === window.quickEntryCount);
    });
}

function applyQuickEntry(orderId, currentScan, quantity) {
    const newScanCount = currentScan + window.quickEntryCount;
    if (newScanCount > quantity) {
        showScanToast('Превышает количество гостей', 'error');
        return;
    }
    changeTicketStatus(orderId, 'used', newScanCount, quantity);
}

function quickAdmitFromHistory(orderId, currentScan, quantity) {
    // Admit all remaining guests
    changeTicketStatus(orderId, 'used', quantity, quantity);
}

// ══════════════════════════════════════════════
// PASSWORD MODAL
// ══════════════════════════════════════════════
function requestPassword(title, callback) {
    // Global admin skips ALL password prompts
    if (isCurrentUserGlobalAdmin()) {
        callback(currentSessionPassword);
        return;
    }
    document.getElementById('pwTitle').textContent = title;
    document.getElementById('pwInput').value = '';
    document.getElementById('passwordModal').classList.add('active');
    passwordCallback = callback;
    setTimeout(() => document.getElementById('pwInput').focus(), 100);
}

function confirmPassword() {
    const pw = document.getElementById('pwInput').value;
    document.getElementById('passwordModal').classList.remove('active');
    if (passwordCallback) passwordCallback(pw);
    passwordCallback = null;
}

function cancelPassword() {
    document.getElementById('passwordModal').classList.remove('active');
    passwordCallback = null;
}

// ══════════════════════════════════════════════
// TAB SWITCHING
// ══════════════════════════════════════════════
function switchTab(tab) {
    // Update old tab-bar buttons (if visible)
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
    // Update top-bar tab buttons
    document.querySelectorAll('.top-tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tab === 'scanner' ? 'tabScanner' : 'tabHistory').classList.add('active');
    // Скрыть кнопку впуска при переключении
    if (tab === 'history') hideSearchAdmitButton();
    // Save tab to storage for session persistence
    try { storage.setItem('impreza_active_tab', tab); } catch (e) {}
}

function restoreActiveTab() {
    try {
        const savedTab = storage.getItem('impreza_active_tab');
        if (savedTab && (savedTab === 'scanner' || savedTab === 'history')) {
            switchTab(savedTab);
        }
    } catch (e) {}
}

// ══════════════════════════════════════════════
// BURGER MENU
// ══════════════════════════════════════════════
function openBurger() {
    document.getElementById('burgerOverlay').classList.add('open');
    document.body.style.overflow = 'hidden'; // Prevent body scroll
    updateBurgerThemeText();
}

function closeBurger() {
    document.getElementById('burgerOverlay').classList.remove('open');
    document.body.style.overflow = ''; // Restore body scroll
}

function switchTabFromBurger(tab) {
    switchTab(tab);
    closeBurger();
}

function toggleThemeFromBurger() {
    toggleTheme();
    updateBurgerThemeText();
}

function updateBurgerThemeText() {
    const isLight = document.documentElement.getAttribute('data-theme') === 'light';
    const textEl = document.getElementById('burgerThemeText');
    const iconEl = document.getElementById('burgerThemeIcon');
    if (textEl) textEl.textContent = isLight ? 'Тёмная тема' : 'Светлая тема';
    if (iconEl) {
        iconEl.innerHTML = isLight 
            ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'
            : '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
    }
}

// ══════════════════════════════════════════════
// CLOCK & CONNECTION
// ══════════════════════════════════════════════
function startClock() {
    const update = () => {
        const timeEl = document.getElementById('topTime');
        if (timeEl) timeEl.textContent = new Date().toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    };
    update();
    setInterval(update, 1000);
}

async function checkConnection() {
    const indicator = document.getElementById('onlineIndicator');
    const text = document.getElementById('connText');
    // Legacy elements (если остались)
    const dot = document.getElementById('connDot');
    try {
        const res = await fetch(`${API_URL}/health`, { signal: AbortSignal.timeout(5000) });
        const isOk = res.ok;
        if (indicator) indicator.classList.toggle('offline', !isOk);
        if (text) {
            text.textContent = isOk ? 'ONLINE' : 'OFFLINE';
        }
        // Legacy support
        if (dot) dot.classList.toggle('offline', !isOk);
    } catch {
        if (indicator) indicator.classList.add('offline');
        if (text) text.textContent = 'OFFLINE';
        if (dot) dot.classList.add('offline');
    }
}

// ══════════════════════════════════════════════
// FULLSCREEN
// ══════════════════════════════════════════════
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen?.() || document.documentElement.webkitRequestFullscreen?.();
    } else {
        document.exitFullscreen?.() || document.webkitExitFullscreen?.();
    }
}

// ══════════════════════════════════════════════
// CITY SWITCHER (Global Admin или Super Admin)
// ══════════════════════════════════════════════
async function openCitySwitcherDirect() {
    // Прямое открытие без запроса пароля (для глобального админа)
    try {
        const res = await fetch(`${API_URL}/clubs`, { signal: AbortSignal.timeout(15000) });
        if (!res.ok) throw new Error('Server error');
        const data = await res.json();
        allClubs = data.clubs || [];
        renderCitySwitcher();
        document.getElementById('citySwitcherModal').classList.add('active');
    } catch (err) {
        alert('Ошибка загрузки клубов: ' + err.message);
    }
}

function openCitySwitcher() {
    // Если пользователь уже глобальный админ — открываем сразу без пароля
    if (isCurrentUserGlobalAdmin()) {
        openCitySwitcherDirect();
        return;
    }
    
    // Для остальных — запрашиваем пароль супер-админа
    requestPassword('Переключение города', async (password) => {
        if (!isSuperAdmin(password)) {
            alert('Только для супер-администратора');
            return;
        }
        currentSessionPassword = password;
        await openCitySwitcherDirect();
    });
}

function renderCitySwitcher() {
    const list = document.getElementById('citySwitcherList');
    const COUNTRY_NAMES = { 'PL':'Poland', 'NL':'Netherlands', 'DE':'Germany', 'BG':'Bulgaria', 'ES':'Spain', 'CZ':'Czech Republic', 'LU':'Luxembourg', 'AT':'Austria', 'SK':'Slovakia', 'LT':'Lithuania', 'LV':'Latvia', 'EE':'Estonia', 'FR':'France', 'US':'United States', 'PT':'Portugal', 'GB':'United Kingdom' };
    const groups = {};
    allClubs.forEach(club => {
        const cc = club.country_code || '??';
        if (!groups[cc]) groups[cc] = [];
        groups[cc].push(club);
    });
    let html = '';
    Object.keys(groups).sort().forEach(cc => {
        const countryName = COUNTRY_NAMES[cc] || cc;
        html += `<div class="city-group-label">${countryName}</div>`;
        groups[cc].forEach(club => {
            const isActive = currentClub && currentClub.id === club.id;
            html += `<button class="city-option ${isActive ? 'active' : ''}" onclick="selectCity(${club.id})">
                <span class="city-option-name">${escapeHtml(club.city_name)}</span>
                ${isActive ? '<span class="city-option-check">✓</span>' : ''}
            </button>`;
        });
    });
    list.innerHTML = html;
}

async function selectCity(clubId) {
    const club = allClubs.find(c => c.id === clubId);
    if (!club) return;
    currentClub = {
        id: club.id,
        city_name: club.city_name,
        city_english: club.city_english || club.city_name,
        country_code: club.country_code,
        login: club.login,
        is_admin: true,
        is_global_admin: false,
        is_super_admin: false
    };
    storage.setItem('impreza_session', JSON.stringify({
        club: currentClub,
        password: currentSessionPassword,
        timestamp: Date.now()
    }));
    document.getElementById('topCity').textContent = currentClub.city_name;
    closeCitySwitcher();
    await loadTickets();
}

function closeCitySwitcher(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('citySwitcherModal').classList.remove('active');
}

// ══════════════════════════════════════════════
// PHONE SEARCH (Scanner tab manual input)
// ══════════════════════════════════════════════
let currentSearchTicket = null; // Текущий найденный билет для кнопки ВПУСТИТЬ

function searchByPhone() {
    const input = document.getElementById('phoneSearchInput');
    const query = (input.value || '').replace(/[^\d+]/g, '');
    if (query.length < 4) {
        alert('Введите минимум 4 цифры');
        return;
    }

    // Determine which tickets to search based on event filter
    const searchSource = selectedEventDate ? filteredTickets : allTickets;
    
    // Search through tickets for matching phone
    const matches = searchSource.filter(t => {
        const phone = (t.customer_phone || '').replace(/[^\d+]/g, '');
        return phone.includes(query);
    });

    // If no match in filtered tickets, check if there's a match in ALL tickets (different event)
    if (matches.length === 0 && selectedEventDate) {
        const allMatches = allTickets.filter(t => {
            const phone = (t.customer_phone || '').replace(/[^\d+]/g, '');
            return phone.includes(query);
        });
        
        if (allMatches.length > 0) {
            const otherTicket = allMatches[0];
            const otherEvent = otherTicket.event_name || otherTicket.event_title || 'другое мероприятие';
            showStatus('denied', 'ДРУГОЕ МЕРОПРИЯТИЕ', `Билет найден, но для: ${otherEvent}`);
            hideSearchAdmitButton();
            
            // Still show guest info for reference
            updateGuestInfo({
                name: otherTicket.customer_name,
                order_id: otherTicket.order_id,
                phone: otherTicket.customer_phone,
                email: otherTicket.customer_email,
                ticket_type: otherTicket.ticket_type,
                price: otherTicket.price,
                event_date: otherEvent,
                city: '',
                quantity: otherTicket.quantity || 1,
                scan_count: otherTicket.scan_count || 0
            });
            
            input.value = '';
            return;
        }
    }

    if (matches.length === 0) {
        showStatus('invalid', 'НЕ НАЙДЕН', `Нет билета для: ${query}`);
        hideSearchAdmitButton();
        input.value = '';
        return;
    }

    // Prioritize unused tickets
    const sorted = [...matches].sort((a, b) => {
        const aSc = a.scan_count || 0;
        const bSc = b.scan_count || 0;
        if (aSc === 0 && bSc > 0) return -1;
        if (bSc === 0 && aSc > 0) return 1;
        return 0;
    });

    const ticket = sorted[0];
    currentSearchTicket = ticket;
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;

    // Show on guest info
    updateGuestInfo({
        name: ticket.customer_name,
        order_id: ticket.order_id,
        phone: ticket.customer_phone,
        email: ticket.customer_email,
        ticket_type: ticket.ticket_type,
        price: ticket.price,
        event_date: ticket.event_name || ticket.event_title || '',
        city: '',
        quantity: q,
        scan_count: sc
    });

    if (sc === 0) {
        showStatus('valid', `НАЙДЕН: ${ticket.customer_name}`, `Телефон: ${ticket.customer_phone} · ${q} билет(ов) · Ещё не вошёл`);
    } else if (sc < q) {
        showStatus('used', 'ЧАСТИЧНО ИСПОЛЬЗОВАН', `${ticket.customer_name} · Входы: ${sc}/${q}`);
    } else {
        showStatus('used', 'УЖЕ ИСПОЛЬЗОВАН', `${ticket.customer_name} · Все ${q} входов использованы`);
    }

    if (matches.length > 1) {
        showStatus(sc === 0 ? 'valid' : 'used',
            document.getElementById('statusText').textContent,
            document.getElementById('statusSubtitle').textContent + ` (${matches.length} билетов найдено)`
        );
    }

    // Показать кнопку ВПУСТИТЬ (БАГ 3)
    showSearchAdmitButton(ticket);

    input.value = '';
}

// ══════════════════════════════════════════════
// SEARCH ADMIT BUTTON (БАГ 3)
// ══════════════════════════════════════════════
function showSearchAdmitButton(ticket) {
    const container = document.getElementById('searchAdmitContainer');
    const btn = document.getElementById('searchAdmitBtn');
    if (!container || !btn) return;

    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;
    const remaining = q - sc;

    container.style.display = 'block';

    if (remaining > 0) {
        const pluralGuest = (n) => {
            if (n === 1) return 'гость';
            if (n >= 2 && n <= 4) return 'гостя';
            return 'гостей';
        };
        const label = q === 1 
            ? '✅ ВПУСТИТЬ' 
            : `✅ ВПУСТИТЬ ВСЕХ (${remaining} ${pluralGuest(remaining)})`;
        btn.textContent = label;
        btn.className = 'search-admit-btn';
        btn.disabled = false;
    } else {
        btn.textContent = '✅ ВСЕ ВОШЛИ';
        btn.className = 'search-admit-btn admitted';
        btn.disabled = true;
    }
}

function hideSearchAdmitButton() {
    const container = document.getElementById('searchAdmitContainer');
    if (container) container.style.display = 'none';
    currentSearchTicket = null;
}

async function admitFromSearch() {
    if (!currentSearchTicket) return;
    
    const ticket = currentSearchTicket;
    const q = ticket.quantity || 1;
    
    // БЕЗ ПАРОЛЯ — прямой впуск после поиска по телефону
    try {
        const res = await fetch(`${API_URL}/api/tickets/${ticket.order_id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'used', scan_count: q })
        });
        
        if (res.ok) {
            showScanToast('Вход подтверждён!', 'success');
            await loadTickets();
            renderHistory();
            updateBottomStats();
            // Обновить кнопку
            const updatedTicket = allTickets.find(t => t.order_id === ticket.order_id);
            if (updatedTicket) {
                currentSearchTicket = updatedTicket;
                showSearchAdmitButton(updatedTicket);
                showStatus('used', 'УЖЕ ИСПОЛЬЗОВАН', `${updatedTicket.customer_name} · Все ${q} входов использованы`);
            }
        } else {
            showScanToast('Ошибка API', 'error');
        }
    } catch (err) {
        showScanToast('Ошибка соединения', 'error');
    }
}

// ══════════════════════════════════════════════
// VIEW TICKET ON SCANNER (from modal)
// ══════════════════════════════════════════════
function viewTicketOnScanner(ticket) {
    switchTab('scanner');
    updateGuestInfo({
        name: ticket.customer_name,
        order_id: ticket.order_id,
        phone: ticket.customer_phone,
        email: ticket.customer_email,
        ticket_type: ticket.ticket_type,
        price: ticket.price,
        event_date: ticket.event_name || ticket.event_title || '',
        city: '',
        quantity: ticket.quantity || 1,
        scan_count: ticket.scan_count || 0
    });
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;
    const ds = getDisplayStatus(ticket);
    const statusMap = { entered: 'valid', duplicate: 'used', pending: 'valid', invalid: 'invalid' };
    showStatus(statusMap[ds] || 'valid', ticket.customer_name, `Заказ #${ticket.order_id} · Входы: ${sc}/${q}`);
}

// ══════════════════════════════════════════════
// TOAST NOTIFICATIONS (for scans while on History tab)
// ══════════════════════════════════════════════
function showScanToast(status, message) {
    const toast = document.getElementById('scanToast');
    toast.textContent = message;
    toast.className = 'scan-toast toast-' + status;
    // Force reflow
    void toast.offsetWidth;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ══════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════

// Try to restore session from storage
async function tryRestoreSession() {
    console.log('🔄 Попытка восстановить сессию...');
    
    try {
        const saved = storage.getItem('impreza_session');
        if (!saved) {
            console.log('❌ Нет сохранённой сессии');
            return false;
        }
        console.log('📦 Найдена сессия, размер:', saved.length, 'байт');

        let session;
        try {
            session = JSON.parse(saved);
        } catch (parseErr) {
            console.error('⚠️ Ошибка парсинга сессии (НЕ удаляем):', parseErr);
            // НЕ удаляем сессию при ошибке парсинга - возможно временная проблема
            return false;
        }
        
        // Validate session has required fields
        if (!session.club) {
            console.log('⚠️ Сессия без club данных');
            return false;
        }
        
        // Session expires after 30 days (extended from 7 days)
        const SESSION_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 days
        const sessionAge = Date.now() - (session.timestamp || 0);
        
        if (sessionAge > SESSION_DURATION) {
            console.log(`⏰ Сессия истекла (${Math.round(sessionAge / 86400000)} дней)`);
            storage.removeItem('impreza_session');
            return false;
        }

        // Restore session data immediately (don't wait for network)
        currentClub = session.club;
        currentSessionPassword = session.password || '';
        
        const ageHours = Math.round(sessionAge / 3600000);
        console.log('✅ Сессия восстановлена:', currentClub?.city_name || 'Все города', `(возраст: ${ageHours}ч)`);
        
        // Handle global admin session
        if (session.club && session.club.is_global_admin === true) {
            console.log('👑 Режим глобального админа');
        }

        // Switch to main screen IMMEDIATELY (before network calls)
        document.getElementById('loginScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        document.getElementById('topCity').textContent = currentClub?.city_name || 'Все города';
        
        // Restore active tab from previous session
        restoreActiveTab();
        
        // Start clock and connection check
        startClock();
        setInterval(checkConnection, 10000);

        // Try to load clubs and tickets in background (don't fail session on error)
        try {
            const res = await fetch(`${API_URL}/clubs`, { signal: AbortSignal.timeout(15000) });
            if (res.ok) {
                const data = await res.json();
                const clubs = data.clubs || [];
                
                if (session.club && session.club.is_global_admin === true) {
                    allClubs = clubs;
                    buildCityMappings();
                    updateAdminFiltersVisibility();
                }
            }
        } catch (networkErr) {
            console.warn('Не удалось загрузить клубы (сессия сохранена):', networkErr.message);
        }

        // Load tickets in background
        try {
            await loadTickets();
            // Restore saved event filter after tickets loaded
            restoreSavedEventFilter();
        } catch (ticketErr) {
            console.warn('Не удалось загрузить билеты (сессия сохранена):', ticketErr.message);
        }
        
        // Restore history filter
        restoreSavedHistoryFilter();

        // Auto-start camera
        setTimeout(() => startCamera(), 500);

        // Start auto-refresh for tickets
        setInterval(loadTickets, 30000);

        // Update session timestamp to extend it (продлевает сессию на 30 дней)
        storage.setItem('impreza_session', JSON.stringify({
            club: currentClub,
            password: currentSessionPassword,
            timestamp: Date.now()
        }));
        
        console.log('🎉 Сессия полностью восстановлена');

        return true;
    } catch (e) {
        console.warn('⚠️ Ошибка восстановления сессии:', e);
        // NEVER remove session on errors - only explicit logout should remove it
        return false;
    }
}

// ══════════════════════════════════════════════
// STATE PERSISTENCE HELPERS
// ══════════════════════════════════════════════

function getStorageKey(key) {
    const userId = currentClub?.id || 'guest';
    return `impreza_${userId}_${key}`;
}

function saveUIState(key, value) {
    try {
        storage.setItem(getStorageKey(key), JSON.stringify(value));
    } catch (e) {
        console.warn('Не удалось сохранить состояние:', key, e);
    }
}

function loadUIState(key, defaultValue = null) {
    try {
        const saved = storage.getItem(getStorageKey(key));
        return saved ? JSON.parse(saved) : defaultValue;
    } catch (e) {
        return defaultValue;
    }
}

function restoreSavedEventFilter() {
    const savedEvent = loadUIState('selectedEvent', 'ALL');
    const select = document.getElementById('eventFilter');
    if (select && savedEvent) {
        // Check if option exists
        const option = select.querySelector(`option[value="${CSS.escape(savedEvent)}"]`);
        if (option) {
            select.value = savedEvent;
            applyEventFilter();
            console.log('📅 Восстановлен фильтр мероприятия:', savedEvent);
        }
    }
}

function restoreSavedHistoryFilter() {
    const savedFilter = loadUIState('historyFilter', 'all');
    const btn = document.querySelector(`.filter-tab[data-filter="${savedFilter}"]`);
    if (btn) {
        setHistoryFilter(savedFilter, btn);
        console.log('🔍 Восстановлен фильтр истории:', savedFilter);
    }
}

// ══════════════════════════════════════════════
// TESTS SECTION
// ══════════════════════════════════════════════

// Test definitions
const TESTS_DATA = {
    iq: {
        id: 'iq',
        icon: '🧠',
        title: 'IQ Тест',
        description: 'Логические последовательности, паттерны, числовые ряды',
        questionCount: 30,
        timeEstimate: '~20 мин',
        difficulty: 'hard',
        difficultyLabel: 'Сложный',
        questions: [
            { text: 'Какое число продолжает ряд: 2, 4, 8, 16, ?', answers: ['24', '32', '30', '28'], correct: 1 },
            { text: 'Какое число продолжает ряд: 1, 1, 2, 3, 5, 8, ?', answers: ['11', '12', '13', '14'], correct: 2 },
            { text: 'Какое число продолжает ряд: 3, 6, 11, 18, 27, ?', answers: ['36', '38', '40', '42'], correct: 1 },
            { text: 'Найдите лишнее: 12, 24, 36, 50, 60', answers: ['12', '24', '50', '60'], correct: 2 },
            { text: 'Какое число продолжает ряд: 1, 4, 9, 16, 25, ?', answers: ['30', '36', '42', '49'], correct: 1 },
            { text: 'Какое число продолжает ряд: 2, 6, 12, 20, 30, ?', answers: ['40', '42', '44', '46'], correct: 1 },
            { text: 'Если A=1, B=2, то CAB = ?', answers: ['312', '321', '123', '132'], correct: 0 },
            { text: 'Какое число продолжает ряд: 100, 95, 85, 70, ?', answers: ['50', '55', '60', '45'], correct: 0 },
            { text: 'Какое число продолжает ряд: 1, 8, 27, 64, ?', answers: ['100', '125', '81', '144'], correct: 1 },
            { text: 'Найдите пропущенное: 2, ?, 8, 16, 32', answers: ['4', '6', '5', '3'], correct: 0 },
            { text: 'Какое число продолжает ряд: 5, 10, 20, 40, ?', answers: ['60', '70', '80', '90'], correct: 2 },
            { text: 'Какое число лишнее: 2, 3, 5, 7, 9, 11', answers: ['2', '3', '9', '11'], correct: 2 },
            { text: 'Какое число продолжает ряд: 1, 3, 6, 10, 15, ?', answers: ['20', '21', '22', '25'], correct: 1 },
            { text: 'Если 3+5=16, 4+6=20, то 5+7=?', answers: ['22', '24', '26', '28'], correct: 1 },
            { text: 'Какое число продолжает ряд: 81, 27, 9, 3, ?', answers: ['0', '1', '2', '6'], correct: 1 },
            { text: 'Какое число продолжает ряд: 2, 3, 5, 7, 11, ?', answers: ['12', '13', '14', '15'], correct: 1 },
            { text: 'Какое число продолжает ряд: 1, 2, 4, 7, 11, ?', answers: ['14', '15', '16', '17'], correct: 2 },
            { text: 'Найдите закономерность: 6, 12, 24, 48, ?', answers: ['84', '96', '72', '60'], correct: 1 },
            { text: 'Какое число продолжает ряд: 99, 92, 85, 78, ?', answers: ['70', '71', '72', '73'], correct: 1 },
            { text: 'Какое число продолжает ряд: 1, 4, 2, 5, 3, ?', answers: ['4', '5', '6', '7'], correct: 2 },
            { text: 'Если МОРЕ=40, РЕКА=35, то ОЗЕРО=?', answers: ['45', '50', '55', '60'], correct: 1 },
            { text: 'Какое число продолжает ряд: 7, 14, 28, 56, ?', answers: ['100', '112', '98', '84'], correct: 1 },
            { text: 'Какое число продолжает ряд: 3, 9, 27, 81, ?', answers: ['162', '243', '324', '189'], correct: 1 },
            { text: 'Найдите X: 15+X = 3×(X-5)', answers: ['10', '15', '20', '25'], correct: 1 },
            { text: 'Какое число продолжает ряд: 1, 1, 2, 6, 24, ?', answers: ['48', '72', '120', '96'], correct: 2 },
            { text: 'Какое число продолжает ряд: 10, 11, 13, 16, 20, ?', answers: ['24', '25', '26', '27'], correct: 1 },
            { text: 'Сколько треугольников на рисунке из 4 линий?', answers: ['1', '2', '3', '4'], correct: 3, visual: 'triangle' },
            { text: 'Какое число продолжает ряд: 256, 128, 64, 32, ?', answers: ['8', '16', '24', '4'], correct: 1 },
            { text: 'Какое число продолжает ряд: 2, 5, 10, 17, ?', answers: ['24', '26', '28', '30'], correct: 1 },
            { text: 'Какое число продолжает ряд: 1, 3, 7, 15, 31, ?', answers: ['47', '55', '63', '71'], correct: 2 }
        ]
    },
    logic: {
        id: 'logic',
        icon: '🔮',
        title: 'Тест на логику',
        description: 'Логические задачки, силлогизмы, причинно-следственные связи',
        questionCount: 15,
        timeEstimate: '~10 мин',
        difficulty: 'medium',
        difficultyLabel: 'Средний',
        questions: [
            { text: 'Все яблоки — фрукты. Некоторые фрукты красные. Значит:', answers: ['Все яблоки красные', 'Некоторые яблоки красные', 'Нельзя сказать точно', 'Яблоки не красные'], correct: 2 },
            { text: 'Если идёт дождь, земля мокрая. Земля мокрая. Значит:', answers: ['Идёт дождь', 'Был дождь', 'Нельзя сказать точно', 'Дождя не было'], correct: 2 },
            { text: 'Чем закончится ряд: понедельник, среда, пятница, ?', answers: ['Суббота', 'Воскресенье', 'Вторник', 'Четверг'], correct: 1 },
            { text: 'Антон выше Бориса, Борис выше Сергея. Кто самый низкий?', answers: ['Антон', 'Борис', 'Сергей', 'Нельзя определить'], correct: 2 },
            { text: 'Если A → B и B → C, то:', answers: ['A → C', 'C → A', 'A = C', 'Нет связи'], correct: 0 },
            { text: 'Все кошки — животные. Все животные смертны. Значит:', answers: ['Некоторые кошки смертны', 'Все кошки смертны', 'Кошки бессмертны', 'Нельзя сказать'], correct: 1 },
            { text: 'Какое слово лишнее: яблоко, груша, морковь, банан?', answers: ['Яблоко', 'Груша', 'Морковь', 'Банан'], correct: 2 },
            { text: 'Если нет A, то нет B. Есть B. Значит:', answers: ['Есть A', 'Нет A', 'Нельзя сказать', 'B не зависит от A'], correct: 0 },
            { text: 'Продолжите: 2, A, 4, C, 6, E, 8, ?', answers: ['F', 'G', 'H', 'I'], correct: 1 },
            { text: 'Книга стоит на полке между словарём и атласом. Атлас слева от книги. Что справа?', answers: ['Атлас', 'Словарь', 'Книга', 'Ничего'], correct: 1 },
            { text: 'Если все X — Y, и все Y — Z, что верно?', answers: ['Все X — Z', 'Все Z — X', 'Некоторые X — Z', 'X не связан с Z'], correct: 0 },
            { text: 'Что тяжелее: 1 кг железа или 1 кг ваты?', answers: ['Железо', 'Вата', 'Одинаково', 'Невозможно сравнить'], correct: 2 },
            { text: 'Сколько месяцев в году имеют 28 дней?', answers: ['1', '2', '6', '12'], correct: 3 },
            { text: 'У фермера 17 овец. Все, кроме 9, убежали. Сколько осталось?', answers: ['8', '9', '17', '0'], correct: 1 },
            { text: 'Самолёт летит из Москвы в Питер 1 час, обратно — 60 минут. Почему?', answers: ['Ветер', 'Разное топливо', 'Это одинаковое время', 'Разная скорость'], correct: 2 }
        ]
    },
    attention: {
        id: 'attention',
        icon: '👁️',
        title: 'Тест на внимательность',
        description: 'Найди отличие, запомни последовательность',
        questionCount: 10,
        timeEstimate: '~5 мин',
        difficulty: 'easy',
        difficultyLabel: 'Лёгкий',
        questions: [
            { text: 'Какое число отличается: 6 6 6 9 6 6 6', answers: ['Первое', 'Третье', 'Четвёртое', 'Последнее'], correct: 2 },
            { text: 'Сколько букв "о" в слове "молоко"?', answers: ['2', '3', '4', '1'], correct: 1 },
            { text: 'Найди отличие: ABCDEFG ABCDEFG ABCDΕFG', answers: ['Первая группа', 'Вторая группа', 'Третья группа', 'Нет отличий'], correct: 2 },
            { text: 'Сколько раз цифра 5 встречается от 1 до 50?', answers: ['5', '6', '10', '15'], correct: 3 },
            { text: 'Какая буква пропущена: А Б В Г _ Е Ж', answers: ['Д', 'З', 'И', 'К'], correct: 0 },
            { text: 'Найди лишнее: ▲ ▲ ▲ △ ▲ ▲', answers: ['Первый', 'Третий', 'Четвёртый', 'Пятый'], correct: 2 },
            { text: 'Сколько букв в слове "ВНИМАТЕЛЬНОСТЬ"?', answers: ['12', '13', '14', '15'], correct: 2 },
            { text: 'Какое слово написано неправильно: "неправильно"?', answers: ['Никакое', 'Оба', 'Первое', '"неправильно"'], correct: 3 },
            { text: 'Сколько квадратов на шахматной доске 8×8?', answers: ['64', '204', '32', '128'], correct: 1 },
            { text: 'Найди число без пары: 12 24 36 48 37 60 72', answers: ['24', '36', '37', '60'], correct: 2 }
        ]
    },
    erudition: {
        id: 'erudition',
        icon: '📚',
        title: 'Тест на эрудицию',
        description: 'Общие знания, география, наука, история',
        questionCount: 20,
        timeEstimate: '~10 мин',
        difficulty: 'medium',
        difficultyLabel: 'Средний',
        questions: [
            { text: 'Столица Австралии?', answers: ['Сидней', 'Мельбурн', 'Канберра', 'Перт'], correct: 2 },
            { text: 'Химический символ золота?', answers: ['Go', 'Ag', 'Au', 'Gd'], correct: 2 },
            { text: 'В каком году началась Вторая мировая война?', answers: ['1937', '1938', '1939', '1940'], correct: 2 },
            { text: 'Самая длинная река в мире?', answers: ['Амазонка', 'Нил', 'Янцзы', 'Миссисипи'], correct: 1 },
            { text: 'Кто написал "Войну и мир"?', answers: ['Достоевский', 'Толстой', 'Чехов', 'Тургенев'], correct: 1 },
            { text: 'Сколько планет в Солнечной системе?', answers: ['7', '8', '9', '10'], correct: 1 },
            { text: 'Какой газ составляет большую часть атмосферы?', answers: ['Кислород', 'Азот', 'Углекислый газ', 'Аргон'], correct: 1 },
            { text: 'Самая высокая гора в мире?', answers: ['К2', 'Эверест', 'Канченджанга', 'Макалу'], correct: 1 },
            { text: 'Столица Канады?', answers: ['Торонто', 'Ванкувер', 'Монреаль', 'Оттава'], correct: 3 },
            { text: 'Кто изобрёл телефон?', answers: ['Эдисон', 'Тесла', 'Белл', 'Маркони'], correct: 2 },
            { text: 'Самое большое озеро в мире?', answers: ['Байкал', 'Виктория', 'Каспийское море', 'Верхнее'], correct: 2 },
            { text: 'Сколько костей в теле взрослого человека?', answers: ['186', '206', '226', '256'], correct: 1 },
            { text: 'В каком году Гагарин полетел в космос?', answers: ['1959', '1960', '1961', '1962'], correct: 2 },
            { text: 'Какой элемент обозначается буквой "O"?', answers: ['Осмий', 'Кислород', 'Олово', 'Оганесон'], correct: 1 },
            { text: 'Столица Бразилии?', answers: ['Рио-де-Жанейро', 'Сан-Паулу', 'Бразилиа', 'Сальвадор'], correct: 2 },
            { text: 'Кто нарисовал "Мону Лизу"?', answers: ['Микеланджело', 'Рафаэль', 'Леонардо да Винчи', 'Боттичелли'], correct: 2 },
            { text: 'Самая маленькая страна в мире?', answers: ['Монако', 'Сан-Марино', 'Ватикан', 'Лихтенштейн'], correct: 2 },
            { text: 'Какой язык самый распространённый в мире?', answers: ['Английский', 'Испанский', 'Китайский', 'Хинди'], correct: 2 },
            { text: 'Формула воды?', answers: ['H2O', 'CO2', 'NaCl', 'O2'], correct: 0 },
            { text: 'Сколько сторон у гексагона?', answers: ['5', '6', '7', '8'], correct: 1 }
        ]
    },
    reaction: {
        id: 'reaction',
        icon: '⚡',
        title: 'Тест на реакцию',
        description: 'Нажми как можно быстрее когда экран станет зелёным',
        questionCount: 5,
        timeEstimate: '~2 мин',
        difficulty: 'easy',
        difficultyLabel: 'Лёгкий',
        isReactionTest: true
    }
};

// Tests state
let currentTest = null;
let currentQuestionIndex = 0;
let testAnswers = [];
let testStartTime = null;
let reactionTimes = [];
let reactionTimeout = null;
let reactionStartTime = null;
let reactionRound = 0;
let reactionState = 'waiting'; // waiting, ready, result, tooEarly

// Get tests storage key for current user
function getTestsStorageKey() {
    const login = currentClub?.login || 'guest';
    return `impreza_tests_${login}`;
}

// Load tests data from storage
function loadTestsData() {
    try {
        const data = storage.getItem(getTestsStorageKey());
        return data ? JSON.parse(data) : { progress: {}, history: [], bestScores: {} };
    } catch {
        return { progress: {}, history: [], bestScores: {} };
    }
}

// Save tests data to storage
function saveTestsData(data) {
    try {
        storage.setItem(getTestsStorageKey(), JSON.stringify(data));
    } catch (e) {
        console.warn('Failed to save tests data:', e);
    }
}

// Open tests section
function openTestsSection() {
    closeBurger();
    document.getElementById('testsOverlay').classList.add('active');
    renderTestsCatalog();
    switchTestsTab('catalog');
}

// Close tests section
function closeTestsSection() {
    // Save progress if test is in progress
    if (currentTest && currentQuestionIndex > 0) {
        saveTestProgress();
    }
    document.getElementById('testsOverlay').classList.remove('active');
    // Reset screens
    document.getElementById('testQuestionScreen').style.display = 'none';
    document.getElementById('testResultScreen').style.display = 'none';
    document.getElementById('reactionTestScreen').style.display = 'none';
    document.getElementById('testsCatalog').classList.add('active');
    document.getElementById('testsResults').classList.remove('active');
    // Clear reaction timeout
    if (reactionTimeout) {
        clearTimeout(reactionTimeout);
        reactionTimeout = null;
    }
}

// Switch tests tab
function switchTestsTab(tab) {
    document.querySelectorAll('.tests-tab-btn').forEach(b => 
        b.classList.toggle('active', b.dataset.tab === tab)
    );
    document.getElementById('testsCatalog').classList.toggle('active', tab === 'catalog');
    document.getElementById('testsResults').classList.toggle('active', tab === 'results');
    
    if (tab === 'results') {
        renderTestsResults();
    }
}

// Render tests catalog
function renderTestsCatalog() {
    const grid = document.getElementById('testsCatalogGrid');
    const testsData = loadTestsData();
    
    let html = '';
    Object.values(TESTS_DATA).forEach(test => {
        const progress = testsData.progress[test.id];
        const bestScore = testsData.bestScores[test.id];
        
        let status = 'not-started';
        let statusText = 'Не начат';
        if (progress && progress.questionIndex > 0) {
            status = 'in-progress';
            statusText = `В процессе (${progress.questionIndex}/${test.questionCount})`;
        }
        if (bestScore !== undefined) {
            status = 'completed';
            statusText = 'Пройден';
        }
        
        html += `
            <div class="test-card ${status}" onclick="startTest('${test.id}')">
                <div class="test-card-header">
                    <span class="test-card-icon">${test.icon}</span>
                    <span class="test-card-badge ${status}">${statusText}</span>
                </div>
                <div class="test-card-title">${test.title}</div>
                <div class="test-card-desc">${test.description}</div>
                <div class="test-card-meta">
                    <span>📝 ${test.questionCount} ${test.isReactionTest ? 'раундов' : 'вопросов'}</span>
                    <span>⏱ ${test.timeEstimate}</span>
                    <span class="test-card-difficulty ${test.difficulty}">${test.difficultyLabel}</span>
                </div>
                ${bestScore !== undefined ? `<div class="test-card-score">🏆 Лучший результат: ${formatTestScore(test.id, bestScore)}</div>` : ''}
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

// Format test score for display
function formatTestScore(testId, score) {
    if (testId === 'reaction') {
        return `${score} мс`;
    } else if (testId === 'iq') {
        return `IQ ${score}`;
    } else {
        return `${score}/${TESTS_DATA[testId].questionCount}`;
    }
}

// Start a test
function startTest(testId) {
    currentTest = TESTS_DATA[testId];
    if (!currentTest) return;
    
    const testsData = loadTestsData();
    const progress = testsData.progress[testId];
    
    // Check if there's saved progress
    if (progress && progress.questionIndex > 0 && progress.questionIndex < currentTest.questionCount) {
        currentQuestionIndex = progress.questionIndex;
        testAnswers = progress.answers || [];
        testStartTime = progress.startTime || Date.now();
    } else {
        currentQuestionIndex = 0;
        testAnswers = [];
        testStartTime = Date.now();
    }
    
    // Hide catalog, show test screen
    document.getElementById('testsCatalog').classList.remove('active');
    document.getElementById('testsResults').classList.remove('active');
    
    if (currentTest.isReactionTest) {
        startReactionTest();
    } else {
        document.getElementById('testQuestionScreen').style.display = 'flex';
        renderQuestion();
    }
}

// Render current question
function renderQuestion() {
    if (!currentTest || currentQuestionIndex >= currentTest.questions.length) {
        finishTest();
        return;
    }
    
    const question = currentTest.questions[currentQuestionIndex];
    const progress = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
    
    document.getElementById('testProgressFill').style.width = `${progress}%`;
    document.getElementById('testProgressText').textContent = `${currentQuestionIndex + 1} / ${currentTest.questions.length}`;
    document.getElementById('testQuestionText').textContent = question.text;
    
    // Visual (if any)
    const visualEl = document.getElementById('testQuestionVisual');
    if (question.visual) {
        visualEl.innerHTML = renderVisual(question.visual);
        visualEl.style.display = 'flex';
    } else {
        visualEl.style.display = 'none';
    }
    
    // Answers
    const answersEl = document.getElementById('testAnswers');
    answersEl.innerHTML = question.answers.map((answer, idx) => `
        <button class="test-answer-btn" onclick="answerQuestion(${idx})">${answer}</button>
    `).join('');
}

// Render visual element for question
function renderVisual(type) {
    if (type === 'triangle') {
        return `<svg width="150" height="130" viewBox="0 0 150 130">
            <line x1="10" y1="120" x2="140" y2="120" stroke="var(--text-primary)" stroke-width="2"/>
            <line x1="10" y1="120" x2="75" y2="10" stroke="var(--text-primary)" stroke-width="2"/>
            <line x1="140" y1="120" x2="75" y2="10" stroke="var(--text-primary)" stroke-width="2"/>
            <line x1="42" y1="65" x2="108" y2="65" stroke="var(--text-primary)" stroke-width="2"/>
        </svg>`;
    }
    return '';
}

// Answer a question
function answerQuestion(answerIndex) {
    testAnswers.push(answerIndex);
    currentQuestionIndex++;
    
    // Save progress
    saveTestProgress();
    
    // Next question or finish
    if (currentQuestionIndex >= currentTest.questions.length) {
        finishTest();
    } else {
        renderQuestion();
    }
}

// Save test progress
function saveTestProgress() {
    if (!currentTest) return;
    
    const testsData = loadTestsData();
    testsData.progress[currentTest.id] = {
        questionIndex: currentQuestionIndex,
        answers: testAnswers,
        startTime: testStartTime
    };
    saveTestsData(testsData);
}

// Finish test and calculate result
function finishTest() {
    if (!currentTest) return;
    
    const endTime = Date.now();
    const timeSpent = Math.round((endTime - testStartTime) / 1000);
    
    // Calculate score
    let correctCount = 0;
    testAnswers.forEach((answer, idx) => {
        if (idx < currentTest.questions.length && answer === currentTest.questions[idx].correct) {
            correctCount++;
        }
    });
    
    let score, resultDesc, icon;
    
    if (currentTest.id === 'iq') {
        // IQ calculation (simplified)
        const percentage = correctCount / currentTest.questions.length;
        score = Math.round(70 + percentage * 60); // IQ range ~70-130
        if (score >= 120) { icon = '🏆'; resultDesc = 'Превосходный результат! Ваши логические способности на высшем уровне.'; }
        else if (score >= 110) { icon = '🌟'; resultDesc = 'Отличный результат! Вы обладаете хорошим логическим мышлением.'; }
        else if (score >= 100) { icon = '👍'; resultDesc = 'Хороший результат! Средний уровень интеллекта.'; }
        else if (score >= 90) { icon = '📈'; resultDesc = 'Неплохо! Есть потенциал для развития.'; }
        else { icon = '💪'; resultDesc = 'Продолжайте тренировать логическое мышление!'; }
    } else {
        score = correctCount;
        const percentage = correctCount / currentTest.questions.length;
        if (percentage >= 0.9) { icon = '🏆'; resultDesc = 'Превосходно! Почти без ошибок!'; }
        else if (percentage >= 0.7) { icon = '🌟'; resultDesc = 'Отличный результат!'; }
        else if (percentage >= 0.5) { icon = '👍'; resultDesc = 'Неплохо! Больше половины правильных ответов.'; }
        else { icon = '📚'; resultDesc = 'Есть над чем поработать.'; }
    }
    
    // Save result to history
    const testsData = loadTestsData();
    testsData.history.unshift({
        testId: currentTest.id,
        testTitle: currentTest.title,
        testIcon: currentTest.icon,
        score: score,
        date: Date.now(),
        time: timeSpent
    });
    
    // Update best score
    if (testsData.bestScores[currentTest.id] === undefined || 
        (currentTest.id === 'reaction' && score < testsData.bestScores[currentTest.id]) ||
        (currentTest.id !== 'reaction' && score > testsData.bestScores[currentTest.id])) {
        testsData.bestScores[currentTest.id] = score;
    }
    
    // Clear progress
    delete testsData.progress[currentTest.id];
    saveTestsData(testsData);
    
    // Show result screen
    document.getElementById('testQuestionScreen').style.display = 'none';
    document.getElementById('testResultScreen').style.display = 'flex';
    document.getElementById('testResultIcon').textContent = icon;
    document.getElementById('testResultScore').textContent = currentTest.id === 'iq' ? `IQ ${score}` : `${score}/${currentTest.questions.length}`;
    document.getElementById('testResultLabel').textContent = currentTest.title;
    document.getElementById('testResultDesc').textContent = resultDesc;
    document.getElementById('testResultTime').textContent = `⏱ ${formatTime(timeSpent)}`;
}

// Format time for display
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Back to catalog
function backToCatalog() {
    currentTest = null;
    currentQuestionIndex = 0;
    testAnswers = [];
    document.getElementById('testResultScreen').style.display = 'none';
    document.getElementById('testQuestionScreen').style.display = 'none';
    document.getElementById('reactionTestScreen').style.display = 'none';
    document.getElementById('testsCatalog').classList.add('active');
    renderTestsCatalog();
}

// Exit test and go back to scanner
function exitTestToScanner() {
    // Clear any reaction test timers
    if (reactionTimeout) {
        clearTimeout(reactionTimeout);
        reactionTimeout = null;
    }
    
    // Save current test progress if any
    if (currentTest && testAnswers.length > 0) {
        saveTestProgress();
    }
    
    // Reset test state
    currentTest = null;
    currentQuestionIndex = 0;
    testAnswers = [];
    reactionTimes = [];
    reactionRound = 0;
    
    // Hide all test screens
    document.getElementById('testQuestionScreen').style.display = 'none';
    document.getElementById('testResultScreen').style.display = 'none';
    document.getElementById('reactionTestScreen').style.display = 'none';
    document.getElementById('testsCatalog').classList.remove('active');
    document.getElementById('testsResults').classList.remove('active');
    
    // Close tests overlay
    document.getElementById('testsOverlay').classList.remove('active');
}

// ══════════════════════════════════════════════
// REACTION TEST
// ══════════════════════════════════════════════

function startReactionTest() {
    reactionTimes = [];
    reactionRound = 0;
    testStartTime = Date.now();
    document.getElementById('reactionTestScreen').style.display = 'flex';
    startReactionRound();
}

function startReactionRound() {
    reactionRound++;
    reactionState = 'waiting';
    
    const area = document.getElementById('reactionArea');
    const text = document.getElementById('reactionText');
    const result = document.getElementById('reactionResult');
    
    area.className = 'reaction-area waiting';
    text.textContent = 'Ждите зелёного цвета...';
    result.textContent = '';
    document.getElementById('reactionRounds').textContent = `Раунд ${reactionRound} / 5`;
    
    // Random delay 1-4 seconds
    const delay = 1000 + Math.random() * 3000;
    reactionTimeout = setTimeout(() => {
        reactionState = 'ready';
        area.className = 'reaction-area ready';
        text.textContent = 'НАЖМИ!';
        reactionStartTime = Date.now();
    }, delay);
}

function handleReactionClick() {
    const area = document.getElementById('reactionArea');
    const text = document.getElementById('reactionText');
    const result = document.getElementById('reactionResult');
    
    if (reactionState === 'waiting') {
        // Clicked too early
        clearTimeout(reactionTimeout);
        reactionState = 'tooEarly';
        area.className = 'reaction-area result';
        text.textContent = 'Слишком рано!';
        result.textContent = '❌';
        reactionTimes.push(9999); // Penalty
        
        setTimeout(() => {
            if (reactionRound < 5) {
                startReactionRound();
            } else {
                finishReactionTest();
            }
        }, 1500);
    } else if (reactionState === 'ready') {
        // Valid click
        const reactionTime = Date.now() - reactionStartTime;
        reactionTimes.push(reactionTime);
        
        reactionState = 'result';
        area.className = 'reaction-area result';
        text.textContent = 'Время реакции:';
        result.textContent = `${reactionTime} мс`;
        
        setTimeout(() => {
            if (reactionRound < 5) {
                startReactionRound();
            } else {
                finishReactionTest();
            }
        }, 1500);
    }
}

function finishReactionTest() {
    // Filter out penalties and calculate average
    const validTimes = reactionTimes.filter(t => t < 9999);
    const avgTime = validTimes.length > 0 
        ? Math.round(validTimes.reduce((a, b) => a + b, 0) / validTimes.length)
        : 9999;
    
    const endTime = Date.now();
    const timeSpent = Math.round((endTime - testStartTime) / 1000);
    
    let icon, resultDesc;
    if (avgTime < 200) { icon = '⚡'; resultDesc = 'Молниеносная реакция! Вы настоящий профи!'; }
    else if (avgTime < 250) { icon = '🏆'; resultDesc = 'Отличная реакция! Быстрее большинства людей.'; }
    else if (avgTime < 300) { icon = '🌟'; resultDesc = 'Хорошая реакция! Выше среднего.'; }
    else if (avgTime < 400) { icon = '👍'; resultDesc = 'Нормальная реакция. Средний результат.'; }
    else { icon = '🐢'; resultDesc = 'Можно быстрее! Попробуйте ещё раз.'; }
    
    // Save result
    const testsData = loadTestsData();
    testsData.history.unshift({
        testId: 'reaction',
        testTitle: 'Тест на реакцию',
        testIcon: '⚡',
        score: avgTime,
        date: Date.now(),
        time: timeSpent
    });
    
    // Update best score (lower is better for reaction)
    if (testsData.bestScores.reaction === undefined || avgTime < testsData.bestScores.reaction) {
        testsData.bestScores.reaction = avgTime;
    }
    
    saveTestsData(testsData);
    
    // Show result
    document.getElementById('reactionTestScreen').style.display = 'none';
    document.getElementById('testResultScreen').style.display = 'flex';
    document.getElementById('testResultIcon').textContent = icon;
    document.getElementById('testResultScore').textContent = `${avgTime} мс`;
    document.getElementById('testResultLabel').textContent = 'Среднее время реакции';
    document.getElementById('testResultDesc').textContent = resultDesc;
    document.getElementById('testResultTime').textContent = `⏱ ${formatTime(timeSpent)}`;
    
    currentTest = TESTS_DATA.reaction;
}

// ══════════════════════════════════════════════
// TESTS RESULTS/STATISTICS
// ══════════════════════════════════════════════

function renderTestsResults() {
    const testsData = loadTestsData();
    
    // Stats summary
    const summaryEl = document.getElementById('testsStatsSummary');
    const totalTests = testsData.history.length;
    const uniqueTests = new Set(testsData.history.map(h => h.testId)).size;
    const bestCount = Object.keys(testsData.bestScores).length;
    
    summaryEl.innerHTML = `
        <div class="tests-stat-card">
            <div class="tests-stat-value">${totalTests}</div>
            <div class="tests-stat-label">Тестов пройдено</div>
        </div>
        <div class="tests-stat-card">
            <div class="tests-stat-value">${uniqueTests}</div>
            <div class="tests-stat-label">Разных тестов</div>
        </div>
        <div class="tests-stat-card">
            <div class="tests-stat-value">${bestCount}/5</div>
            <div class="tests-stat-label">Рекордов</div>
        </div>
    `;
    
    // History list
    const historyEl = document.getElementById('testsHistoryList');
    
    if (testsData.history.length === 0) {
        historyEl.innerHTML = `
            <div class="tests-empty">
                <div class="tests-empty-icon">📊</div>
                <div class="tests-empty-text">Вы ещё не проходили тесты.<br>Начните с каталога!</div>
            </div>
        `;
        return;
    }
    
    historyEl.innerHTML = testsData.history.slice(0, 50).map(item => {
        const date = new Date(item.date);
        const dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        
        return `
            <div class="tests-history-item">
                <span class="tests-history-icon">${item.testIcon}</span>
                <div class="tests-history-info">
                    <div class="tests-history-name">${item.testTitle}</div>
                    <div class="tests-history-date">${dateStr} в ${timeStr}</div>
                </div>
                <div class="tests-history-score">${formatTestScore(item.testId, item.score)}</div>
                <div class="tests-history-time">⏱ ${formatTime(item.time)}</div>
            </div>
        `;
    }).join('');
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('IMPREZA Web Scanner loaded');

    // Init theme icons
    updateThemeIcons(getTheme());

    // Init audio context on first user interaction (required by browsers)
    const initOnce = () => {
        initAudio();
        document.removeEventListener('touchstart', initOnce);
        document.removeEventListener('click', initOnce);
    };
    document.addEventListener('touchstart', initOnce, { once: true });
    document.addEventListener('click', initOnce, { once: true });

    // Try to restore previous session
    await tryRestoreSession();
    
    // Show body after session check (prevents login screen flash)
    document.body.classList.add('ready');
});
</script>

<!-- Бургер-меню оверлей -->
<div class="burger-overlay" id="burgerOverlay" onclick="closeBurger()">
    <div class="burger-panel" onclick="event.stopPropagation()">
        <div class="burger-header">
            <span class="burger-title">Меню</span>
            <button class="burger-close" onclick="closeBurger()">✕</button>
        </div>
        <div class="burger-items">
            <button class="burger-item" onclick="toggleThemeFromBurger()">
                <svg class="burger-icon" id="burgerThemeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
                <span id="burgerThemeText">Тёмная тема</span>
            </button>
            
            <div class="burger-separator"></div>
            
            <!-- Тесты -->
            <button class="burger-item" onclick="openTestsSection()">
                <svg class="burger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a9 9 0 0 1 9 9c0 3.18-1.65 5.97-4.14 7.56L12 22l-4.86-3.44A9 9 0 0 1 12 2z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span>🧠 Тесты</span>
            </button>
            
            <!-- Hidden tickets toggle (only for super admin) -->
            <div class="burger-item burger-item-toggle" id="hiddenTicketsItem" style="display: none;">
                <div class="burger-item-left">
                    <svg class="burger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <span>Скрытые билеты</span>
                </div>
                <div class="burger-toggle" id="hiddenTicketsToggle" onclick="event.stopPropagation(); toggleHiddenTickets()"></div>
            </div>
            
            <!-- Admin filters (только для глобального админа) -->
            <div class="admin-filters" id="adminFilters">
                <div class="admin-filter-group">
                    <span class="admin-filter-label">Страны</span>
                    <div class="admin-multi-select" id="countrySelect"></div>
                </div>
                <div class="admin-filter-group">
                    <span class="admin-filter-label">Города</span>
                    <div class="admin-multi-select" id="citySelect"></div>
                </div>
                <button class="admin-apply-btn" onclick="applyAdminFilters()">Применить фильтр</button>
            </div>
            
            <div class="burger-separator"></div>
            <button class="burger-item burger-item-logout" onclick="doLogout()">
                <svg class="burger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span>Выход</span>
            </button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════
     TESTS SECTION OVERLAY
     ═══════════════════════════════════════════════════ -->
<div class="tests-overlay" id="testsOverlay">
    <!-- Tests Header -->
    <div class="tests-header">
        <button class="tests-back-btn" onclick="closeTestsSection()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            К сканеру
        </button>
        <div class="tests-header-tabs">
            <button class="tests-tab-btn active" data-tab="catalog" onclick="switchTestsTab('catalog')">Каталог</button>
            <button class="tests-tab-btn" data-tab="results" onclick="switchTestsTab('results')">Мои результаты</button>
        </div>
    </div>

    <!-- Catalog Tab -->
    <div class="tests-tab-content active" id="testsCatalog">
        <div class="tests-catalog-grid" id="testsCatalogGrid">
            <!-- Test cards will be rendered here -->
        </div>
    </div>

    <!-- Results Tab -->
    <div class="tests-tab-content" id="testsResults">
        <div class="tests-stats-summary" id="testsStatsSummary">
            <!-- Stats summary will be rendered here -->
        </div>
        <div class="tests-history-list" id="testsHistoryList">
            <!-- History items will be rendered here -->
        </div>
    </div>

    <!-- Test Question Screen (hidden by default) -->
    <div class="test-question-screen" id="testQuestionScreen" style="display:none">
        <button class="test-back-btn" onclick="exitTestToScanner()" title="Назад к сканеру">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
            </svg>
            <span>К сканеру</span>
        </button>
        <div class="test-progress">
            <div class="test-progress-bar">
                <div class="test-progress-fill" id="testProgressFill"></div>
            </div>
            <span class="test-progress-text" id="testProgressText">1 / 30</span>
        </div>
        <div class="test-question-card" id="testQuestionCard">
            <div class="test-question-text" id="testQuestionText"></div>
            <div class="test-question-visual" id="testQuestionVisual"></div>
            <div class="test-answers" id="testAnswers"></div>
        </div>
    </div>

    <!-- Test Result Screen (hidden by default) -->
    <div class="test-result-screen" id="testResultScreen" style="display:none">
        <div class="test-result-card">
            <div class="test-result-icon" id="testResultIcon">🏆</div>
            <div class="test-result-score" id="testResultScore">127</div>
            <div class="test-result-label" id="testResultLabel">Ваш результат</div>
            <div class="test-result-desc" id="testResultDesc">Отличный результат!</div>
            <div class="test-result-time" id="testResultTime">⏱ 12:34</div>
            <button class="test-result-btn" onclick="backToCatalog()">Вернуться к тестам</button>
        </div>
    </div>

    <!-- Reaction Test Screen (special) -->
    <div class="reaction-test-screen" id="reactionTestScreen" style="display:none">
        <button class="test-back-btn reaction-back-btn" onclick="exitTestToScanner()" title="Назад к сканеру">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5"/><path d="m12 19-7-7 7-7"/>
            </svg>
            <span>К сканеру</span>
        </button>
        <div class="reaction-area" id="reactionArea" onclick="handleReactionClick()">
            <div class="reaction-text" id="reactionText">Ждите зелёного цвета...</div>
            <div class="reaction-result" id="reactionResult"></div>
        </div>
        <div class="reaction-rounds" id="reactionRounds">Раунд 1 / 5</div>
    </div>
</div>

</body>
</html>
