<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMPREZA Scanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
/* ═══════════════════════════════════════════════════
   IMPREZA WEB SCANNER — CSS
   Dark premium aesthetic matching desktop scanner
   ═══════════════════════════════════════════════════ */

:root {
    --bg-primary: #09090B;
    --bg-card: #111113;
    --bg-elevated: #18181B;
    --bg-input: #1F1F23;
    --border: #27272A;
    --border-focus: #3F3F46;
    --text-primary: #FAFAFA;
    --text-secondary: #D4D4D8;
    --text-muted: #71717A;
    --text-dim: #52525B;
    --accent-green: #10B981;
    --accent-yellow: #F59E0B;
    --accent-red: #EF4444;
    --accent-blue: #3B82F6;
    --accent-orange: #F97316;
    --font-display: 'DM Sans', sans-serif;
    --font-mono: 'DM Mono', monospace;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --transition: 0.2s ease;
}

[data-theme="light"] {
    --bg-primary: #FFFFFF;
    --bg-card: #F4F4F5;
    --bg-elevated: #E4E4E7;
    --bg-input: #FAFAFA;
    --border: #D4D4D8;
    --border-focus: #A1A1AA;
    --text-primary: #09090B;
    --text-secondary: #3F3F46;
    --text-muted: #71717A;
    --text-dim: #A1A1AA;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: var(--font-display);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
}

/* ── SCREENS ── */
.screen { display: none; min-height: 100dvh; }
.screen.active { display: flex; flex-direction: column; }

/* ═══════════════════════════════════════════
   LOGIN SCREEN
   ═══════════════════════════════════════════ */
#loginScreen {
    justify-content: center;
    align-items: center;
    padding: 24px;
    background: radial-gradient(ellipse at 50% 0%, var(--bg-card) 0%, var(--bg-primary) 70%);
    position: relative;
}

.login-card {
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.login-brand {
    font-family: var(--font-display);
    font-size: clamp(48px, 12vw, 72px);
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--text-primary);
    margin-bottom: 6px;
    line-height: 1;
}

.login-subtitle {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 0.3em;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 48px;
}

.login-field {
    margin-bottom: 16px;
    text-align: left;
}

.login-field label {
    display: block;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-secondary);
    text-transform: uppercase;
    margin-bottom: 8px;
}

.login-field input {
    width: 100%;
    height: 52px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0 18px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 16px;
    outline: none;
    transition: border-color 0.2s;
}

.login-field input:focus { border-color: var(--text-primary); }
.login-field input::placeholder { color: var(--text-muted); }

.login-btn {
    width: 100%;
    height: 56px;
    background: var(--text-primary);
    color: var(--bg-primary);
    border: none;
    border-radius: 10px;
    font-family: var(--font-display);
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.05em;
    cursor: pointer;
    margin-top: 24px;
    transition: opacity 0.15s, transform 0.1s;
}

.login-btn:hover { opacity: 0.9; }
.login-btn:active { transform: scale(0.98); }
.login-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.login-error {
    color: var(--accent-red);
    font-size: 13px;
    font-weight: 500;
    margin-top: 16px;
    min-height: 20px;
}

.login-footer {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 48px;
    letter-spacing: 0.05em;
}

/* ═══════════════════════════════════════════
   MAIN SCANNER SCREEN
   ═══════════════════════════════════════════ */
#mainScreen { height: 100dvh; }

/* ── TOP BAR ── */
.top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 44px;
    padding: 0 8px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg-primary);
    gap: 4px;
}

.top-left { display: flex; align-items: center; gap: 6px; min-width: 0; }

.top-logo {
    font-family: var(--font-display);
    font-size: 15px;
    font-weight: 800;
    letter-spacing: 0.08em;
    color: var(--text-primary);
    flex-shrink: 0;
}

.top-city {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    color: var(--text-primary);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
    cursor: pointer;
    transition: all var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 3px;
}
.top-city:hover { border-color: var(--accent-orange); color: var(--accent-orange); }

.top-right { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }

.connection-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--accent-green);
    transition: background 0.3s;
    flex-shrink: 0;
}
.connection-dot.offline { background: var(--accent-red); }

.top-time {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
    display: none; /* hidden on mobile to save space */
}

.top-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 32px; height: 32px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
}
.top-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }

/* ── EVENT FILTER (top bar) ── */
.event-filter-select {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 11px;
    padding: 4px 6px;
    outline: none;
    max-width: 120px;
    cursor: pointer;
}
.event-filter-select option { background: var(--bg-elevated); color: var(--text-primary); }

/* ── TAB BAR ── */
.tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg-primary);
}

.tab-btn {
    flex: 1;
    height: 38px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.05em;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab-btn.active {
    color: var(--text-primary);
    border-bottom-color: var(--text-primary);
}

/* ── TAB CONTENT ── */
.tab-content { display: none; flex: 1; overflow-y: auto; min-height: 0; }
.tab-content.active { display: flex; flex-direction: column; }

/* ═══════════════════════════════════════════
   SCANNER TAB (mobile-first)
   ═══════════════════════════════════════════ */
.scanner-tab { padding: 8px; gap: 8px; }

/* Status Card — compact */
.status-card {
    border-radius: 10px;
    padding: 12px 14px;
    text-align: center;
    border: 2px solid var(--border);
    background: var(--bg-card);
    transition: all 0.3s ease;
    flex-shrink: 0;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px;
}

.status-card.valid { border-color: var(--accent-green); background: #050F0A; }
.status-card.used { border-color: var(--accent-yellow); background: #0F0D05; }
.status-card.invalid { border-color: var(--accent-red); background: #0F0505; }
.status-card.denied { border-color: var(--accent-red); background: #0F0505; }

.status-icon {
    font-size: 28px;
    line-height: 1;
    flex-shrink: 0;
}

.status-info { flex: 1; min-width: 0; text-align: left; }

.status-text {
    font-size: clamp(14px, 4vw, 20px);
    font-weight: 800;
    letter-spacing: 0.03em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.status-subtitle {
    font-size: 11px;
    font-weight: 400;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Camera Container — fixed height, stable layout */
.camera-section {
    flex-shrink: 0;
}

.camera-container {
    position: relative;
    width: 100%;
    height: 52vw;
    max-height: 380px;
    min-height: 200px;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid var(--border);
    background: #000;
}

/* Video element fills container */
#scannerVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* Scan region overlay — purely visual */
.scan-region-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 2;
}
.scan-region-box {
    width: 65%;
    aspect-ratio: 1;
    max-width: 260px;
    border: 2px solid rgba(255,255,255,0.25);
    border-radius: 16px;
    position: relative;
    box-shadow: 0 0 0 2000px rgba(0,0,0,0.3);
}
.scan-region-box::before, .scan-region-box::after {
    content: '';
    position: absolute;
    width: 28px; height: 28px;
    border-color: var(--accent-orange);
    border-style: solid;
}
.scan-region-box::before { top: -2px; left: -2px; border-width: 3px 0 0 3px; border-radius: 8px 0 0 0; }
.scan-region-box::after { top: -2px; right: -2px; border-width: 3px 3px 0 0; border-radius: 0 8px 0 0; }
.scan-corner-bl, .scan-corner-br {
    position: absolute;
    width: 28px; height: 28px;
    border-color: var(--accent-orange);
    border-style: solid;
}
.scan-corner-bl { bottom: -2px; left: -2px; border-width: 0 0 3px 3px; border-radius: 0 0 0 8px; }
.scan-corner-br { bottom: -2px; right: -2px; border-width: 0 3px 3px 0; border-radius: 0 0 8px 0; }

/* Scanning animation line */
.scan-line {
    position: absolute;
    left: 10%; right: 10%;
    height: 2px;
    background: var(--accent-orange);
    opacity: 0.8;
    animation: scanLineMove 2s ease-in-out infinite;
}
@keyframes scanLineMove {
    0%, 100% { top: 15%; }
    50% { top: 85%; }
}

/* ── SCAN FLASH OVERLAY ── */
.scan-flash {
    position: fixed;
    inset: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.1s;
}
.scan-flash.flash-green { background: rgba(16, 185, 129, 0.4); opacity: 1; }
.scan-flash.flash-yellow { background: rgba(245, 158, 11, 0.4); opacity: 1; }
.scan-flash.flash-red { background: rgba(239, 68, 68, 0.4); opacity: 1; }

.camera-toggle {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 6px;
    flex-shrink: 0;
}

.cam-btn {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
}
.cam-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
.cam-btn.active { background: var(--accent-orange); border-color: var(--accent-orange); color: #FFF; }

/* Guest Info Card — collapsed by default on mobile */
.guest-info {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0;
    flex-shrink: 0;
    overflow: hidden;
}

.guest-info-header {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
    padding: 10px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.guest-info-header::after { content: '▼'; font-size: 8px; }
.guest-info.open .guest-info-header::after { content: '▲'; }

.guest-info-body {
    display: none;
    padding: 0 12px 10px;
}
.guest-info.open .guest-info-body { display: block; }

.guest-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
}

.guest-field {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 8px;
    min-height: 0;
}

.guest-field.wide { grid-column: 1 / -1; }

.guest-field-label {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.12em;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}

.guest-field-value {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-primary);
    word-break: break-all;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ═══════════════════════════════════════════
   HISTORY TAB
   ═══════════════════════════════════════════ */
.history-tab { padding: 8px; gap: 6px; }

.history-controls {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.history-search {
    flex: 1;
    min-width: 0;
    height: 36px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0 10px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 13px;
    outline: none;
}
.history-search:focus { border-color: var(--border-focus); }
.history-search::placeholder { color: var(--text-muted); }

.history-filter-tabs {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.filter-tab {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
}
.filter-tab:hover { border-color: var(--text-secondary); }
.filter-tab.active { background: var(--text-primary); color: var(--bg-primary); border-color: var(--text-primary); }

.history-stats {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
    padding: 4px 0;
    flex-shrink: 0;
}

.history-list {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.history-item {
    display: grid;
    grid-template-columns: 24px 32px 1fr auto auto;
    align-items: center;
    gap: 8px;
    padding: 10px 8px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
}
.history-item:hover { background: var(--bg-elevated); }
.history-item:active { background: var(--bg-input); }
.history-item.selected { background: rgba(0, 122, 255, 0.08); }

.hi-status {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    flex-shrink: 0;
}
.hi-status.entered { background: #0A2A1A; color: var(--accent-green); border: 1px solid var(--accent-green); }
.hi-status.duplicate { background: #2A2510; color: var(--accent-yellow); border: 1px solid var(--accent-yellow); }
.hi-status.pending { background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border); }
.hi-status.invalid { background: #2A0A0A; color: var(--accent-red); border: 1px solid var(--accent-red); }

.hi-info { min-width: 0; }

.hi-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.hi-meta {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
}

.hi-right {
    text-align: right;
    flex-shrink: 0;
}

.hi-scans {
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-yellow);
}

.hi-price {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--accent-green);
    margin-top: 2px;
}

.hi-event {
    font-size: 10px;
    color: var(--accent-blue);
    margin-top: 2px;
}

/* ── BOTTOM STATS BAR ── */
.bottom-bar {
    display: flex;
    align-items: center;
    justify-content: space-around;
    height: 56px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg-primary);
    padding: 0 4px;
}

.stat-item { text-align: center; }

.stat-value {
    font-family: var(--font-display);
    font-size: clamp(20px, 5vw, 28px);
    font-weight: 900;
    line-height: 1.1;
}
.stat-value.green { color: var(--accent-green); }
.stat-value.yellow { color: var(--accent-yellow); }
.stat-value.gray { color: var(--text-secondary); }
.stat-value.red { color: var(--accent-red); }

.stat-label {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
}

/* ── TICKET DETAIL MODAL ── */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    justify-content: center;
    align-items: flex-end;
    padding: 16px;
}
.modal-overlay.active { display: flex; }

.modal-sheet {
    width: 100%;
    max-width: 500px;
    max-height: 80dvh;
    background: var(--bg-card);
    border-radius: 18px 18px 0 0;
    overflow-y: auto;
    padding: 24px;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.modal-handle {
    width: 40px; height: 4px;
    background: var(--text-muted);
    border-radius: 2px;
    margin: 0 auto 20px;
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 16px;
}

.modal-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 20px;
}

.modal-action-btn {
    width: 100%;
    height: 48px;
    border-radius: 10px;
    border: 1px solid;
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
}
.modal-action-btn:hover { opacity: 0.85; }

.btn-green { background: #0A2A1A; border-color: var(--accent-green); color: var(--accent-green); }
.btn-yellow { background: #2A2510; border-color: var(--accent-yellow); color: var(--accent-yellow); }
.btn-red { background: #2A0A0A; border-color: var(--accent-red); color: var(--accent-red); }
.btn-gray { background: var(--bg-elevated); border-color: var(--border); color: var(--text-secondary); }

/* ── PASSWORD PROMPT ── */
.password-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 1100;
    justify-content: center;
    align-items: center;
    padding: 24px;
}
.password-modal.active { display: flex; }

.password-card {
    width: 100%;
    max-width: 340px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    text-align: center;
}

.password-card h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
}

.password-card input {
    width: 100%;
    height: 48px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0 16px;
    color: var(--text-primary);
    font-size: 16px;
    text-align: center;
    outline: none;
    margin-bottom: 16px;
}
.password-card input:focus { border-color: var(--border-focus); }

.password-btns { display: flex; gap: 8px; }

.password-btns button {
    flex: 1;
    height: 44px;
    border-radius: 10px;
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
}

.pw-cancel { background: var(--bg-elevated); color: var(--text-secondary); }
.pw-confirm { background: var(--text-primary); color: var(--bg-primary); border-color: var(--text-primary); }

/* ── HISTORY ITEM +/- BUTTONS ── */
.hi-buttons {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
}

.hi-btn {
    width: 30px; height: 30px;
    border-radius: 8px;
    border: 1px solid;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.15s, transform 0.1s;
    padding: 0;
    line-height: 1;
}
.hi-btn:active { transform: scale(0.9); }
.hi-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.hi-btn:disabled:active { transform: none; }

.hi-btn-minus {
    background: #2A0A0A;
    border-color: var(--accent-red);
    color: var(--accent-red);
}
.hi-btn-plus {
    background: #0A2A1A;
    border-color: var(--accent-green);
    color: var(--accent-green);
}

.hi-checkbox {
    width: 22px; height: 22px;
    accent-color: var(--accent-blue);
    cursor: pointer;
    flex-shrink: 0;
    margin: 0;
}

/* ── MASS ACTION BAR ── */
.mass-action-bar {
    display: none;
    align-items: center;
    gap: 6px;
    padding: 8px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 10px;
    flex-wrap: wrap;
    flex-shrink: 0;
}
.mass-action-bar.active { display: flex; }

.mass-select-all {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-secondary);
    font-family: var(--font-display);
    font-weight: 600;
    white-space: nowrap;
}

.mass-select-all input {
    width: 20px; height: 20px;
    accent-color: var(--accent-blue);
    cursor: pointer;
    margin: 0;
}

.mass-count {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--accent-yellow);
    min-width: 60px;
}

.mass-buttons {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-left: auto;
}

.mass-btn {
    height: 32px;
    padding: 0 10px;
    border-radius: 8px;
    border: 1px solid;
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.15s;
    display: flex;
    align-items: center;
    gap: 4px;
}
.mass-btn:hover { opacity: 0.85; }
.mass-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.mass-btn-reset { background: var(--bg-primary); border-color: var(--text-secondary); color: var(--text-secondary); }
.mass-btn-minus { background: #2A0A0A; border-color: var(--accent-red); color: var(--accent-red); }
.mass-btn-plus { background: #0A2A1A; border-color: var(--accent-green); color: var(--accent-green); }
.mass-btn-hide { background: #1A1A2A; border-color: var(--accent-blue); color: var(--accent-blue); }

/* ── EMPTY STATE ── */
.empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-muted);
}

.empty-state-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state-text { font-size: 14px; }

/* ── LOADING ── */
.spinner {
    width: 24px; height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--text-primary);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin: 20px auto;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── LOGIN SHAKE ── */
@keyframes loginShake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
    20%, 40%, 60%, 80% { transform: translateX(6px); }
}
.login-card.shake { animation: loginShake 0.5s ease-in-out; }

/* ── TOAST NOTIFICATION ── */
.scan-toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 20px;
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 600;
    z-index: 900;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
    max-width: 90vw;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.scan-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}
.scan-toast.toast-valid { border-color: var(--accent-green); color: var(--accent-green); }
.scan-toast.toast-used { border-color: var(--accent-yellow); color: var(--accent-yellow); }
.scan-toast.toast-invalid { border-color: var(--accent-red); color: var(--accent-red); }
.scan-toast.toast-denied { border-color: var(--accent-red); color: var(--accent-red); }

/* ── PHONE SEARCH ON SCANNER TAB ── */
.manual-search {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}
.manual-search input {
    flex: 1;
    height: 34px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0 10px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 13px;
    outline: none;
}
.manual-search input:focus { border-color: var(--border-focus); }
.manual-search input::placeholder { color: var(--text-muted); }
.manual-search button {
    height: 34px;
    padding: 0 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
}

/* ── TOP BAR EXTRAS ── */
.conn-text {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.05em;
    margin-right: 2px;
}
.conn-text.online { color: var(--accent-green); }
.conn-text.offline { color: var(--accent-red); }

.top-btn-fs {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    width: 32px; height: 32px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ── YELLOW BUTTON FOR DUPLICATE ── */
.btn-orange { background: #2A1A0A; border-color: var(--accent-orange); color: var(--accent-orange); }

/* ── THEME TOGGLE ── */
.theme-toggle {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    width: 32px; height: 32px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
    flex-shrink: 0;
    padding: 0;
}
.theme-toggle:hover { border-color: var(--text-secondary); color: var(--text-primary); }
.login-theme-toggle { position: absolute; top: 16px; right: 16px; }

/* ── CITY SWITCHER ── */
.city-switcher-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 60dvh;
    overflow-y: auto;
}
.city-group-label {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
    padding: 12px 0 4px;
    border-bottom: 1px solid var(--border);
}
.city-option {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    text-align: left;
    transition: all var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}
.city-option:hover { border-color: var(--accent-orange); }
.city-option.active { border-color: var(--accent-orange); background: rgba(249, 115, 22, 0.08); }
.city-option-name { flex: 1; }
.city-option-check { color: var(--accent-orange); font-size: 12px; }

/* ── STATUS DOTS ── */
.dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 3px;
    vertical-align: middle;
    flex-shrink: 0;
}
.dot-gray { background: var(--text-secondary); }
.dot-green { background: var(--accent-green); }
.dot-yellow { background: var(--accent-yellow); }
.dot-red { background: var(--accent-red); }

/* ── SVG ICON HELPERS ── */
.btn-icon {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    flex-shrink: 0;
}
.btn-icon svg { display: block; }
.status-icon svg { width: 28px; height: 28px; }
.spinning svg { animation: spin 0.8s linear infinite; }

/* ── UTILITIES ── */
.hidden { display: none !important; }

/* ── RESPONSIVE ── */
@media (min-width: 768px) {
    .scanner-tab {
        max-width: 600px;
        margin: 0 auto;
        width: 100%;
    }
    .history-tab {
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
    }
    .modal-sheet {
        max-height: 70dvh;
        border-radius: 18px;
        align-self: center;
    }
    .top-time { display: inline; }
}
    </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════
     LOGIN SCREEN
     ═══════════════════════════════════════════════════ -->
<div id="loginScreen" class="screen active">
    <button class="theme-toggle login-theme-toggle" onclick="toggleTheme()" aria-label="Переключить тему" id="themeToggleLogin"></button>
    <div class="login-card">
        <div class="login-brand">IMPREZA</div>
        <div class="login-subtitle">система верификации</div>

        <div class="login-field">
            <label>Логин</label>
            <input type="text" id="loginUsername" placeholder="Введите логин" autocomplete="username" autocapitalize="none">
        </div>

        <div class="login-field">
            <label>Пароль</label>
            <input type="password" id="loginPassword" placeholder="Введите пароль" autocomplete="current-password">
        </div>

        <button class="login-btn" id="loginBtn" onclick="doLogin()">ВОЙТИ</button>
        <div class="login-error" id="loginError"></div>
        <div class="login-footer">Powered by Impreza Events</div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════
     MAIN SCANNER SCREEN
     ═══════════════════════════════════════════════════ -->
<div id="mainScreen" class="screen">

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-left">
            <span class="top-logo">IMPREZA</span>
            <span class="top-city" id="topCity" onclick="openCitySwitcher()"></span>
        </div>
        <div class="top-right">
            <select class="event-filter-select" id="eventFilter" onchange="applyEventFilter()">
                <option value="ALL">Все события</option>
            </select>
            <div class="connection-dot" id="connDot"></div>
            <span class="conn-text online" id="connText"></span>
            <span class="top-time" id="topTime"></span>
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Тема" id="themeToggleMain"></button>
            <button class="top-btn" onclick="doLogout()" title="Выход" id="logoutBtn">↪</button>
        </div>
    </div>

    <!-- Tab Bar -->
    <div class="tab-bar">
        <button class="tab-btn active" data-tab="scanner" onclick="switchTab('scanner')">СКАНЕР</button>
        <button class="tab-btn" data-tab="history" onclick="switchTab('history')">ИСТОРИЯ</button>
    </div>

    <!-- SCANNER TAB -->
    <div class="tab-content active scanner-tab" id="tabScanner">

        <!-- Status Card (compact horizontal) -->
        <div class="status-card" id="statusCard">
            <div class="status-icon" id="statusIcon">○</div>
            <div class="status-info">
                <div class="status-text" id="statusText">Ожидание скана</div>
                <div class="status-subtitle" id="statusSubtitle">Наведите камеру на QR-код</div>
            </div>
        </div>

        <!-- Camera -->
        <div class="camera-section">
            <div class="camera-container" id="cameraContainer">
                <video id="scannerVideo" muted playsinline></video>
                <div class="scan-region-overlay" id="scanOverlay" style="display:none">
                    <div class="scan-region-box">
                        <div class="scan-corner-bl"></div>
                        <div class="scan-corner-br"></div>
                        <div class="scan-line"></div>
                    </div>
                </div>
            </div>
            <div class="camera-toggle">
            <button class="cam-btn active" id="btnCamStart" onclick="toggleCamera()">Старт</button>
                <button class="cam-btn" id="btnCamSwitch" onclick="switchCameraFacing()">⟲</button>
            </div>
        </div>

        <!-- Guest Info (collapsible) -->
        <div class="guest-info" id="guestInfoPanel">
            <div class="guest-info-header" onclick="document.getElementById('guestInfoPanel').classList.toggle('open')">Информация о госте</div>
            <div class="guest-info-body">
                <div class="guest-grid">
                    <div class="guest-field"><div class="guest-field-label">Имя</div><div class="guest-field-value" id="gName">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Заказ</div><div class="guest-field-value" id="gOrder">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Телефон</div><div class="guest-field-value" id="gPhone">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Email</div><div class="guest-field-value" id="gEmail">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Билет</div><div class="guest-field-value" id="gTicket">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Цена</div><div class="guest-field-value" id="gPrice">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Событие</div><div class="guest-field-value" id="gEvent">—</div></div>
                    <div class="guest-field"><div class="guest-field-label">Входы</div><div class="guest-field-value" id="gEntries">—</div></div>
                </div>
            </div>
        </div>

        <!-- Manual Phone Search -->
        <div class="manual-search">
            <input type="tel" id="phoneSearchInput" placeholder="Поиск по номеру телефона..." onkeydown="if(event.key==='Enter')searchByPhone()">
            <button onclick="searchByPhone()">Найти</button>
        </div>
    </div>

    <!-- HISTORY TAB -->
    <div class="tab-content history-tab" id="tabHistory">
        <div class="history-controls">
            <input type="search" class="history-search" id="historySearch" placeholder="Поиск по имени, телефону, email..." oninput="filterHistory()">
            <button class="cam-btn" id="refreshBtn" onclick="refreshWithIndicator()" title="Обновить">↻</button>
        </div>

        <div class="history-filter-tabs">
            <button class="filter-tab active" data-filter="all" onclick="setHistoryFilter('all', this)">Все</button>
            <button class="filter-tab" data-filter="pending" onclick="setHistoryFilter('pending', this)"><span class="dot dot-gray"></span> Новые</button>
            <button class="filter-tab" data-filter="entered" onclick="setHistoryFilter('entered', this)"><span class="dot dot-green"></span> Вошли</button>
            <button class="filter-tab" data-filter="duplicate" onclick="setHistoryFilter('duplicate', this)"><span class="dot dot-yellow"></span> Повтор</button>
            <button class="filter-tab" data-filter="invalid" onclick="setHistoryFilter('invalid', this)"><span class="dot dot-red"></span> Отказ</button>
        </div>

        <div class="history-stats" id="historyStats">T:0 P:0 U:0</div>

        <!-- Mass Action Bar -->
        <div class="mass-action-bar" id="massActionBar">
            <label class="mass-select-all">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                <span>Выбрать все</span>
            </label>
            <div class="mass-count" id="massCount">Выбрано: 0</div>
            <div class="mass-buttons">
                <button class="mass-btn mass-btn-reset" onclick="executeMassAction('reset')" title="Сбросить сканы до 0">↩ Сброс</button>
                <button class="mass-btn mass-btn-minus" onclick="executeMassAction('remove_scan')" title="Убрать 1 скан">− Скан</button>
                <button class="mass-btn mass-btn-plus" onclick="executeMassAction('add_scan')" title="Добавить 1 скан">+ Скан</button>
                <button class="mass-btn mass-btn-hide" onclick="executeMassAction('hide')" title="Скрыть билеты">Скрыть</button>
            </div>
        </div>

        <div class="history-list" id="historyList"></div>
    </div>

    <!-- Bottom Stats Bar -->
    <div class="bottom-bar">
        <div class="stat-item"><div class="stat-value green" id="statAdmitted">0</div><div class="stat-label">Вошли</div></div>
        <div class="stat-item"><div class="stat-value yellow" id="statDuplicate">0</div><div class="stat-label">Повтор</div></div>
        <div class="stat-item"><div class="stat-value gray" id="statPending">0</div><div class="stat-label">Новые</div></div>
        <div class="stat-item"><div class="stat-value red" id="statDenied">0</div><div class="stat-label">Отказ</div></div>
    </div>
</div>

<!-- Ticket Detail Modal -->
<div class="modal-overlay" id="ticketModal" onclick="closeModal(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="modal-title" id="modalTitle">Детали билета</div>
        <div class="guest-grid" id="modalGrid"></div>
        <div class="modal-actions" id="modalActions"></div>
    </div>
</div>

<!-- Password Prompt Modal -->
<div class="password-modal" id="passwordModal">
    <div class="password-card">
        <h3 id="pwTitle">Пароль менеджера</h3>
        <input type="password" id="pwInput" placeholder="Введите пароль" onkeydown="if(event.key==='Enter')confirmPassword()">
        <div class="password-btns">
            <button class="pw-cancel" onclick="cancelPassword()">Отмена</button>
            <button class="pw-confirm" onclick="confirmPassword()">Подтвердить</button>
        </div>
    </div>
</div>

<!-- Scan flash overlay -->
<div class="scan-flash" id="scanFlash"></div>

<!-- Toast notification -->
<div class="scan-toast" id="scanToast"></div>

<!-- City Switcher Modal -->
<div class="modal-overlay" id="citySwitcherModal" onclick="closeCitySwitcher(event)">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="modal-title" id="citySwitcherTitle">Выбор города</div>
        <div class="city-switcher-list" id="citySwitcherList"></div>
    </div>
</div>

<!-- QR Scanner (nimiq/qr-scanner — much better than html5-qrcode) -->
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

<script>
/* ═══════════════════════════════════════════════════════
   IMPREZA WEB SCANNER — JavaScript
   ═══════════════════════════════════════════════════════ */

// ── CONFIG ──
const API_URL = 'https://aura-tickets-api-production.up.railway.app';
// Super Admin passwords (full access to everything, can login to any city)
const SUPER_ADMIN_PASSWORDS = ['LotusCore88Admin', 'ImprezaMaster2025'];

// All passwords that unlock any protected action (+/-, mass, status change)
const ALL_VALID_PASSWORDS = [
    ...SUPER_ADMIN_PASSWORDS,
    'KatyaBG2025!',    // Manager Катя (BG, NL, DE)
    'FedorPL2025!',    // Manager Фёдор (PL)
    'Coffee!8Night'    // Legacy manager
];

function isValidActionPassword(pw) { return ALL_VALID_PASSWORDS.includes(pw); }
function isSuperAdmin(pw) { return SUPER_ADMIN_PASSWORDS.includes(pw); }

// ── STATE ──
let currentClub = null;      // { id, city_name, city_english, country_code, login }
let allTickets = [];
let filteredTickets = [];
let historyFilterMode = 'all';
let selectedEventDate = null;
let qrScanner = null;
let cameraActive = false;
let cameraFacing = 'environment'; // 'environment' = back, 'user' = front
let lastScanTime = 0;
let scanCooldown = 1500;      // 1.5 sec between scans
let passwordCallback = null;
let audioCtx = null;  // Web Audio API context for scan sounds
let selectedTickets = new Set();  // Set of order_ids for mass actions
let allClubs = [];            // All clubs from API (for city switcher)
let currentSessionPassword = ''; // Saved password for city switcher

// ── SVG ICONS (Lucide-style) ──
const ICONS = {
    checkCircle: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>',
    alertCircle: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    xCircle: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>',
    shieldX: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m14.5 9.5-5 5"/><path d="m9.5 9.5 5 5"/></svg>',
    mapPin: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    sun: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>',
    moon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>',
    refreshCw: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>',
    ticket: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>',
    inbox: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>',
    logOut: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
};

// ── THEME ──
function getTheme() { return localStorage.getItem('impreza_theme') || 'dark'; }

function setTheme(theme) {
    if (theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
    } else {
        document.documentElement.removeAttribute('data-theme');
    }
    localStorage.setItem('impreza_theme', theme);
    updateThemeIcons(theme);
}

function toggleTheme() {
    setTheme(getTheme() === 'dark' ? 'light' : 'dark');
}

function updateThemeIcons(theme) {
    const icon = theme === 'dark' ? ICONS.sun : ICONS.moon;
    document.querySelectorAll('.theme-toggle').forEach(btn => { btn.innerHTML = icon; });
}

// Init theme immediately (before DOMContentLoaded)
(function() {
    const t = localStorage.getItem('impreza_theme') || 'dark';
    if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
})();

// ── CITY MAPPING (same as desktop) ──
const CITY_RU_TO_EN = {
    'варшава':'warsaw','краков':'krakow','вроцлав':'wroclaw','гданьск':'gdansk',
    'люблин':'lublin','катовице':'katowice','амстердам':'amsterdam','роттердам':'rotterdam',
    'берлин':'berlin','мюнхен':'munich','франкфурт':'frankfurt','прага':'prague',
    'софия':'sofia','барселона':'barcelona'
};

function normalizeCityForComparison(city) {
    if (!city) return '';
    const lower = city.toLowerCase().replace(/[\s\-]+$/, '');
    return CITY_RU_TO_EN[lower] || lower;
}

// ── RU→EN KEYBOARD FIX ──
const RU_EN_MAP = {'й':'q','ц':'w','у':'e','к':'r','е':'t','н':'y','г':'u','ш':'i','щ':'o','з':'p','х':'[','ъ':']','ф':'a','ы':'s','в':'d','а':'f','п':'g','р':'h','о':'j','л':'k','д':'l','ж':';','э':"'",'я':'z','ч':'x','с':'c','м':'v','и':'b','т':'n','ь':'m','б':',','ю':'.'};
function fixKeyboardLayout(text) {
    return text.split('').map(c => RU_EN_MAP[c] || RU_EN_MAP[c.toLowerCase()]?.toUpperCase() || c).join('');
}

// ══════════════════════════════════════════════
// SHA-256 HASH (for password checking)
// ══════════════════════════════════════════════
async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

// ══════════════════════════════════════════════
// LOGIN
// ══════════════════════════════════════════════
async function doLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const errorEl = document.getElementById('loginError');
    const btn = document.getElementById('loginBtn');

    if (!username || !password) { errorEl.textContent = 'Введите логин и пароль'; return; }

    btn.disabled = true;
    btn.textContent = 'Подключение...';
    errorEl.textContent = '';

    try {
        const passwordHash = await sha256(password);
        const res = await fetch(`${API_URL}/clubs`, { signal: AbortSignal.timeout(15000) });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);

        const data = await res.json();
        const clubs = data.clubs || [];

        // Check master password (Super Admins can login to any city)
        const isMaster = isSuperAdmin(password);

        let foundClub = null;
        for (const club of clubs) {
            if (club.login === username) {
                if (passwordHash === club.password_hash || isMaster) {
                    foundClub = club;
                    break;
                }
            }
        }

        if (!foundClub) {
            errorEl.textContent = 'Неверный логин или пароль';
            // Shake animation
            const card = document.querySelector('.login-card');
            card.classList.add('shake');
            setTimeout(() => card.classList.remove('shake'), 600);
            btn.disabled = false;
            btn.textContent = 'ВОЙТИ';
            return;
        }

        // Save club data
        currentClub = {
            id: foundClub.id,
            city_name: foundClub.city_name,
            city_english: foundClub.city_english || foundClub.city_name,
            country_code: foundClub.country_code,
            login: username,
            is_admin: isMaster || foundClub.role === 'admin'
        };
        currentSessionPassword = password;

        // Save session to localStorage (persist across page reload)
        localStorage.setItem('impreza_session', JSON.stringify({
            club: currentClub,
            password: password,
            timestamp: Date.now()
        }));

        console.log('Logged in:', currentClub);

        // Switch to main screen
        document.getElementById('loginScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        document.getElementById('topCity').innerHTML = `${ICONS.mapPin} ${currentClub.city_name}`;

        // Load data
        await loadTickets();

        // Auto-start camera
        setTimeout(() => startCamera(), 500);

        // Start auto-refresh
        setInterval(loadTickets, 30000);
        setInterval(checkConnection, 10000);
        startClock();

    } catch (err) {
        console.error('Login error:', err);
        if (err.name === 'TimeoutError') errorEl.textContent = 'Таймаут сервера, попробуйте ещё';
        else errorEl.textContent = `Ошибка соединения: ${err.message}`;
    }

    btn.disabled = false;
    btn.textContent = 'ВОЙТИ';
}

// Enter key on password field
document.getElementById('loginPassword')?.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

function doLogout() {
    stopCamera();
    currentClub = null;
    allTickets = [];
    filteredTickets = [];
    selectedTickets.clear();
    currentSessionPassword = '';
    allClubs = [];
    // Clear saved session
    localStorage.removeItem('impreza_session');
    document.getElementById('mainScreen').classList.remove('active');
    document.getElementById('loginScreen').classList.add('active');
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').textContent = '';
}

// ══════════════════════════════════════════════
// QR PARSING (client-side, same as desktop)
// ══════════════════════════════════════════════
function parseQR(qrData) {
    const parts = qrData.split('|');
    if (parts[0] !== 'AURA') return null;

    const version = parts[1] || '1';

    // V2: 15 fields
    if (version === '2' && parts.length >= 15) {
        return {
            order_id: parts[2], ticket_type: parts[3], event_date: parts[4],
            name: parts[5], email: parts[6], phone: parts[7], price: parts[8],
            quantity: parseInt(parts[9]) || 1,
            unique_token: parts[11], city: parts[12], country: parts[13],
            signature: parts[14]
        };
    }
    // V1: 14 fields
    if (parts.length >= 14) {
        return {
            order_id: parts[2], ticket_type: parts[3], event_date: parts[4],
            name: parts[5], email: parts[6], phone: parts[7], price: parts[8],
            quantity: 1,
            unique_token: parts[10], city: parts[11], country: parts[12],
            signature: parts[13]
        };
    }
    // Old: 12 fields
    if (parts.length >= 12) {
        return {
            order_id: parts[2], ticket_type: parts[3], event_date: parts[4],
            name: parts[5], email: parts[6], phone: parts[7], price: parts[8],
            quantity: 1,
            unique_token: parts[10], city: '', country: '',
            signature: parts[11]
        };
    }
    return null;
}

// ══════════════════════════════════════════════
// QR SCANNING VIA CAMERA
// ══════════════════════════════════════════════
async function toggleCamera() {
    if (cameraActive) {
        stopCamera();
    } else {
        await startCamera();
    }
}

async function startCamera() {
    try {
        const videoEl = document.getElementById('scannerVideo');

        // Destroy previous scanner if exists
        if (qrScanner) {
            qrScanner.destroy();
            qrScanner = null;
        }

        // Set worker path for qr-scanner
        QrScanner.WORKER_PATH = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner-worker.min.js';

        // Create new QrScanner instance
        qrScanner = new QrScanner(
            videoEl,
            result => {
                // result can be string or {data: string}
                const text = typeof result === 'string' ? result : result.data;
                onQRCodeScanned(text);
            },
            {
                preferredCamera: cameraFacing === 'environment' ? 'environment' : 'user',
                highlightScanRegion: false,
                highlightCodeOutline: false,
                maxScansPerSecond: 8,
                returnDetailedScanResult: true,
            }
        );

        await qrScanner.start();

        // Enable autofocus if available
        setTimeout(() => {
            try {
                const track = videoEl.srcObject?.getVideoTracks()[0];
                const caps = track?.getCapabilities?.() || {};
                if (caps.focusMode?.includes('continuous')) {
                    track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                }
            } catch (e) { /* ignore */ }
        }, 600);

        cameraActive = true;
        document.getElementById('scanOverlay').style.display = '';
        document.getElementById('btnCamStart').textContent = 'Стоп';
        document.getElementById('btnCamStart').classList.add('active');
        console.log('Камера запущена (qr-scanner)');
    } catch (err) {
        console.error('Ошибка камеры:', err);
        alert('Ошибка камеры: ' + err.message + '\n\nРазрешите доступ к камере.');
    }
}

function stopCamera() {
    if (qrScanner) {
        qrScanner.stop();
        cameraActive = false;
        document.getElementById('scanOverlay').style.display = 'none';
        document.getElementById('btnCamStart').textContent = 'Старт';
        document.getElementById('btnCamStart').classList.remove('active');
    }
}

async function switchCameraFacing() {
    cameraFacing = cameraFacing === 'environment' ? 'user' : 'environment';
    if (qrScanner && cameraActive) {
        try {
            // Try to find a camera with the desired facing mode
            const cameras = await QrScanner.listCameras(true);
            if (cameras.length > 1) {
                // Toggle between first and second camera
                const currentCamera = cameraFacing === 'environment' ? 'environment' : 'user';
                await qrScanner.setCamera(currentCamera);
            }
        } catch (e) {
            // Fallback: restart with new facing
            stopCamera();
            await startCamera();
        }
    }
}

// ══════════════════════════════════════════════
// SOUND & VISUAL FEEDBACK
// ══════════════════════════════════════════════
function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playBeep(freq, duration, type = 'sine', volume = 0.6) {
    try {
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    } catch(e) { console.log('Audio error:', e); }
}

function playScanSound(status) {
    switch(status) {
        case 'valid':
            playBeep(880, 0.15, 'sine', 0.7);
            setTimeout(() => playBeep(1320, 0.25, 'sine', 0.7), 150);
            break;
        case 'used':
            playBeep(440, 0.2, 'square', 0.5);
            setTimeout(() => playBeep(330, 0.3, 'square', 0.5), 200);
            break;
        case 'invalid': case 'denied':
            playBeep(220, 0.15, 'sawtooth', 0.6);
            setTimeout(() => playBeep(180, 0.15, 'sawtooth', 0.6), 150);
            setTimeout(() => playBeep(150, 0.4, 'sawtooth', 0.6), 300);
            break;
    }
}

function flashScreen(status) {
    const flash = document.getElementById('scanFlash');
    flash.className = 'scan-flash';
    const colorMap = { valid: 'flash-green', used: 'flash-yellow', invalid: 'flash-red', denied: 'flash-red' };
    flash.classList.add(colorMap[status] || 'flash-red');
    setTimeout(() => { flash.className = 'scan-flash'; }, 400);
}

// ── QR SCAN HANDLER ──
function onQRCodeScanned(decodedText) {
    // Cooldown to prevent rapid duplicate scans
    const now = Date.now();
    if (now - lastScanTime < scanCooldown) return;
    lastScanTime = now;

    console.log('Scanned:', decodedText.substring(0, 50) + '...');

    // Vibrate on scan (mobile)
    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

    let qrData = decodedText.trim();

    // Fix Russian keyboard layout
    if (!qrData.startsWith('AURA')) {
        const fixed = fixKeyboardLayout(qrData);
        if (fixed.startsWith('AURA')) {
            console.log('Auto-fixed keyboard layout');
            qrData = fixed;
        }
    }

    // Fire-and-forget
    verifyTicket(qrData).catch(err => console.error('Verify error:', err));
}

// ══════════════════════════════════════════════
// TICKET VERIFICATION
// ══════════════════════════════════════════════
async function verifyTicket(qrData) {
    // 1. Parse QR locally
    const parsed = parseQR(qrData);

    if (!parsed) {
        showStatus('invalid', 'ДОСТУП ЗАПРЕЩЁН', 'Неверный QR-код');
        playScanSound('invalid');
        flashScreen('invalid');
        return;
    }

    // 2. Pre-check: CITY (before calling API to avoid incrementing scan_count)
    if (currentClub?.city_english) {
        const qrCity = normalizeCityForComparison(parsed.city);
        const filterCity = normalizeCityForComparison(currentClub.city_english);
        if (qrCity && filterCity && qrCity !== filterCity) {
            showStatus('denied', 'ДОСТУП ЗАПРЕЩЁН', `Билет для ${parsed.city}, не ${currentClub.city_name}`);
            playScanSound('denied');
            flashScreen('denied');
            updateGuestInfo(parsed);
            logDenied(parsed.order_id, `Wrong city: ${parsed.city} vs ${currentClub.city_name}`);
            return;
        }
    }

    // 3. Pre-check: DATE (if event filter is active)
    if (selectedEventDate) {
        const qrDate = (parsed.event_date || '').trim();
        if (qrDate && qrDate !== selectedEventDate) {
            showStatus('denied', 'ДОСТУП ЗАПРЕЩЁН', `Билет на ${qrDate}, выбрано: ${selectedEventDate}`);
            playScanSound('denied');
            flashScreen('denied');
            updateGuestInfo(parsed);
            logDenied(parsed.order_id, `Wrong date: ${qrDate} vs ${selectedEventDate}`);
            return;
        }
    }

    // 4. Verify via API
    try {
        const res = await fetch(`${API_URL}/api/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qr_data: qrData, scanner_id: 'web_scanner' }),
            signal: AbortSignal.timeout(15000)
        });

        const result = await res.json();
        console.log('API result:', result);

        const apiData = result.data || {};
        const merged = {
            name: apiData.name || parsed.name || '',
            order_id: parsed.order_id,
            phone: apiData.phone || parsed.phone || '',
            email: apiData.email || parsed.email || '',
            ticket_type: apiData.ticket_type || parsed.ticket_type || 'Standard',
            price: apiData.price || parsed.price || '',
            event_date: apiData.event_date || parsed.event_date || '',
            quantity: apiData.quantity || parsed.quantity || 1,
            scan_count: apiData.scan_count || 0,
            city: parsed.city || '',
        };

        let scanStatus;
        if (result.status === 'valid') {
            const remaining = merged.quantity - merged.scan_count;
            const subtitle = merged.quantity > 1
                ? `Вход ${merged.scan_count}/${merged.quantity} — ${merged.name} (осталось: ${remaining})`
                : `Добро пожаловать, ${merged.name}`;
            showStatus('valid', 'ДОСТУП РАЗРЕШЁН', subtitle);
            scanStatus = 'valid';
        } else if (result.status === 'used') {
            showStatus('used', 'УЖЕ ИСПОЛЬЗОВАН', `Первый вход: ${apiData.used_at || ''}`);
            scanStatus = 'used';
        } else {
            showStatus('invalid', 'ДОСТУП ЗАПРЕЩЁН', result.message || 'Неверный билет');
            scanStatus = 'invalid';
        }

        // Sound + flash feedback
        playScanSound(scanStatus);
        flashScreen(scanStatus);

        // Toast notification if on History tab
        const isOnHistory = document.getElementById('tabHistory')?.classList.contains('active');
        if (isOnHistory) {
            const toastMsg = scanStatus === 'valid' ? `${merged.name} — ДОСТУП РАЗРЕШЁН`
                           : scanStatus === 'used' ? `${merged.name} — УЖЕ ИСПОЛЬЗОВАН`
                           : `${merged.name || parsed.order_id} — ОТКАЗ`;
            showScanToast(scanStatus, toastMsg);
        }

        updateGuestInfo(merged);

    } catch (err) {
        console.error('Verify error:', err);
        showStatus('invalid', 'ОШИБКА', 'Ошибка соединения — проверьте интернет');
        playScanSound('invalid');
        flashScreen('invalid');
        updateGuestInfo(parsed);
    }

    // Reload tickets after scan
    setTimeout(loadTickets, 1000);
}

async function logDenied(orderId, reason) {
    try {
        await fetch(`${API_URL}/api/log-denied`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                order_id: orderId,
                reason: reason,
                scanner_id: 'web_scanner',
                club_id: currentClub?.id
            })
        });
    } catch (e) { console.error('Log denied error:', e); }
}

// ══════════════════════════════════════════════
// STATUS DISPLAY
// ══════════════════════════════════════════════
function showStatus(status, text, subtitle) {
    const card = document.getElementById('statusCard');
    const iconEl = document.getElementById('statusIcon');
    const textEl = document.getElementById('statusText');
    const subEl = document.getElementById('statusSubtitle');

    card.className = 'status-card ' + (status === 'denied' ? 'invalid' : status);

    const iconsSvg = { valid: ICONS.checkCircle, used: ICONS.alertCircle, invalid: ICONS.xCircle, denied: ICONS.shieldX };
    iconEl.innerHTML = iconsSvg[status] || '?';

    const colors = { valid: '#10B981', used: '#F59E0B', invalid: '#EF4444', denied: '#EF4444' };
    iconEl.style.color = colors[status] || '#FFF';
    textEl.style.color = colors[status] || '#FFF';

    textEl.textContent = text;
    subEl.textContent = subtitle;
    subEl.style.color = colors[status] ? colors[status] + 'CC' : 'var(--text-secondary)';
}

function updateGuestInfo(data) {
    const set = (id, val) => { document.getElementById(id).textContent = val || '—'; };
    set('gName', data.name);
    set('gOrder', data.order_id ? '#' + data.order_id : '—');
    set('gPhone', data.phone);
    set('gEmail', data.email);
    set('gTicket', data.ticket_type || 'Standard');
    const price = data.price && data.price !== '0' ? `${data.price} EUR` : 'Бесплатно';
    set('gPrice', price);
    const eventName = data.event_date && data.city ? `${data.event_date} - ${data.city}` : data.event_date || '—';
    set('gEvent', eventName);
    // Auto-expand guest info panel when data arrives
    // (don't expand — it causes layout shift that breaks camera)
    // const panel = document.getElementById('guestInfoPanel');
    // if (panel && data.name) panel.classList.add('open');

    const q = parseInt(data.quantity) || 1;
    const sc = parseInt(data.scan_count) || 0;
    let entries;
    if (q > 1) {
        entries = sc > q ? `${sc}/${q} (превышен лимит)` : sc === q ? `${sc}/${q} (все вошли)` : sc > 0 ? `${sc}/${q} (осталось: ${q - sc})` : `0/${q} (ожидание)`;
    } else {
        entries = sc > 1 ? `${sc}/1 (превышен)` : sc === 1 ? `1/1 (использован)` : `0/1 (ожидание)`;
    }
    set('gEntries', entries);
}

// ══════════════════════════════════════════════
// LOAD TICKETS
// ══════════════════════════════════════════════
async function loadTickets() {
    if (!currentClub) return;

    try {
        const params = new URLSearchParams({ limit: '10000' });
        if (currentClub.id) params.set('club_id', currentClub.id);

        const res = await fetch(`${API_URL}/api/tickets/?${params}`, { signal: AbortSignal.timeout(15000) });
        if (!res.ok) return;

        const data = await res.json();
        allTickets = data.tickets || [];

        populateEventFilter();
        applyEventFilter();
        renderHistory();
        updateBottomStats();

        console.log(`Loaded ${allTickets.length} tickets`);
    } catch (err) {
        console.error('Load tickets error:', err);
    }
}

async function refreshWithIndicator() {
    const btn = document.getElementById('refreshBtn');
    btn.innerHTML = ICONS.refreshCw;
    btn.classList.add('spinning');
    btn.disabled = true;
    await loadTickets();
    btn.innerHTML = '↻';
    btn.classList.remove('spinning');
    btn.disabled = false;
}

// ══════════════════════════════════════════════
// EVENT FILTER
// ══════════════════════════════════════════════
function populateEventFilter() {
    const select = document.getElementById('eventFilter');
    const currentVal = select.value;

    const events = new Set();
    allTickets.forEach(t => {
        const name = t.event_name || t.event_title || '';
        if (name.trim()) events.add(name.trim());
    });

    // Sort by date
    const sorted = [...events].sort((a, b) => {
        const da = a.match(/^(\d+)\.(\d+)/);
        const db = b.match(/^(\d+)\.(\d+)/);
        if (da && db) return (parseInt(db[2]) * 100 + parseInt(db[1])) - (parseInt(da[2]) * 100 + parseInt(da[1]));
        return a.localeCompare(b);
    });

    select.innerHTML = '<option value="ALL">Все события</option>';
    sorted.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e;
        opt.textContent = e;
        select.appendChild(opt);
    });

    // Restore selection
    if (currentVal && select.querySelector(`option[value="${CSS.escape(currentVal)}"]`)) {
        select.value = currentVal;
    }
}

function applyEventFilter() {
    const selected = document.getElementById('eventFilter').value;

    if (selected === 'ALL') {
        filteredTickets = [...allTickets];
        selectedEventDate = null;
    } else {
        filteredTickets = allTickets.filter(t => (t.event_name || t.event_title || '').trim() === selected);
        // Extract date from event name: "31.01 - Warsaw" → "31.01"
        const match = selected.match(/^(\d{1,2}\.\d{2})/);
        selectedEventDate = match ? match[1] : null;
    }

    console.log(`Event filter: ${selected}, date: ${selectedEventDate}, tickets: ${filteredTickets.length}`);
    renderHistory();
    updateBottomStats();
}

// ══════════════════════════════════════════════
// HISTORY RENDERING
// ══════════════════════════════════════════════
function getDisplayStatus(ticket) {
    const status = ticket.status || 'valid';
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;

    if (status === 'cancelled') return 'invalid';
    if (sc > q) return 'duplicate';
    if (sc > 0) return 'entered';
    return 'pending';
}

function renderHistory() {
    const list = document.getElementById('historyList');
    const searchText = (document.getElementById('historySearch')?.value || '').toLowerCase();

    let tickets = filteredTickets;

    // Search filter (name, phone, email, order, event, price)
    if (searchText) {
        tickets = tickets.filter(t => {
            const name = (t.customer_name || '').toLowerCase();
            const email = (t.customer_email || '').toLowerCase();
            const phone = (t.customer_phone || '');
            const order = (t.order_id || '').toLowerCase();
            const event = (t.event_name || t.event_title || '').toLowerCase();
            const price = String(t.price || '').toLowerCase();
            const ticketType = (t.ticket_type || '').toLowerCase();
            return name.includes(searchText) || email.includes(searchText) || phone.includes(searchText) || order.includes(searchText) || event.includes(searchText) || price.includes(searchText) || ticketType.includes(searchText);
        });
    }

    // Status filter
    if (historyFilterMode !== 'all') {
        tickets = tickets.filter(t => getDisplayStatus(t) === historyFilterMode);
    }

    // Stats
    const total = filteredTickets.length;
    const people = filteredTickets.reduce((s, t) => s + (t.quantity || 1), 0);
    const used = filteredTickets.filter(t => t.status === 'used').length;
    document.getElementById('historyStats').textContent = `T:${total}  P:${people}  U:${used}  Showing:${tickets.length}`;

    // Render
    if (tickets.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${ICONS.inbox}</div><div class="empty-state-text">Билеты не найдены</div></div>`;
        return;
    }

    const statusConfig = {
        entered:   { icon: '●', cls: 'entered' },
        duplicate: { icon: '!', cls: 'duplicate' },
        pending:   { icon: '○', cls: 'pending' },
        invalid:   { icon: '✕', cls: 'invalid' }
    };

    let html = '';
    tickets.slice(0, 200).forEach(t => {
        const ds = getDisplayStatus(t);
        const cfg = statusConfig[ds] || statusConfig.pending;
        const name = t.customer_name || 'Неизвестно';
        const phone = t.customer_phone || t.phone || '';
        const email = t.customer_email || t.email || '';
        const sc = t.scan_count || 0;
        const q = t.quantity || 1;
        const price = t.price && t.price != 0 ? `${parseFloat(t.price).toFixed(0)}€` : 'БЕСПЛАТНО';
        const event = t.event_name || t.event_title || '';
        const oid = t.order_id || '';
        const isChecked = selectedTickets.has(oid);
        const minusDisabled = sc <= 0 ? 'disabled' : '';
        const plusDisabled = sc >= q ? 'disabled' : '';

        let timeStr = '—';
        if (t.first_scan_at) {
            try {
                const dt = new Date(t.first_scan_at);
                timeStr = dt.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            } catch(e) {}
        }

        html += `
        <div class="history-item ${isChecked ? 'selected' : ''}" onclick='openTicketModal(${JSON.stringify(t).replace(/'/g, "&#39;")})'>
            <input type="checkbox" class="hi-checkbox" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation(); toggleTicketSelect('${escapeHtml(oid)}')" />
            <div class="hi-status ${cfg.cls}">${cfg.icon}</div>
            <div class="hi-info">
                <div class="hi-name">${escapeHtml(name)}</div>
                <div class="hi-meta">${escapeHtml(phone)} · ${timeStr}</div>
            </div>
            <div class="hi-right">
                <div class="hi-scans">[${sc}/${q}]</div>
                <div class="hi-price">${price}</div>
                <div class="hi-event">${escapeHtml(event).substring(0, 20)}</div>
            </div>
            <div class="hi-buttons">
                <button class="hi-btn hi-btn-minus" ${minusDisabled} onclick="event.stopPropagation(); adjustScanSingle('${escapeHtml(oid)}', ${sc - 1}, ${q})" title="−1 скан">−</button>
                <button class="hi-btn hi-btn-plus" ${plusDisabled} onclick="event.stopPropagation(); adjustScanSingle('${escapeHtml(oid)}', ${sc + 1}, ${q})" title="+1 скан">+</button>
            </div>
        </div>`;
    });

    list.innerHTML = html;
    updateMassActionBar();
}

function filterHistory() { renderHistory(); }

function setHistoryFilter(mode, btn) {
    historyFilterMode = mode;
    document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderHistory();
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ══════════════════════════════════════════════
// TICKET SELECTION & MASS ACTIONS
// ══════════════════════════════════════════════
function toggleTicketSelect(orderId) {
    if (selectedTickets.has(orderId)) {
        selectedTickets.delete(orderId);
    } else {
        selectedTickets.add(orderId);
    }
    renderHistory();
}

function toggleSelectAll() {
    const searchText = (document.getElementById('historySearch')?.value || '').toLowerCase();
    let tickets = filteredTickets;
    if (searchText) {
        tickets = tickets.filter(t => {
            const name = (t.customer_name || '').toLowerCase();
            const email = (t.customer_email || '').toLowerCase();
            const phone = (t.customer_phone || '');
            const order = (t.order_id || '').toLowerCase();
            return name.includes(searchText) || email.includes(searchText) || phone.includes(searchText) || order.includes(searchText);
        });
    }
    if (historyFilterMode !== 'all') {
        tickets = tickets.filter(t => getDisplayStatus(t) === historyFilterMode);
    }

    const visibleIds = tickets.slice(0, 200).map(t => t.order_id).filter(Boolean);
    const allSelected = visibleIds.length > 0 && visibleIds.every(id => selectedTickets.has(id));

    if (allSelected) {
        visibleIds.forEach(id => selectedTickets.delete(id));
    } else {
        visibleIds.forEach(id => selectedTickets.add(id));
    }
    renderHistory();
}

function updateMassActionBar() {
    const bar = document.getElementById('massActionBar');
    const count = selectedTickets.size;
    if (count > 0) {
        bar.classList.add('active');
        document.getElementById('massCount').textContent = `Выбрано: ${count}`;
    } else {
        bar.classList.remove('active');
    }
    // Update select-all checkbox state
    const cb = document.getElementById('selectAllCheckbox');
    if (cb) {
        const checkboxes = document.querySelectorAll('.hi-checkbox');
        const checkedCount = document.querySelectorAll('.hi-checkbox:checked').length;
        cb.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
        cb.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }
}

// Single +/- button (password-protected)
function adjustScanSingle(orderId, newScanCount, quantity) {
    if (newScanCount < 0) newScanCount = 0;
    if (newScanCount > quantity) newScanCount = quantity;

    requestPassword('Пароль менеджера', async (password) => {
        if (!isValidActionPassword(password)) {
            alert('Неверный пароль');
            return;
        }

        try {
            const newStatus = newScanCount > 0 ? 'used' : 'valid';
            const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus, scan_count: newScanCount })
            });
            if (res.ok) {
                await loadTickets();
            } else {
                alert('Ошибка обновления');
            }
        } catch (err) {
            alert('Ошибка соединения');
        }
    });
}

// Mass action execution (password-protected)
function executeMassAction(action) {
    if (selectedTickets.size === 0) return;

    const actionLabels = {
        'reset': `Сброс ${selectedTickets.size} билетов`,
        'remove_scan': `−1 скан для ${selectedTickets.size} билетов`,
        'add_scan': `+1 скан для ${selectedTickets.size} билетов`,
        'hide': `Скрыть ${selectedTickets.size} билетов`
    };

    const label = actionLabels[action] || action;

    requestPassword(label, async (password) => {
        if (!isValidActionPassword(password)) {
            alert('Неверный пароль');
            return;
        }

        let success = 0, failed = 0;

        for (const orderId of selectedTickets) {
            const ticket = allTickets.find(t => t.order_id === orderId);
            if (!ticket) { failed++; continue; }

            try {
                if (action === 'hide') {
                    const res = await fetch(`${API_URL}/api/tickets/${orderId}/hide`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (res.ok) success++; else failed++;
                } else {
                    let newSc = ticket.scan_count || 0;
                    let q = ticket.quantity || 1;

                    if (action === 'reset') newSc = 0;
                    else if (action === 'remove_scan') newSc = Math.max(0, newSc - 1);
                    else if (action === 'add_scan') newSc = Math.min(q, newSc + 1);

                    const newStatus = newSc > 0 ? 'used' : 'valid';
                    const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus, scan_count: newSc })
                    });
                    if (res.ok) success++; else failed++;
                }
            } catch (err) {
                failed++;
            }
        }

        selectedTickets.clear();
        await loadTickets();
        alert(`Готово: ${success} обновлено` + (failed > 0 ? `, ${failed} ошибок` : ''));
    });
}

// ══════════════════════════════════════════════
// BOTTOM STATS
// ══════════════════════════════════════════════
function updateBottomStats() {
    let admitted = 0, duplicate = 0, pending = 0, denied = 0;

    filteredTickets.forEach(t => {
        const ds = getDisplayStatus(t);
        if (ds === 'entered') admitted++;
        else if (ds === 'duplicate') duplicate++;
        else if (ds === 'invalid') denied++;
        else pending++;
    });

    document.getElementById('statAdmitted').textContent = admitted;
    document.getElementById('statDuplicate').textContent = duplicate;
    document.getElementById('statPending').textContent = pending;
    document.getElementById('statDenied').textContent = denied;
}

// ══════════════════════════════════════════════
// TICKET MODAL
// ══════════════════════════════════════════════
function openTicketModal(ticket) {
    const modal = document.getElementById('ticketModal');
    document.getElementById('modalTitle').innerHTML = `${ICONS.ticket} #${ticket.order_id || 'N/A'}`;

    const grid = document.getElementById('modalGrid');
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;
    const fields = [
        ['Имя', ticket.customer_name || 'Неизвестно'],
        ['Телефон', ticket.customer_phone || '—'],
        ['Email', ticket.customer_email || '—'],
        ['Тип', ticket.ticket_type || 'Стандарт'],
        ['Цена', ticket.price ? `${ticket.price} EUR` : 'Бесплатно'],
        ['Событие', ticket.event_name || ticket.event_title || '—'],
        ['Входы', `${sc}/${q}`],
        ['Статус', ticket.status || 'valid'],
        ['Промо', ticket.promo_code || '—'],
    ];

    grid.innerHTML = fields.map(([label, val]) =>
        `<div class="guest-field"><div class="guest-field-label">${label}</div><div class="guest-field-value">${escapeHtml(String(val))}</div></div>`
    ).join('');

    // Action buttons (5 like desktop: view, green, yellow/duplicate, red, gray)
    const actions = document.getElementById('modalActions');
    actions.innerHTML = `
        <button class="modal-action-btn btn-green" onclick="changeTicketStatus('${ticket.order_id}', 'used', 1, ${q})">Отметить вошёл (scan=1)</button>
        <button class="modal-action-btn btn-yellow" onclick="changeTicketStatus('${ticket.order_id}', 'used', ${Math.min(sc + 1, q)}, ${q})">+1 Скан (${sc}→${Math.min(sc+1,q)})</button>
        <button class="modal-action-btn btn-gray" onclick="changeTicketStatus('${ticket.order_id}', 'valid', 0, ${q})">Сброс (scan=0)</button>
        <button class="modal-action-btn btn-red" onclick="changeTicketStatus('${ticket.order_id}', 'cancelled', ${sc}, ${q})">Отменить билет</button>
        <button class="modal-action-btn btn-orange" onclick="viewTicketOnScanner(${JSON.stringify(ticket).replace(/'/g, '&#39;')}); closeModal()">На сканер</button>
        <button class="modal-action-btn btn-gray" onclick="closeModal()">Закрыть</button>
    `;

    modal.classList.add('active');
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('ticketModal').classList.remove('active');
}

// ══════════════════════════════════════════════
// CHANGE TICKET STATUS (with password)
// ══════════════════════════════════════════════
function changeTicketStatus(orderId, newStatus, scanCount, quantity) {
    requestPassword('Пароль менеджера', async (password) => {
        if (!isValidActionPassword(password)) {
            alert('Неверный пароль');
            return;
        }

        try {
            const res = await fetch(`${API_URL}/api/tickets/${orderId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus, scan_count: scanCount })
            });

            if (res.ok) {
                closeModal();
                await loadTickets();
                alert('Статус обновлён');
            } else {
                alert('Ошибка обновления статуса');
            }
        } catch (err) {
            alert('Ошибка соединения');
        }
    });
}

// ══════════════════════════════════════════════
// PASSWORD MODAL
// ══════════════════════════════════════════════
function requestPassword(title, callback) {
    document.getElementById('pwTitle').textContent = title;
    document.getElementById('pwInput').value = '';
    document.getElementById('passwordModal').classList.add('active');
    passwordCallback = callback;
    setTimeout(() => document.getElementById('pwInput').focus(), 100);
}

function confirmPassword() {
    const pw = document.getElementById('pwInput').value;
    document.getElementById('passwordModal').classList.remove('active');
    if (passwordCallback) passwordCallback(pw);
    passwordCallback = null;
}

function cancelPassword() {
    document.getElementById('passwordModal').classList.remove('active');
    passwordCallback = null;
}

// ══════════════════════════════════════════════
// TAB SWITCHING
// ══════════════════════════════════════════════
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tab === 'scanner' ? 'tabScanner' : 'tabHistory').classList.add('active');
}

// ══════════════════════════════════════════════
// CLOCK & CONNECTION
// ══════════════════════════════════════════════
function startClock() {
    const update = () => {
        document.getElementById('topTime').textContent = new Date().toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    };
    update();
    setInterval(update, 1000);
}

async function checkConnection() {
    const dot = document.getElementById('connDot');
    const text = document.getElementById('connText');
    try {
        const res = await fetch(`${API_URL}/health`, { signal: AbortSignal.timeout(5000) });
        const isOk = res.ok;
        dot.classList.toggle('offline', !isOk);
        text.textContent = isOk ? 'ONLINE' : 'OFFLINE';
        text.className = 'conn-text ' + (isOk ? 'online' : 'offline');
    } catch {
        dot.classList.add('offline');
        text.textContent = 'OFFLINE';
        text.className = 'conn-text offline';
    }
}

// ══════════════════════════════════════════════
// FULLSCREEN
// ══════════════════════════════════════════════
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen?.() || document.documentElement.webkitRequestFullscreen?.();
    } else {
        document.exitFullscreen?.() || document.webkitExitFullscreen?.();
    }
}

// ══════════════════════════════════════════════
// CITY SWITCHER (Super Admin only)
// ══════════════════════════════════════════════
function openCitySwitcher() {
    requestPassword('Переключение города', async (password) => {
        if (!isSuperAdmin(password)) {
            alert('Только для супер-администратора');
            return;
        }
        currentSessionPassword = password;
        try {
            const res = await fetch(`${API_URL}/clubs`, { signal: AbortSignal.timeout(15000) });
            if (!res.ok) throw new Error('Server error');
            const data = await res.json();
            allClubs = data.clubs || [];
            renderCitySwitcher();
            document.getElementById('citySwitcherModal').classList.add('active');
        } catch (err) {
            alert('Ошибка загрузки клубов: ' + err.message);
        }
    });
}

function renderCitySwitcher() {
    const list = document.getElementById('citySwitcherList');
    const COUNTRY_NAMES = { 'PL':'Poland', 'NL':'Netherlands', 'DE':'Germany', 'BG':'Bulgaria', 'ES':'Spain', 'CZ':'Czech Republic' };
    const groups = {};
    allClubs.forEach(club => {
        const cc = club.country_code || '??';
        if (!groups[cc]) groups[cc] = [];
        groups[cc].push(club);
    });
    let html = '';
    Object.keys(groups).sort().forEach(cc => {
        const countryName = COUNTRY_NAMES[cc] || cc;
        html += `<div class="city-group-label">${countryName}</div>`;
        groups[cc].forEach(club => {
            const isActive = currentClub && currentClub.id === club.id;
            html += `<button class="city-option ${isActive ? 'active' : ''}" onclick="selectCity(${club.id})">
                <span class="city-option-name">${escapeHtml(club.city_name)}</span>
                ${isActive ? '<span class="city-option-check">●</span>' : ''}
            </button>`;
        });
    });
    list.innerHTML = html;
}

async function selectCity(clubId) {
    const club = allClubs.find(c => c.id === clubId);
    if (!club) return;
    currentClub = {
        id: club.id,
        city_name: club.city_name,
        city_english: club.city_english || club.city_name,
        country_code: club.country_code,
        login: club.login,
        is_admin: true
    };
    localStorage.setItem('impreza_session', JSON.stringify({
        club: currentClub,
        password: currentSessionPassword,
        timestamp: Date.now()
    }));
    document.getElementById('topCity').innerHTML = `${ICONS.mapPin} ${currentClub.city_name}`;
    closeCitySwitcher();
    await loadTickets();
}

function closeCitySwitcher(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('citySwitcherModal').classList.remove('active');
}

// ══════════════════════════════════════════════
// PHONE SEARCH (Scanner tab manual input)
// ══════════════════════════════════════════════
function searchByPhone() {
    const input = document.getElementById('phoneSearchInput');
    const query = (input.value || '').replace(/[^\d+]/g, '');
    if (query.length < 4) {
        alert('Введите минимум 4 цифры');
        return;
    }

    // Search through all tickets for matching phone
    const matches = allTickets.filter(t => {
        const phone = (t.customer_phone || '').replace(/[^\d+]/g, '');
        return phone.includes(query);
    });

    if (matches.length === 0) {
        showStatus('invalid', 'НЕ НАЙДЕН', `Нет билета для: ${query}`);
        return;
    }

    // Prioritize unused tickets
    const sorted = [...matches].sort((a, b) => {
        const aSc = a.scan_count || 0;
        const bSc = b.scan_count || 0;
        if (aSc === 0 && bSc > 0) return -1;
        if (bSc === 0 && aSc > 0) return 1;
        return 0;
    });

    const ticket = sorted[0];
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;

    // Show on guest info
    updateGuestInfo({
        name: ticket.customer_name,
        order_id: ticket.order_id,
        phone: ticket.customer_phone,
        email: ticket.customer_email,
        ticket_type: ticket.ticket_type,
        price: ticket.price,
        event_date: ticket.event_name || ticket.event_title || '',
        city: '',
        quantity: q,
        scan_count: sc
    });

    if (sc === 0) {
        showStatus('valid', `НАЙДЕН: ${ticket.customer_name}`, `Телефон: ${ticket.customer_phone} · ${q} билет(ов) · Ещё не вошёл`);
    } else if (sc < q) {
        showStatus('used', 'ЧАСТИЧНО ИСПОЛЬЗОВАН', `${ticket.customer_name} · Входы: ${sc}/${q}`);
    } else {
        showStatus('used', 'УЖЕ ИСПОЛЬЗОВАН', `${ticket.customer_name} · Все ${q} входов использованы`);
    }

    if (matches.length > 1) {
        showStatus(sc === 0 ? 'valid' : 'used',
            document.getElementById('statusText').textContent,
            document.getElementById('statusSubtitle').textContent + ` (${matches.length} tickets found, showing first unused)`
        );
    }

    input.value = '';
}

// ══════════════════════════════════════════════
// VIEW TICKET ON SCANNER (from modal)
// ══════════════════════════════════════════════
function viewTicketOnScanner(ticket) {
    switchTab('scanner');
    updateGuestInfo({
        name: ticket.customer_name,
        order_id: ticket.order_id,
        phone: ticket.customer_phone,
        email: ticket.customer_email,
        ticket_type: ticket.ticket_type,
        price: ticket.price,
        event_date: ticket.event_name || ticket.event_title || '',
        city: '',
        quantity: ticket.quantity || 1,
        scan_count: ticket.scan_count || 0
    });
    const sc = ticket.scan_count || 0;
    const q = ticket.quantity || 1;
    const ds = getDisplayStatus(ticket);
    const statusMap = { entered: 'valid', duplicate: 'used', pending: 'valid', invalid: 'invalid' };
    showStatus(statusMap[ds] || 'valid', ticket.customer_name, `Заказ #${ticket.order_id} · Входы: ${sc}/${q}`);
}

// ══════════════════════════════════════════════
// TOAST NOTIFICATIONS (for scans while on History tab)
// ══════════════════════════════════════════════
function showScanToast(status, message) {
    const toast = document.getElementById('scanToast');
    toast.textContent = message;
    toast.className = 'scan-toast toast-' + status;
    // Force reflow
    void toast.offsetWidth;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ══════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════

// Try to restore session from localStorage
async function tryRestoreSession() {
    try {
        const saved = localStorage.getItem('impreza_session');
        if (!saved) return false;

        const session = JSON.parse(saved);
        // Session expires after 24 hours
        if (Date.now() - session.timestamp > 24 * 60 * 60 * 1000) {
            localStorage.removeItem('impreza_session');
            return false;
        }

        // Validate session is still valid by checking clubs
        const res = await fetch(`${API_URL}/clubs`, { signal: AbortSignal.timeout(10000) });
        if (!res.ok) return false;

        const data = await res.json();
        const clubs = data.clubs || [];
        const club = clubs.find(c => c.id === session.club.id && c.login === session.club.login);

        if (!club) {
            localStorage.removeItem('impreza_session');
            return false;
        }

        // Restore session
        currentClub = session.club;
        console.log('Сессия восстановлена:', currentClub.city_name);

        // Switch to main screen
        document.getElementById('loginScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');
        document.getElementById('topCity').innerHTML = `${ICONS.mapPin} ${currentClub.city_name}`;

        // Load data
        await loadTickets();

        // Auto-start camera
        setTimeout(() => startCamera(), 500);

        // Start auto-refresh
        setInterval(loadTickets, 30000);
        setInterval(checkConnection, 10000);
        startClock();

        return true;
    } catch (e) {
        console.warn('Ошибка восстановления сессии:', e);
        localStorage.removeItem('impreza_session');
        return false;
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('IMPREZA Web Scanner loaded');

    // Init theme icons
    updateThemeIcons(getTheme());

    // Init audio context on first user interaction (required by browsers)
    const initOnce = () => {
        initAudio();
        document.removeEventListener('touchstart', initOnce);
        document.removeEventListener('click', initOnce);
    };
    document.addEventListener('touchstart', initOnce, { once: true });
    document.addEventListener('click', initOnce, { once: true });

    // Try to restore previous session
    await tryRestoreSession();
});
</script>
</body>
</html>
